<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - Step 5: μμ • κΈ°λ¥ λ³µκµ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f1f5f9; padding: 20px; }
        .tab-btn { padding: 10px 20px; font-weight: bold; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { border: 1px solid #ccc; padding: 8px; border-radius: 5px; width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8fafc; color: #64748b; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .progress-bar { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }
        .hidden { display: none; }
    </style>
</head>
<body class="max-w-5xl mx-auto">

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-2xl font-bold text-slate-800">TAPE KEEPER <span class="text-sm font-normal text-slate-500">(μμ • κΈ°λ¥ λ³µκµ¬λ¨)</span></h1>
        <div class="flex space-x-4 bg-white px-4 rounded-lg shadow-sm">
            <button onclick="showTab('orderTab')" id="btn-orderTab" class="tab-btn active">1. λ°μ£Ό κ΄€λ¦¬</button>
            <button onclick="showTab('workTab')" id="btn-workTab" class="tab-btn">2. μ„ΈνΈ λ“±λ΅ & μ‘μ—…</button>
        </div>
    </div>

    <div id="orderTab">
        <div class="card">
            <h2 class="text-lg font-bold mb-4">π“ λ°μ£Ό λ“±λ΅</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div><label class="text-xs text-gray-500">λ‚©κΈ°μΌ</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">λ°μ£Όλ…</label><input type="text" id="inputTitle" placeholder="μ: 7125Y 2000κ°"></div>
                <div><label class="text-xs text-gray-500">λ©ν‘ μλ‰</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500">λΉ„κ³ </label><input type="text" id="inputMemo" placeholder="νΉμ΄μ‚¬ν•­"></div>
            </div>
            <button onclick="addOrder()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">λ°μ£Ό μ¶”κ°€</button>
        </div>

        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">π“‹ λ°μ£Ό ν„ν™© (μμ • κ°€λ¥)</h2>
                <button onclick="resetData()" class="text-xs text-red-500 underline">μ΄κΈ°ν™”</button>
            </div>
            <div class="overflow-x-auto">
                <table>
                    <thead><tr><th style="width:140px;">λ‚ μ§</th><th>λ°μ£Όλ…</th><th style="width:120px;">λ©ν‘μλ‰</th><th style="width:150px;">μ§„ν–‰λ¥ </th><th style="width:60px;">μ‚­μ </th></tr></thead>
                    <tbody id="orderListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="workTab" class="hidden">
        <div class="card border-l-4 border-indigo-500">
            <h2 class="text-lg font-bold mb-4 text-indigo-900">π“¦ μ„ΈνΈ(LOT) κ°λ³„ λ“±λ΅</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div><label class="text-xs text-gray-500">μ ν’λ…</label><input type="text" id="wipName" placeholder="μ: 7125Y"></div>
                <div><label class="text-xs text-gray-500 font-bold text-indigo-600">μ„ΈνΈ μ΄λ¦„ (LOT)</label><input type="text" id="wipLot" placeholder="μ: A-1"></div>
                <div><label class="text-xs text-gray-500">μλ‰ (EA)</label><input type="number" id="wipQty" placeholder="0"></div>
                <button onclick="addWip()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">μ„ΈνΈ μ¶”κ°€</button>
            </div>
            <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                <h3 class="text-sm font-bold text-indigo-800 mb-2">λ€κΈ° μ¤‘μΈ μ„ΈνΈ λ©λ΅</h3>
                <div id="wipList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
        </div>

        <div class="card border-l-4 border-green-500">
            <h2 class="text-lg font-bold mb-4 text-green-900">π€ μ‘μ—… μ‹¤ν–‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div><label class="text-xs text-gray-500 font-bold">1. μ–΄λ–¤ μ„ΈνΈλ¥Ό μ‘μ—…ν–λ‚μ”?</label><select id="workProductSelect" onchange="autoMatchInfo()" class="bg-gray-50 border-2 border-green-200 p-2 rounded w-full"></select></div>
                    <div><label class="text-xs text-gray-500 font-bold">2. λ‡ κ° λ§λ“¤μ—λ‚μ”? (EA)</label><input type="number" id="workAmount" placeholder="0" class="border-2 border-green-200 focus:border-green-500 p-2 rounded w-full"></div>
                </div>
                <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    <div><label class="text-xs text-gray-500 font-bold">ν…μ΄ν”„ μ •λ³΄</label><input type="text" id="workTapeInfo" disabled class="bg-transparent font-mono text-sm w-full font-bold text-blue-600"></div>
                    <div id="predictionBox" class="text-sm text-gray-600 mt-2">μ„ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”.</div>
                </div>
            </div>
            <button onclick="doWork()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">μ‘μ—… μ™„λ£</button>
            <div id="workResultMsg" class="mt-4 p-3 bg-green-50 text-green-800 text-sm font-bold rounded text-center hidden"></div>
        </div>
    </div>

<script>
    let orders = JSON.parse(localStorage.getItem('TK_ORDERS_V5')) || [];
    let wip = JSON.parse(localStorage.getItem('TK_WIP_V5')) || []; 

    const MAPPING = {
        "7125": { tape: "6855", arr: 8, size: "450x237" }, "6855": { tape: "6855", arr: 8, size: "450x237" },
        "6405": { tape: "6405", arr: 2, size: "470x130" }, "6907": { tape: "RR7000", arr: 2, size: "510x295" },
        "6908": { tape: "RR7000", arr: 2, size: "510x295" }, "5869": { tape: "5869", arr: 4, size: "410x315" },
        "6491": { tape: "6491", arr: 4, size: "450x120" }, "4195": { tape: "4195", arr: 4, size: "470x237" },
        "4221": { tape: "4221", arr: 4, size: "195x385" }, "7011": { tape: "7011", arr: 1, size: "550x315" },
        "6934": { tape: "6934", arr: 4, size: "510x195" }, "24001W": { tape: "6406", arr: 2, size: "470x130" },
        "2254D": { tape: "6491", arr: 4, size: "450x120" }
    };

    function saveData() {
        localStorage.setItem('TK_ORDERS_V5', JSON.stringify(orders));
        localStorage.setItem('TK_WIP_V5', JSON.stringify(wip));
        render();
    }
    function showTab(id) {
        document.getElementById('orderTab').classList.add('hidden'); document.getElementById('workTab').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + id).classList.add('active');
    }
    function addOrder() {
        const date = document.getElementById('inputDate').value;
        const title = document.getElementById('inputTitle').value;
        const goal = parseInt(document.getElementById('inputGoal').value);
        const memo = document.getElementById('inputMemo').value;
        if (!date || !title || !goal) return alert("ν•„μ μ •λ³΄ μ…λ ¥ν•μ„Έμ”");
        orders.push({ id: Date.now(), date, title, goal, done: 0, memo });
        saveData();
        document.getElementById('inputTitle').value=''; document.getElementById('inputGoal').value='';
    }
    function deleteOrder(id) { if(confirm('μ‚­μ ?')) { orders = orders.filter(o => o.id !== id); saveData(); } }
    
    // --- [λ³µκµ¬λ κΈ°λ¥] μμ • ν•¨μ ---
    function updateOrder(id, field, value) {
        const o = orders.find(x => x.id === id);
        if (o) {
            o[field] = (field === 'goal') ? parseInt(value) : value;
            saveData();
        }
    }

    function addWip() {
        const name = document.getElementById('wipName').value.trim();
        const lot = document.getElementById('wipLot').value.trim();
        const qty = parseInt(document.getElementById('wipQty').value);
        if (!name || !lot || !qty) return alert("μ •λ³΄ ν™•μΈν•μ„Έμ”");
        wip.push({ id: Date.now(), name, lot, qty });
        saveData();
        document.getElementById('wipQty').value=''; document.getElementById('wipLot').value='';
    }
    function deleteWip(id) { if(confirm('μ„ΈνΈ μ‚­μ ?')) { wip = wip.filter(x => x.id !== id); saveData(); } }

    function getMatchedOrders(name) {
        return orders.filter(o => o.title.includes(name) && o.done < o.goal).sort((a,b)=>new Date(a.date)-new Date(b.date));
    }
    function autoMatchInfo() {
        const sel = document.getElementById('workProductSelect').value;
        const info = document.getElementById('workTapeInfo');
        const box = document.getElementById('predictionBox');
        if(!sel) { info.value=""; box.innerHTML=""; return;}
        
        const set = wip.find(x => x.id == sel);
        if(!set) return;
        
        const key = Object.keys(MAPPING).find(k => set.name.includes(k));
        const m = key ? MAPPING[key] : {tape:"κΈ°νƒ€", arr:1, size:"-"};
        info.value = `${m.tape} / ${m.size} / ${m.arr}λ°°μ—΄`;
        info.dataset.arr = m.arr;

        const targets = getMatchedOrders(set.name);
        if(targets.length > 0) {
            let list = targets.map(t => `<li>${t.date}: ${t.goal-t.done}κ° ν•„μ”</li>`).join('');
            box.innerHTML = `<ul class='list-disc pl-5 text-xs text-blue-700'>${list}</ul>`;
        } else {
            box.innerHTML = "<span class='text-red-500'>λ§¤μΉ­λλ” λ°μ£Ό μ—†μ (μ¬κ³ λ§ μ°¨κ°)</span>";
        }
    }
    function doWork() {
        const sel = document.getElementById('workProductSelect').value;
        const qty = parseInt(document.getElementById('workAmount').value);
        const arr = parseInt(document.getElementById('workTapeInfo').dataset.arr || 1);
        if(!sel || !qty) return alert("μ…λ ¥ ν™•μΈ");
        
        const set = wip.find(x => x.id == sel);
        if(set.qty < qty) return alert("μ¬κ³  λ¶€μ΅±");
        
        set.qty -= qty;
        if(set.qty === 0) wip = wip.filter(x => x.id != sel);

        let remain = qty;
        const targets = getMatchedOrders(set.name);
        targets.forEach(o => {
            if(remain <= 0) return;
            const fill = Math.min(remain, o.goal - o.done);
            o.done += fill;
            remain -= fill;
        });

        const tapeUsed = Math.ceil(qty / arr);
        document.getElementById('workResultMsg').innerText = `μ™„λ£! ν…μ΄ν”„ ${tapeUsed}μ¥ μ†λ¨`;
        document.getElementById('workResultMsg').classList.remove('hidden');
        saveData(); autoMatchInfo();
    }

    function render() {
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '';
        orders.sort((a, b) => new Date(a.date) - new Date(b.date));
        orders.forEach(o => {
            let pct = Math.round((o.done / o.goal) * 100);
            let barColor = pct >= 100 ? 'bg-green-500' : 'bg-blue-500';
            tbody.innerHTML += `
                <tr>
                    <td><input type="date" value="${o.date}" onchange="updateOrder(${o.id}, 'date', this.value)" class="bg-transparent text-sm w-full"></td>
                    <td><div class="font-bold text-gray-800">${o.title}</div><div class="text-xs text-gray-500">${o.memo}</div></td>
                    <td><input type="number" value="${o.goal}" onchange="updateOrder(${o.id}, 'goal', this.value)" class="w-20 text-right border rounded px-1"></td>
                    <td>
                        <div class="flex justify-between text-xs mb-1"><span class="font-bold">${o.done.toLocaleString()}</span><span class="text-blue-600 font-bold">${pct}%</span></div>
                        <div class="progress-bar"><div class="progress-fill ${barColor}" style="width: ${pct>100?100:pct}%"></div></div>
                    </td>
                    <td><button onclick="deleteOrder(${o.id})" class="text-red-400 text-xs">μ‚­μ </button></td>
                </tr>`;
        });

        const wipList = document.getElementById('wipList');
        const prodSel = document.getElementById('workProductSelect');
        const curSel = prodSel.value;
        wipList.innerHTML = ''; prodSel.innerHTML = '<option value="">(μ„ νƒ)</option>';
        wip.sort((a,b)=>a.name.localeCompare(b.name));
        wip.forEach(x => {
            wipList.innerHTML += `<div class="bg-white border p-2 rounded flex justify-between"><div><b>${x.name}</b> <span class="text-indigo-600 text-xs">${x.lot}</span><div class="text-sm">${x.qty}EA</div></div><button onclick="deleteWip(${x.id})" class="text-red-400 text-xs">μ‚­μ </button></div>`;
            prodSel.innerHTML += `<option value="${x.id}">${x.name} [${x.lot}] (${x.qty})</option>`;
        });
        if(wip.find(x=>x.id==curSel)) prodSel.value = curSel;
    }
    function resetData() { if(confirm("μ΄κΈ°ν™”?")) { localStorage.clear(); location.reload(); } }
    document.getElementById('inputDate').valueAsDate = new Date();
    render();
</script>
</body>
</html>
