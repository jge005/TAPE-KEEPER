<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - Step 4: μ„ΈνΈ(LOT) κ΄€λ¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f1f5f9; padding: 20px; }
        .tab-btn { padding: 10px 20px; font-weight: bold; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { border: 1px solid #ccc; padding: 8px; border-radius: 5px; width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8fafc; color: #64748b; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .progress-bar { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }
        .hidden { display: none; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body class="max-w-5xl mx-auto">

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-2xl font-bold text-slate-800">TAPE KEEPER <span class="text-sm font-normal text-slate-500">(μ„ΈνΈ/LOT κ΄€λ¦¬ λ¨λ“)</span></h1>
        <div class="flex space-x-4 bg-white px-4 rounded-lg shadow-sm">
            <button onclick="showTab('orderTab')" id="btn-orderTab" class="tab-btn active">1. λ°μ£Ό κ΄€λ¦¬</button>
            <button onclick="showTab('workTab')" id="btn-workTab" class="tab-btn">2. μ„ΈνΈ λ“±λ΅ & μ‘μ—…</button>
        </div>
    </div>

    <div id="orderTab">
        <div class="card">
            <h2 class="text-lg font-bold mb-4">π“ λ°μ£Ό λ“±λ΅</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div><label class="text-xs text-gray-500">λ‚©κΈ°μΌ</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">λ°μ£Όλ… (μ ν’λ… ν¬ν•¨)</label><input type="text" id="inputTitle" placeholder="μ: 7125Y 2000κ°"></div>
                <div><label class="text-xs text-gray-500">λ©ν‘ μλ‰</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500">λΉ„κ³ </label><input type="text" id="inputMemo" placeholder="νΉμ΄μ‚¬ν•­"></div>
            </div>
            <button onclick="addOrder()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">λ°μ£Ό μ¶”κ°€</button>
        </div>

        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">π“‹ λ°μ£Ό ν„ν™© (λ‚ μ§μ)</h2>
                <button onclick="resetData()" class="text-xs text-red-500 underline">μ΄κΈ°ν™”</button>
            </div>
            <div class="overflow-x-auto">
                <table>
                    <thead><tr><th style="width:130px;">λ‚ μ§</th><th>λ°μ£Όλ…</th><th style="width:100px;">λ©ν‘</th><th style="width:150px;">μ§„ν–‰λ¥ </th><th style="width:60px;">μ‚­μ </th></tr></thead>
                    <tbody id="orderListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="workTab" class="hidden">
        
        <div class="card border-l-4 border-indigo-500">
            <h2 class="text-lg font-bold mb-4 text-indigo-900">π“¦ μ„ΈνΈ(LOT) κ°λ³„ λ“±λ΅</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label class="text-xs text-gray-500">μ ν’λ…</label>
                    <input type="text" id="wipName" placeholder="μ: 7125Y">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold text-indigo-600">μ„ΈνΈ μ΄λ¦„ (LOT)</label>
                    <input type="text" id="wipLot" placeholder="μ: 1μ°¨, A-1, μ¤μ „λ°">
                </div>
                <div>
                    <label class="text-xs text-gray-500">μλ‰ (EA)</label>
                    <input type="number" id="wipQty" placeholder="0">
                </div>
                <button onclick="addWip()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">μ„ΈνΈ μ¶”κ°€</button>
            </div>
            
            <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                <h3 class="text-sm font-bold text-indigo-800 mb-2">λ€κΈ° μ¤‘μΈ μ„ΈνΈ λ©λ΅</h3>
                <div id="wipList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
        </div>

        <div class="card border-l-4 border-green-500">
            <h2 class="text-lg font-bold mb-4 text-green-900">π€ μ‘μ—… μ‹¤ν–‰</h2>
            <p class="text-sm text-gray-600 mb-4">β€» μ‚¬μ©ν•  <b>νΉμ • μ„ΈνΈ</b>λ¥Ό μ„ νƒν•λ©΄, κΈ‰ν• λ°μ£Όλ¶€ν„° μλ™μΌλ΅ μ±„μ›μ§‘λ‹λ‹¤.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 font-bold">1. μ–΄λ–¤ μ„ΈνΈλ¥Ό μ‘μ—…ν–λ‚μ”?</label>
                        <select id="workProductSelect" onchange="autoMatchInfo()" class="bg-gray-50 border-2 border-green-200 p-2 rounded w-full"></select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-bold">2. λ‡ κ° λ§λ“¤μ—λ‚μ”? (EA)</label>
                        <input type="number" id="workAmount" placeholder="μ: 2520" class="border-2 border-green-200 focus:border-green-500 p-2 rounded w-full">
                    </div>
                </div>

                <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    <div>
                        <label class="text-xs text-gray-500 font-bold">ν…μ΄ν”„ μ •λ³΄</label>
                        <input type="text" id="workTapeInfo" disabled class="bg-transparent font-mono text-sm w-full font-bold text-blue-600">
                    </div>
                    <div id="predictionBox" class="text-sm text-gray-600 mt-2">
                        μ„ΈνΈλ¥Ό μ„ νƒν•λ©΄ μ •λ³΄κ°€ λ‚μµλ‹λ‹¤.
                    </div>
                </div>
            </div>

            <button onclick="doWork()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">
                μ‘μ—… μ™„λ£ (ν•΄λ‹Ή μ„ΈνΈ μ°¨κ°)
            </button>
            <div id="workResultMsg" class="mt-4 p-3 bg-green-50 text-green-800 text-sm font-bold rounded text-center hidden"></div>
        </div>
    </div>

<script>
    // --- λ°μ΄ν„° κ΄€λ¦¬ (λ°°μ—΄ κµ¬μ΅°λ΅ λ³€κ²½: κ°™μ€ μ ν’λ…λ„ μ—¬λ¬ κ° μ΅΄μ¬ κ°€λ¥) ---
    let orders = JSON.parse(localStorage.getItem('TK_ORDERS_V4')) || [];
    let wip = JSON.parse(localStorage.getItem('TK_WIP_V4')) || []; 
    // wip μμ‹: [{id: 1, name: "7125Y", lot: "1μ°¨", qty: 2520}, ...]

    // ν…μ΄ν”„ λ§¤ν•‘ κ·μΉ™
    const MAPPING = {
        "7125": { tape: "6855", arr: 8, size: "450x237" },
        "6855": { tape: "6855", arr: 8, size: "450x237" },
        "6405": { tape: "6405", arr: 2, size: "470x130" },
        "6907": { tape: "RR7000", arr: 2, size: "510x295" },
        "6908": { tape: "RR7000", arr: 2, size: "510x295" },
        "5869": { tape: "5869", arr: 4, size: "410x315" },
        "6491": { tape: "6491", arr: 4, size: "450x120" },
        "4195": { tape: "4195", arr: 4, size: "470x237" },
        "4221": { tape: "4221", arr: 4, size: "195x385" },
        "7011": { tape: "7011", arr: 1, size: "550x315" },
        "6934": { tape: "6934", arr: 4, size: "510x195" },
        "24001W": { tape: "6406", arr: 2, size: "470x130" },
        "2254D": { tape: "6491", arr: 4, size: "450x120" }
    };

    function saveData() {
        localStorage.setItem('TK_ORDERS_V4', JSON.stringify(orders));
        localStorage.setItem('TK_WIP_V4', JSON.stringify(wip));
        render();
    }

    function showTab(tabId) {
        document.getElementById('orderTab').classList.add('hidden');
        document.getElementById('workTab').classList.add('hidden');
        document.getElementById(tabId).classList.remove('hidden');
        
        document.getElementById('btn-orderTab').classList.remove('active');
        document.getElementById('btn-workTab').classList.remove('active');
        document.getElementById('btn-' + tabId).classList.add('active');
        document.getElementById('workResultMsg').classList.add('hidden');
    }

    // --- κΈ°λ¥ 1: λ°μ£Ό κ΄€λ¦¬ ---
    function addOrder() {
        const date = document.getElementById('inputDate').value;
        const title = document.getElementById('inputTitle').value;
        const goal = parseInt(document.getElementById('inputGoal').value);
        const memo = document.getElementById('inputMemo').value;

        if (!date || !title || !goal) return alert("ν•„μ μ •λ³΄λ¥Ό μ…λ ¥ν•μ„Έμ”.");
        orders.push({ id: Date.now(), date, title, goal, done: 0, memo });
        document.getElementById('inputTitle').value = '';
        document.getElementById('inputGoal').value = '';
        saveData();
    }

    function deleteOrder(id) {
        if(confirm('μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) {
            orders = orders.filter(o => o.id !== id);
            saveData();
        }
    }

    // --- κΈ°λ¥ 2: μ„ΈνΈ(LOT) λ“±λ΅ ---
    function addWip() {
        const name = document.getElementById('wipName').value.trim();
        const lot = document.getElementById('wipLot').value.trim();
        const qty = parseInt(document.getElementById('wipQty').value);
        
        if (!name || !lot || isNaN(qty)) return alert("μ ν’λ…, μ„ΈνΈμ΄λ¦„, μλ‰μ„ λ¨λ‘ μ…λ ¥ν•μ„Έμ”.");
        
        // μƒλ΅μ΄ μ„ΈνΈ κ°μ²΄ μƒμ„±
        wip.push({
            id: Date.now(),
            name: name,
            lot: lot,
            qty: qty
        });

        // μ…λ ¥μ°½ μ΄κΈ°ν™”
        document.getElementById('wipQty').value = '';
        document.getElementById('wipLot').value = ''; 
        // μ ν’λ…μ€ μ—°μ† μ…λ ¥ νΈν•κ² λ‚¨κ²¨λ‘  (μ„ νƒμ‚¬ν•­)
        
        saveData();
    }

    // μ„ΈνΈ μ‚­μ  (μ‹¤μ λ°©μ§€)
    function deleteWip(id) {
        if(confirm('μ΄ μ„ΈνΈλ¥Ό λ©λ΅μ—μ„ μ‚­μ ν• κΉμ”?')) {
            wip = wip.filter(item => item.id !== id);
            saveData();
        }
    }

    // --- κΈ°λ¥ 3: μ‘μ—… μ‹¤ν–‰ ---
    function getMatchedOrders(prodName) {
        return orders.filter(o => o.title.includes(prodName) && o.done < o.goal)
                     .sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function autoMatchInfo() {
        const selectedId = document.getElementById('workProductSelect').value;
        const info = document.getElementById('workTapeInfo');
        const box = document.getElementById('predictionBox');
        
        if (!selectedId) { 
            info.value = ""; 
            box.innerHTML = "μ„ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”.";
            return; 
        }

        // μ„ νƒλ μ„ΈνΈ μ°ΎκΈ°
        const selectedSet = wip.find(item => item.id == selectedId);
        if(!selectedSet) return;

        // ν…μ΄ν”„ μ •λ³΄
        const key = Object.keys(MAPPING).find(k => selectedSet.name.includes(k));
        if (key) {
            const m = MAPPING[key];
            info.value = `${m.tape} / ${m.size} / ${m.arr}λ°°μ—΄`;
            info.dataset.arr = m.arr;
        } else {
            info.value = "λ§¤μΉ­ μ •λ³΄ μ—†μ (1λ°°μ—΄)";
            info.dataset.arr = 1;
        }

        // λ°μ£Ό λ§¤μΉ­ λ―Έλ¦¬λ³΄κΈ°
        const targets = getMatchedOrders(selectedSet.name);
        if (targets.length > 0) {
            let msg = `<ul class='list-disc pl-5 text-xs text-blue-700 space-y-1'>`;
            targets.forEach(t => {
                const remain = t.goal - t.done;
                msg += `<li><b>${t.date}</b>: <b>${remain}κ°</b> λ” ν•„μ”ν•¨</li>`;
            });
            msg += "</ul>";
            box.innerHTML = `[${selectedSet.name}] μ ν’μ€ μ•„λ λ°μ£Όλ΅ μ±„μ›μ§‘λ‹λ‹¤:<br>${msg}`;
        } else {
            box.innerHTML = `<span class='text-red-500 font-bold'>μ£Όμ!</span> λ§¤μΉ­λλ” λ―Έμ™„λ£ λ°μ£Όκ°€ μ—†μµλ‹λ‹¤.<br>μ¬κ³ λ§ μ°¨κ°λ©λ‹λ‹¤.`;
        }
    }

    function doWork() {
        const selectedId = document.getElementById('workProductSelect').value;
        const workQty = parseInt(document.getElementById('workAmount').value);
        const arr = parseInt(document.getElementById('workTapeInfo').dataset.arr || 1);

        if (!selectedId || !workQty) return alert("μ„ΈνΈμ™€ μλ‰μ„ ν™•μΈν•μ„Έμ”.");

        // μ„ νƒλ μ„ΈνΈ μ°ΎκΈ°
        const selectedSet = wip.find(item => item.id == selectedId);
        if (!selectedSet) return alert("μ„ΈνΈ μ •λ³΄λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤.");
        
        if (selectedSet.qty < workQty) return alert(`[${selectedSet.lot}] μ„ΈνΈμ μ¬κ³ κ°€ λ¶€μ΅±ν•©λ‹λ‹¤. (λ‚¨μ€μ–‘: ${selectedSet.qty})`);

        // 1. ν•΄λ‹Ή μ„ΈνΈ μ¬κ³  μ°¨κ°
        selectedSet.qty -= workQty;
        // μλ‰μ΄ 0μ΄λ©΄ μ‚­μ ν• μ§€ λ§μ§€λ” μ‚¬μ©μ μ„ νƒ? μΌλ‹¨ 0μΌλ΅ μ μ§€ (κΈ°λ΅μ©) λλ” μλ™ μ‚­μ 
        if(selectedSet.qty === 0) {
            wip = wip.filter(item => item.id != selectedId); // μλ™ μ‚­μ 
        }

        // 2. λ°μ£Ό μλ™ μ±„μ°κΈ° (FIFO)
        let remain = workQty;
        let log = [];
        const targets = getMatchedOrders(selectedSet.name);

        targets.forEach(o => {
            if (remain <= 0) return;
            const needed = o.goal - o.done;
            const fill = Math.min(remain, needed);
            
            o.done += fill;
            remain -= fill;
            log.push(`${o.date} λ°μ£Όμ— ${fill}κ°`);
        });

        // 3. κ²°κ³Ό ν‘μ‹
        const tapeUsed = Math.ceil(workQty / arr);
        let msg = `β… <b>[${selectedSet.lot}] μ„ΈνΈ</b>μ—μ„ <b>${workQty}κ°</b> μ‘μ—… μ™„λ£!<br>π“Ό ν…μ΄ν”„ μ•½ <b>${tapeUsed}μ¥</b> μ†λ¨.<br>`;
        
        if (log.length > 0) {
            msg += `<br>π“‚ <b>λ°°λ¶„ κ²°κ³Ό:</b><br>` + log.join('<br>');
        }
        
        const resBox = document.getElementById('workResultMsg');
        resBox.innerHTML = msg;
        resBox.classList.remove('hidden');
        document.getElementById('workAmount').value = '';
        
        saveData();
        autoMatchInfo(); // κ°±μ‹ 
    }

    // --- λ λ”λ§ ---
    function render() {
        // λ°μ£Ό λ©λ΅
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '';
        orders.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        orders.forEach(o => {
            let pct = Math.round((o.done / o.goal) * 100);
            let barColor = pct >= 100 ? 'bg-green-500' : 'bg-blue-500';
            let barWidth = pct > 100 ? 100 : pct;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-sm font-bold text-gray-700">${o.date}</span></td>
                <td><div class="font-bold text-gray-800">${o.title}</div><div class="text-xs text-gray-500">${o.memo}</div></td>
                <td><span class="text-sm">${o.goal.toLocaleString()}</span></td>
                <td>
                    <div class="flex justify-between text-xs mb-1"><span class="font-bold">${o.done.toLocaleString()}</span><span class="text-blue-600 font-bold">${pct}%</span></div>
                    <div class="progress-bar"><div class="progress-fill ${barColor}" style="width: ${barWidth}%"></div></div>
                </td>
                <td><button onclick="deleteOrder(${o.id})" class="text-red-400 hover:text-red-600 text-xs font-bold">μ‚­μ </button></td>
            `;
            tbody.appendChild(tr);
        });

        // WIP λ©λ΅ (μΉ΄λ“ ν•νƒ) & μ„ νƒ λ°•μ¤
        const wipList = document.getElementById('wipList');
        const prodSel = document.getElementById('workProductSelect');
        const currentSel = prodSel.value; // μ„ νƒ μƒνƒ μ μ§€ λ…Έλ ¥
        
        wipList.innerHTML = '';
        prodSel.innerHTML = '<option value="">(μ„ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”)</option>';
        
        if (wip.length === 0) wipList.innerHTML = '<span class="text-sm text-gray-400 p-2">λ“±λ΅λ μ„ΈνΈκ°€ μ—†μµλ‹λ‹¤.</span>';
        
        // μ •λ ¬: μ ν’λ… μ -> μ„ΈνΈλ… μ
        wip.sort((a, b) => a.name.localeCompare(b.name) || a.lot.localeCompare(b.lot));

        wip.forEach(item => {
            // λ©λ΅ μΉ΄λ“
            wipList.innerHTML += `
                <div class="bg-white border border-gray-200 p-3 rounded shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-800">${item.name}</div>
                        <div class="text-xs text-indigo-600 font-bold">μ„ΈνΈ: ${item.lot}</div>
                        <div class="text-sm text-gray-600">${item.qty.toLocaleString()} EA</div>
                    </div>
                    <button onclick="deleteWip(${item.id})" class="text-xs text-red-400 border border-red-200 px-2 py-1 rounded hover:bg-red-50">μ‚­μ </button>
                </div>
            `;
            
            // μ„ νƒ λ°•μ¤ (μ¤‘μ”: idλ¥Ό valueλ΅ μ‚¬μ©)
            prodSel.innerHTML += `<option value="${item.id}">${item.name} [${item.lot}] (μ”μ—¬: ${item.qty})</option>`;
        });
        
        // λ§μ•½ μ΄μ „μ— μ„ νƒν•κ² μ•„μ§ μ ν¨ν•λ©΄ μ μ§€
        if(wip.find(x => x.id == currentSel)) {
            prodSel.value = currentSel;
        }
    }

    function resetData() {
        if(confirm("λ¨λ“  λ°μ΄ν„°λ¥Ό μ΄κΈ°ν™”ν•μ‹κ² μµλ‹κΉ?")) {
            localStorage.clear();
            location.reload();
        }
    }

    document.getElementById('inputDate').valueAsDate = new Date();
    render();
</script>
</body>
</html>
