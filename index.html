<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - Cloud Ver.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f1f5f9; padding: 20px; }
        .tab-btn { padding: 10px 20px; font-weight: bold; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { border: 1px solid #ccc; padding: 8px; border-radius: 5px; width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8fafc; color: #64748b; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .progress-bar { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }
        .hidden { display: none; }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; }
    </style>
</head>
<body class="max-w-5xl mx-auto">

    <div id="loading"><div class="text-xl font-bold text-blue-600">í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...</div></div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-2">
            <h1 class="text-2xl font-bold text-slate-800">TAPE KEEPER</h1>
            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold">â— ì˜¨ë¼ì¸ ì €ì¥ë¨</span>
        </div>
        <div class="flex space-x-4 bg-white px-4 rounded-lg shadow-sm">
            <button id="btn-orderTab" class="tab-btn active">1. ë°œì£¼ ê´€ë¦¬</button>
            <button id="btn-workTab" class="tab-btn">2. ì„¸íŠ¸ ë“±ë¡ & ì‘ì—…</button>
        </div>
    </div>

    <div id="orderTab">
        <div class="card">
            <h2 class="text-lg font-bold mb-4">ğŸ“ ë°œì£¼ ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div><label class="text-xs text-gray-500">ë‚©ê¸°ì¼</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">ë°œì£¼ëª… (ì œí’ˆëª… í¬í•¨)</label><input type="text" id="inputTitle" placeholder="ì˜ˆ: 7125Y 2000ê°œ"></div>
                <div><label class="text-xs text-gray-500">ëª©í‘œ ìˆ˜ëŸ‰</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500">ë¹„ê³ </label><input type="text" id="inputMemo" placeholder="íŠ¹ì´ì‚¬í•­"></div>
            </div>
            <button id="btnAddOrder" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">ë°œì£¼ ì¶”ê°€ (í´ë¼ìš°ë“œ ì €ì¥)</button>
        </div>

        <div class="card">
            <h2 class="text-lg font-bold mb-4">ğŸ“‹ ë°œì£¼ í˜„í™© (ì‹¤ì‹œê°„ ë™ê¸°í™”)</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead><tr><th style="width:140px;">ë‚ ì§œ</th><th>ë°œì£¼ëª…</th><th style="width:120px;">ëª©í‘œìˆ˜ëŸ‰</th><th style="width:150px;">ì§„í–‰ë¥ </th><th style="width:60px;">ì‚­ì œ</th></tr></thead>
                    <tbody id="orderListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="workTab" class="hidden">
        <div class="card border-l-4 border-indigo-500">
            <h2 class="text-lg font-bold mb-4 text-indigo-900">ğŸ“¦ ì„¸íŠ¸(LOT) ê°œë³„ ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div><label class="text-xs text-gray-500">ì œí’ˆëª…</label><input type="text" id="wipName" placeholder="ì˜ˆ: 7125Y"></div>
                <div><label class="text-xs text-gray-500 font-bold text-indigo-600">ì„¸íŠ¸ ì´ë¦„ (LOT)</label><input type="text" id="wipLot" placeholder="ì˜ˆ: A-1"></div>
                <div><label class="text-xs text-gray-500">ìˆ˜ëŸ‰ (EA)</label><input type="number" id="wipQty" placeholder="0"></div>
                <button id="btnAddWip" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">ì„¸íŠ¸ ì¶”ê°€</button>
            </div>
            <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                <h3 class="text-sm font-bold text-indigo-800 mb-2">ëŒ€ê¸° ì¤‘ì¸ ì„¸íŠ¸ ëª©ë¡</h3>
                <div id="wipList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
        </div>

        <div class="card border-l-4 border-green-500">
            <h2 class="text-lg font-bold mb-4 text-green-900">ğŸš€ ì‘ì—… ì‹¤í–‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div><label class="text-xs text-gray-500 font-bold">1. ì–´ë–¤ ì„¸íŠ¸ë¥¼ ì‘ì—…í–ˆë‚˜ìš”?</label><select id="workProductSelect" class="bg-gray-50 border-2 border-green-200 p-2 rounded w-full"></select></div>
                    <div><label class="text-xs text-gray-500 font-bold">2. ëª‡ ê°œ ë§Œë“¤ì—ˆë‚˜ìš”? (EA)</label><input type="number" id="workAmount" placeholder="0" class="border-2 border-green-200 focus:border-green-500 p-2 rounded w-full"></div>
                </div>
                <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    <div><label class="text-xs text-gray-500 font-bold">í…Œì´í”„ ì •ë³´</label><input type="text" id="workTapeInfo" disabled class="bg-transparent font-mono text-sm w-full font-bold text-blue-600"></div>
                    <div id="predictionBox" class="text-sm text-gray-600 mt-2">ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
                </div>
            </div>
            <button id="btnDoWork" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">ì‘ì—… ì™„ë£Œ</button>
            <div id="workResultMsg" class="mt-4 p-3 bg-green-50 text-green-800 text-sm font-bold rounded text-center hidden"></div>
        </div>
    </div>

<script type="module">
    // -----------------------------------------------------------
    // 1. Firebase ì„¤ì • ë° ì—°ê²°
    // -----------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAkMFlhE-19SvNS6XeHqTAHM3UTHHLb9Ww",
        authDomain: "tapekeeper-8070e.firebaseapp.com",
        projectId: "tapekeeper-8070e",
        storageBucket: "tapekeeper-8070e.firebasestorage.app",
        messagingSenderId: "267507609999",
        appId: "1:267507609999:web:889761a8792b0fa1a6dbfa",
        measurementId: "G-B68XN789S1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // -----------------------------------------------------------
    // 2. ë°ì´í„° ìƒíƒœ ê´€ë¦¬ (ë¡œì»¬ ë³€ìˆ˜)
    // -----------------------------------------------------------
    let orders = [];
    let wip = [];
    const loading = document.getElementById('loading');

    const MAPPING = {
        "7125": { tape: "6855", arr: 8, size: "450x237" }, "6855": { tape: "6855", arr: 8, size: "450x237" },
        "6405": { tape: "6405", arr: 2, size: "470x130" }, "6907": { tape: "RR7000", arr: 2, size: "510x295" },
        "6908": { tape: "RR7000", arr: 2, size: "510x295" }, "5869": { tape: "5869", arr: 4, size: "410x315" },
        "6491": { tape: "6491", arr: 4, size: "450x120" }, "4195": { tape: "4195", arr: 4, size: "470x237" },
        "4221": { tape: "4221", arr: 4, size: "195x385" }, "7011": { tape: "7011", arr: 1, size: "550x315" },
        "6934": { tape: "6934", arr: 4, size: "510x195" }, "24001W": { tape: "6406", arr: 2, size: "470x130" },
        "2254D": { tape: "6491", arr: 4, size: "450x120" }
    };

    // -----------------------------------------------------------
    // 3. Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ë°ì´í„° ìë™ ë™ê¸°í™”)
    // -----------------------------------------------------------
    
    // ë°œì£¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (orders ì»¬ë ‰ì…˜)
    const qOrders = query(collection(db, "orders"));
    onSnapshot(qOrders, (snapshot) => {
        orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
        loading.style.display = 'none'; // ë°ì´í„° ë¡œë”© ì™„ë£Œì‹œ ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
    });

    // WIP ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (wip ì»¬ë ‰ì…˜)
    const qWip = query(collection(db, "wip"));
    onSnapshot(qWip, (snapshot) => {
        wip = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
    });

    // -----------------------------------------------------------
    // 4. ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ (Firestore ì‚¬ìš©)
    // -----------------------------------------------------------

    // [ë°œì£¼ ì¶”ê°€]
    window.addOrder = async function() {
        const date = document.getElementById('inputDate').value;
        const title = document.getElementById('inputTitle').value;
        const goal = parseInt(document.getElementById('inputGoal').value);
        const memo = document.getElementById('inputMemo').value;
        if (!date || !title || !goal) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        
        // Firestoreì— ì €ì¥
        await addDoc(collection(db, "orders"), { date, title, goal, memo, done: 0 });
        
        document.getElementById('inputTitle').value = '';
        document.getElementById('inputGoal').value = '';
    }

    // [ë°œì£¼ ì‚­ì œ]
    window.deleteOrder = async function(id) {
        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await deleteDoc(doc(db, "orders", id));
        }
    }

    // [ë°œì£¼ ìˆ˜ì • - ë‚ ì§œ, ìˆ˜ëŸ‰ ë“±]
    window.updateOrder = async function(id, field, value) {
        const val = (field === 'goal') ? parseInt(value) : value;
        await updateDoc(doc(db, "orders", id), { [field]: val });
    }

    // [ì„¸íŠ¸ ì¶”ê°€]
    window.addWip = async function() {
        const name = document.getElementById('wipName').value.trim();
        const lot = document.getElementById('wipLot').value.trim();
        const qty = parseInt(document.getElementById('wipQty').value);
        if (!name || !lot || !qty) return alert("ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”");

        await addDoc(collection(db, "wip"), { name, lot, qty });
        
        document.getElementById('wipQty').value = '';
        document.getElementById('wipLot').value = '';
    }

    // [ì„¸íŠ¸ ì‚­ì œ]
    window.deleteWip = async function(id) {
        if(confirm('ì„¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await deleteDoc(doc(db, "wip", id));
        }
    }

    // [ë§¤ì¹­ ì •ë³´ ë³´ê¸°]
    window.autoMatchInfo = function() {
        const sel = document.getElementById('workProductSelect').value;
        const info = document.getElementById('workTapeInfo');
        const box = document.getElementById('predictionBox');
        if(!sel) { info.value=""; box.innerHTML="ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”"; return;}
        
        const set = wip.find(x => x.id == sel);
        if(!set) return;
        
        const key = Object.keys(MAPPING).find(k => set.name.includes(k));
        const m = key ? MAPPING[key] : {tape:"ê¸°íƒ€", arr:1, size:"-"};
        info.value = `${m.tape} / ${m.size} / ${m.arr}ë°°ì—´`;
        info.dataset.arr = m.arr;

        // ë§¤ì¹­ë˜ëŠ” ë°œì£¼ ì°¾ê¸°
        const targets = orders.filter(o => o.title.includes(set.name) && o.done < o.goal)
                              .sort((a,b)=>new Date(a.date)-new Date(b.date));

        if(targets.length > 0) {
            let list = targets.map(t => `<li>${t.date}: ${t.goal - t.done}ê°œ í•„ìš”</li>`).join('');
            box.innerHTML = `<ul class='list-disc pl-5 text-xs text-blue-700'>${list}</ul>`;
        } else {
            box.innerHTML = "<span class='text-red-500'>ë§¤ì¹­ë˜ëŠ” ë°œì£¼ ì—†ìŒ (ì¬ê³ ë§Œ ì°¨ê°ë©ë‹ˆë‹¤)</span>";
        }
    }

    // [ì‘ì—… ì™„ë£Œ]
    window.doWork = async function() {
        const sel = document.getElementById('workProductSelect').value;
        const qty = parseInt(document.getElementById('workAmount').value);
        const arr = parseInt(document.getElementById('workTapeInfo').dataset.arr || 1);
        
        if(!sel || !qty) return alert("ì…ë ¥ì„ í™•ì¸í•˜ì„¸ìš”");
        
        const set = wip.find(x => x.id == sel);
        if(!set) return alert("ì„¸íŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if(set.qty < qty) return alert("ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        
        // 1. WIP ì¬ê³  ì—…ë°ì´íŠ¸ (Firestore)
        const newQty = set.qty - qty;
        if(newQty === 0) {
            await deleteDoc(doc(db, "wip", sel));
        } else {
            await updateDoc(doc(db, "wip", sel), { qty: newQty });
        }

        // 2. ë°œì£¼ ìë™ ì±„ìš°ê¸° (Firestore)
        let remain = qty;
        const targets = orders.filter(o => o.title.includes(set.name) && o.done < o.goal)
                              .sort((a,b)=>new Date(a.date)-new Date(b.date));
        
        for (const o of targets) {
            if(remain <= 0) break;
            const fill = Math.min(remain, o.goal - o.done);
            // Firestore ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸° ì²˜ë¦¬)
            await updateDoc(doc(db, "orders", o.id), { done: o.done + fill });
            remain -= fill;
        }

        const tapeUsed = Math.ceil(qty / arr);
        const msgBox = document.getElementById('workResultMsg');
        msgBox.innerText = `ì‘ì—… ì™„ë£Œ! í…Œì´í”„ ${tapeUsed}ì¥ ì†Œëª¨.`;
        msgBox.classList.remove('hidden');
        
        document.getElementById('workAmount').value = '';
        // UIëŠ” onSnapshotì— ì˜í•´ ìë™ ê°±ì‹ ë˜ì§€ë§Œ, ì…€ë ‰íŠ¸ë°•ìŠ¤ ìœ ì§€ë¥¼ ìœ„í•´ info ê°±ì‹  í•„ìš”
        setTimeout(() => window.autoMatchInfo(), 500); 
    }

    // -----------------------------------------------------------
    // 5. ë Œë”ë§ (í™”ë©´ ê·¸ë¦¬ê¸°)
    // -----------------------------------------------------------
    function render() {
        // ë°œì£¼ ëª©ë¡
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '';
        const sortedOrders = [...orders].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        sortedOrders.forEach(o => {
            let pct = Math.round((o.done / o.goal) * 100);
            let barColor = pct >= 100 ? 'bg-green-500' : 'bg-blue-500';
            
            tbody.innerHTML += `
                <tr>
                    <td><input type="date" value="${o.date}" onchange="updateOrder('${o.id}', 'date', this.value)" class="bg-transparent text-sm w-full"></td>
                    <td><div class="font-bold text-gray-800">${o.title}</div><div class="text-xs text-gray-500">${o.memo || ''}</div></td>
                    <td><input type="number" value="${o.goal}" onchange="updateOrder('${o.id}', 'goal', this.value)" class="w-20 text-right border rounded px-1"></td>
                    <td>
                        <div class="flex justify-between text-xs mb-1"><span class="font-bold">${o.done.toLocaleString()}</span><span class="text-blue-600 font-bold">${pct}%</span></div>
                        <div class="progress-bar"><div class="progress-fill ${barColor}" style="width: ${pct>100?100:pct}%"></div></div>
                    </td>
                    <td><button onclick="deleteOrder('${o.id}')" class="text-red-400 text-xs font-bold hover:text-red-600">ì‚­ì œ</button></td>
                </tr>`;
        });

        // ì„¸íŠ¸ ëª©ë¡ ë° ì‘ì—… ì„ íƒì°½
        const wipList = document.getElementById('wipList');
        const prodSel = document.getElementById('workProductSelect');
        const curSel = prodSel.value;
        
        wipList.innerHTML = ''; 
        prodSel.innerHTML = '<option value="">(ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”)</option>';
        
        wip.sort((a,b)=>a.name.localeCompare(b.name));
        
        if(wip.length === 0) wipList.innerHTML = '<div class="text-sm text-gray-400 p-2">ë“±ë¡ëœ ì„¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';

        wip.forEach(x => {
            wipList.innerHTML += `
                <div class="bg-white border p-3 rounded shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-800">${x.name}</div>
                        <div class="text-xs text-indigo-600 font-bold">${x.lot}</div>
                        <div class="text-sm">${x.qty.toLocaleString()} EA</div>
                    </div>
                    <button onclick="deleteWip('${x.id}')" class="text-xs text-red-400 border border-red-200 px-2 py-1 rounded hover:bg-red-50">ì‚­ì œ</button>
                </div>`;
            prodSel.innerHTML += `<option value="${x.id}">${x.name} [${x.lot}] (${x.qty})</option>`;
        });
        
        if(wip.find(x=>x.id==curSel)) prodSel.value = curSel;
        else if (curSel) window.autoMatchInfo(); // ì„ íƒëœê²Œ ì‚¬ë¼ì¡Œìœ¼ë©´ ì •ë³´ì°½ ì´ˆê¸°í™”ìš©
    }

    // íƒ­ ì „í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('btn-orderTab').addEventListener('click', () => {
        document.getElementById('orderTab').classList.remove('hidden');
        document.getElementById('workTab').classList.add('hidden');
        document.getElementById('btn-orderTab').classList.add('active');
        document.getElementById('btn-workTab').classList.remove('active');
    });

    document.getElementById('btn-workTab').addEventListener('click', () => {
        document.getElementById('workTab').classList.remove('hidden');
        document.getElementById('orderTab').classList.add('hidden');
        document.getElementById('btn-workTab').classList.add('active');
        document.getElementById('btn-orderTab').classList.remove('active');
    });

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ëª¨ë“ˆ ìŠ¤ì½”í”„ íƒˆì¶œìš©)
    document.getElementById('btnAddOrder').addEventListener('click', window.addOrder);
    document.getElementById('btnAddWip').addEventListener('click', window.addWip);
    document.getElementById('btnDoWork').addEventListener('click', window.doWork);
    document.getElementById('workProductSelect').addEventListener('change', window.autoMatchInfo);
    
    // ì˜¤ëŠ˜ ë‚ ì§œ ì´ˆê¸°í™”
    document.getElementById('inputDate').valueAsDate = new Date();

</script>
</body>
</html>
