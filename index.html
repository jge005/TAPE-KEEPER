<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - LOCAL MASTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: "Pretendard", "Malgun Gothic", sans-serif; background-color: #f8fafc; padding: 15px; }
        .tab-btn { padding: 10px 12px; font-weight: bold; color: #64748b; border-bottom: 3px solid transparent; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .tab-btn.active { color: #2563eb; border-bottom: 3px solid #2563eb; background-color: #eff6ff; border-radius: 5px 5px 0 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        input, select { border: 1px solid #cbd5e1; padding: 8px; border-radius: 6px; width: 100%; font-size: 14px; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; ring: 2px; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        th { background: #f1f5f9; color: #475569; padding: 10px; font-weight: 700; border-bottom: 2px solid #e2e8f0; text-align: center; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; text-align: center; }
        
        .log-input { width: 100%; text-align: center; border: none; background: transparent; font-weight: 600; }
        .log-input:focus { background: #eff6ff; }
        
        .draggable-row { cursor: grab; }
        .draggable-row.dragging { opacity: 0.5; background: #fef9c3; border: 2px dashed #eab308; }
        
        .hidden { display: none; }
        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); display:flex; justify-content:center; align-items:center; z-index:9999; flex-direction: column;}
    </style>
</head>
<body class="max-w-[1200px] mx-auto text-slate-800">

    <div id="loading">
        <div class="text-4xl font-black text-blue-600 mb-2 animate-bounce">TAPE KEEPER</div>
        <div class="text-sm text-gray-500 font-bold">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg"><i class="fas fa-tape text-xl"></i></div>
            <h1 class="text-2xl font-bold tracking-tight text-slate-800">TAPE KEEPER <span class="text-xs font-normal text-gray-400">Ver 3.0 (Phone)</span></h1>
        </div>
        <div class="flex space-x-1 bg-white p-1 rounded-xl shadow-sm overflow-x-auto w-full md:w-auto border border-gray-200">
            <button id="btn-setTab" class="tab-btn active"><i class="fas fa-cog"></i> 0. ê¸°ì¤€ ì •ë³´</button>
            <button id="btn-orderTab" class="tab-btn"><i class="fas fa-file-invoice"></i> 1. ë°œì£¼</button>
            <button id="btn-workTab" class="tab-btn"><i class="fas fa-dolly"></i> 2. ì‘ì—…</button>
            <button id="btn-rawTab" class="tab-btn text-pink-600"><i class="fas fa-scroll"></i> 3. ì›ë‹¨</button>
            <button id="btn-realTab" class="tab-btn text-purple-600"><i class="fas fa-cut"></i> 4. ì‹¤ë¬´/ì¬ê³ </button>
            <button id="btn-logTab" class="tab-btn text-blue-700 bg-blue-50"><i class="fas fa-calendar-check"></i> 5. ì‘ì—…ì¼ì§€</button>
            <button id="btn-packTab" class="tab-btn text-amber-600 bg-amber-50"><i class="fas fa-box-open"></i> 6. í¬ì¥/ì¶œê³ </button>
        </div>
    </div>

    <div id="setTab">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card border-t-4 border-gray-600 lg:col-span-1 h-fit">
                <h2 class="text-lg font-bold mb-4 text-gray-800"><i class="fas fa-plus-circle"></i> ì œí’ˆ(í…Œì´í”„) ë“±ë¡</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">ìœ„ì¹˜ (ê°€ê³µì‹¤)</label>
                        <select id="mapRoom" class="font-bold"><option value="hansung">ğŸŸ¢ í•œì„± (ë³¸ê´€)</option><option value="taeseong">ğŸ”µ íƒœì„± (ë³„ê´€)</option></select>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500">ì œí’ˆëª…</label><input type="text" id="mapKey" placeholder="ì˜ˆ: 6084, ê¹€ì¹˜(ì¢Œ)"></div>
                    <div><label class="text-xs font-bold text-gray-500">ì‚¬ìš© ì›ë‹¨</label><select id="mapRaw" class="mb-2"></select><input type="text" id="mapRawCustom" class="hidden bg-gray-50 border-dashed" placeholder="ì›ë‹¨ ì´ë¦„ ì§ì ‘ ì…ë ¥"></div>
                    <div><label class="text-xs font-bold text-gray-500">ë°°ì—´</label><input type="number" id="mapArr" placeholder="ì˜ˆ: 8" class="text-center font-bold text-lg"></div>
                    <button onclick="addMapping()" class="w-full bg-gray-800 hover:bg-black text-white font-bold py-3 rounded-lg shadow-md transition">ë“±ë¡ / ìˆ˜ì •</button>
                </div>
            </div>
            <div class="card lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">ğŸ“‹ ë“±ë¡ëœ ì œí’ˆ ëª©ë¡</h2>
                    <button onclick="resetData()" class="text-xs bg-red-100 text-red-500 px-3 py-1 rounded">âš  ë°ì´í„° ì´ˆê¸°í™”</button>
                </div>
                <div class="bg-blue-50 text-blue-800 text-sm p-3 rounded mb-4"><i class="fas fa-info-circle"></i> ëª©ë¡ì˜ <b>â‰¡</b> ë¥¼ ì¡ê³  ëŒë©´ <b>ì‘ì—…ì¼ì§€ ìˆœì„œ</b>ê°€ ë°”ë€ë‹ˆë‹¤.</div>
                <div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-100"><th class="w-10">â‰¡</th><th class="w-20">ìœ„ì¹˜</th><th class="text-left">ì œí’ˆëª…</th><th class="text-left">ì‚¬ìš© ì›ë‹¨</th><th class="w-20">ë°°ì—´</th><th class="w-20">ì‚­ì œ</th></tr></thead><tbody id="mapListBody"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="orderTab" class="hidden">
        <div class="card border-t-4 border-blue-500">
            <h2 class="text-lg font-bold mb-4 text-blue-900"><i class="fas fa-pen"></i> ë°œì£¼ ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div><label class="text-xs text-gray-500">ë‚©ê¸°ì¼</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">ë°œì£¼ëª…</label><input type="text" id="inputTitle" placeholder="ì˜ˆ: DA64-06405J 3000ê°œ"></div>
                <div><label class="text-xs text-gray-500 font-bold">ëª©í‘œ(EA)</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500 text-blue-600 font-bold">í¬ì¥ì‹¤ì¬ê³ </label><input type="number" id="inputPacked" placeholder="0" class="border-blue-300 bg-blue-50"></div>
                <button onclick="addOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg h-[38px]">ë“±ë¡</button>
            </div>
        </div>
        <div class="card"><h2 class="text-lg font-bold mb-4">ğŸ“‹ ì§„í–‰ ì¤‘ì¸ ë°œì£¼</h2><div class="overflow-x-auto"><table><thead><tr><th class="w-24">ë‚©ê¸°</th><th>ë°œì£¼ëª…</th><th class="w-20">ëª©í‘œ</th><th class="w-20">ê¸°ì¬ê³ </th><th class="w-20 bg-blue-50">ì‹¤ëª©í‘œ</th><th class="w-32">ì§„í–‰ë¥ </th><th class="w-16">ê´€ë¦¬</th></tr></thead><tbody id="orderListBody"></tbody></table></div></div>
    </div>

    <div id="workTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-yellow-500 bg-yellow-50">
                <h2 class="text-lg font-bold mb-4 text-yellow-900"><i class="fas fa-calculator"></i> ê³„ì‚°ê¸°</h2>
                <div class="flex gap-2 mb-2"><select id="calcProduct" class="flex-1 border-yellow-300"></select><input type="number" id="calcTarget" placeholder="ëª©í‘œ(EA)" class="w-24 text-center border-yellow-300"></div>
                <div id="calcResult" class="text-center font-bold text-yellow-800 text-xl mt-4 bg-white p-3 rounded-lg shadow-sm">- ì¥ ì¤€ë¹„í•˜ì„¸ìš” -</div>
            </div>
            <div class="card border-t-4 border-indigo-500">
                <h2 class="text-lg font-bold mb-4 text-indigo-900"><i class="fas fa-layer-group"></i> í•„ë¦„/ì„¸íŠ¸ ì¤€ë¹„</h2>
                <div class="flex gap-2 mb-2"><input type="text" id="wipName" placeholder="ì œí’ˆëª…" class="flex-1"><input type="number" id="wipQty" placeholder="ìˆ˜ëŸ‰(ì¥)" class="w-24"></div>
                <button onclick="addWip()" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg mb-4">ì¬ê³  ë“±ë¡</button>
                <div id="wipList" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
            <div class="card border-t-4 border-green-500 lg:col-span-2">
                <h2 class="text-lg font-bold mb-4 text-green-900"><i class="fas fa-check-circle"></i> í•©ì§€ ì‘ì—… ì™„ë£Œ ë“±ë¡</h2>
                <div class="flex flex-col md:flex-row gap-4 items-end bg-green-50 p-4 rounded-lg">
                    <div class="flex-1 w-full"><label class="text-xs font-bold text-green-700">ì‘ì—…í•œ ì œí’ˆ</label><select id="workProductSelect" class="border-green-300"></select></div>
                    <div class="w-full md:w-32"><label class="text-xs font-bold text-green-700">ìˆ˜ëŸ‰ (ì¥)</label><input type="number" id="workAmount" placeholder="0" class="border-green-300"></div>
                    <button onclick="doWork()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded-lg shadow-lg h-[40px]">ë“±ë¡!</button>
                </div>
                <div id="workResultMsg" class="mt-2 text-center text-sm font-bold text-green-700 hidden"></div>
            </div>
        </div>
    </div>

    <div id="rawTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-3 border-t-4 border-red-500 bg-red-50"><h2 class="text-lg font-bold mb-2 text-red-900"><i class="fas fa-bell"></i> ìì¬ ë¶€ì¡± ì˜ˆì¸¡</h2><div id="forecastReport" class="text-sm space-y-2"></div></div>
            <div class="card lg:col-span-1 border-t-4 border-pink-500"><h2 class="text-lg font-bold mb-4 text-pink-900">ì›ë‹¨ ì…ê³ </h2><div class="space-y-4"><select id="rawTypeSelect" class="border-pink-300"></select><input type="text" id="rawCustomInput" class="hidden bg-pink-50" placeholder="ì§ì ‘ ì…ë ¥"><input type="number" id="rawQtyInput" placeholder="ìˆ˜ëŸ‰ (ì¥)"><button onclick="addRaw()" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 rounded-lg">ì…ê³  ì²˜ë¦¬</button></div></div>
            <div class="card lg:col-span-2"><h2 class="text-lg font-bold mb-4">ğŸ“Š ì›ë‹¨ ì¬ê³  í˜„í™©</h2><div class="overflow-x-auto"><table><thead><tr><th>ê·œê²©/ìì¬ëª…</th><th>ì¬ê³ (ì¥)</th></tr></thead><tbody id="rawListBody"></tbody></table></div></div>
        </div>
    </div>

    <div id="realTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-1 border-t-4 border-purple-500">
                <h2 class="text-lg font-bold mb-4 text-purple-900">ì‹¤ë¬´(í…Œì´í”„) ì…ê³ </h2>
                <div class="bg-purple-50 p-3 rounded mb-4 text-xs text-purple-700">* ì œí’ˆëª…ì„ ì…ë ¥í•˜ë©´ <b>ì—°ê²°ëœ ì›ë‹¨</b>ì„ ì°¾ì•„ ìë™ ì°¨ê°í•©ë‹ˆë‹¤.<br>* ì—†ìœ¼ë©´ ì•Œë¦¼ì°½ì´ ëœ¹ë‹ˆë‹¤.</div>
                <div class="space-y-4">
                    <div><label class="text-xs text-gray-500">ì œí’ˆëª…</label><input type="text" id="realNameInput" placeholder="ì˜ˆ: ê³µì²­ê¸°, ê³ ë°ê¸°" list="realSuggestions"><datalist id="realSuggestions"></datalist></div>
                    <div><label class="text-xs text-gray-500">ìˆ˜ëŸ‰ (ì¥)</label><input type="number" id="realQtyInput" placeholder="0"></div>
                    <button onclick="addReal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow-md">ì…ê³  ë° ì›ë‹¨ ì°¨ê°</button>
                </div>
            </div>
            <div class="card lg:col-span-2"><h2 class="text-lg font-bold mb-4">ğŸ§º í…Œì´í”„(ê°€ê³µ ì „) ì¬ê³  í˜„í™©</h2><div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="realListBody"></div></div>
        </div>
    </div>

    <div id="logTab" class="hidden">
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm border border-blue-100">
            <div class="flex items-center gap-4"><label class="font-bold text-gray-700 text-lg">ğŸ“… ì¼ì:</label><input type="date" id="logDate" class="border-2 border-blue-300 p-2 rounded-lg font-bold text-blue-800 cursor-pointer text-lg" onchange="loadLogData()"></div>
            <div class="flex gap-2"><button onclick="loadLogData()" class="bg-gray-100 px-4 py-2 rounded-lg font-bold">ë¶ˆëŸ¬ì˜¤ê¸°</button><button onclick="saveLogData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-md">ì €ì¥í•˜ê¸°</button></div>
        </div>
        <div class="card border-t-4 border-green-500 mb-8"><h2 class="text-xl font-bold text-green-900 mb-3 flex items-center gap-2"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">ë³¸ê´€</span> í•œì„± ê°€ê³µì‹¤ <button onclick="addLogRow('hansung')" class="ml-auto text-xs border px-2 py-1 rounded bg-white">+ ì¶”ê°€</button></h2><div class="overflow-x-auto"><table class="w-full border-2 border-green-100"><thead><tr class="bg-green-50 text-green-900"><th class="w-32">ì œí’ˆëª…</th><th class="w-16">ì „ì¬ê³ </th><th class="w-16 text-blue-600">ì…ê³ </th><th class="w-20">ë°œì‹ LOT</th><th class="w-20">ì¢…ìˆ˜ëŸ‰</th><th class="w-16">ì‘ì—…ì</th><th class="w-16">ì†Œìš”ëŸ‰</th><th class="w-16">ë¶ˆëŸ‰</th><th class="w-16 bg-green-100">í˜„ì¬ê³ </th><th>ë¹„ê³ </th><th class="w-10">X</th></tr></thead><tbody id="body-hansung"></tbody></table></div></div>
        <div class="card border-t-4 border-blue-500"><h2 class="text-xl font-bold text-blue-900 mb-3 flex items-center gap-2"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm">ë³„ê´€</span> íƒœì„± ê°€ê³µì‹¤ <button onclick="addLogRow('taeseong')" class="ml-auto text-xs border px-2 py-1 rounded bg-white">+ ì¶”ê°€</button></h2><div class="overflow-x-auto"><table class="w-full border-2 border-blue-100"><thead><tr class="bg-blue-50 text-blue-900"><th class="w-32">ì œí’ˆëª…</th><th class="w-16">ì „ì¬ê³ </th><th class="w-16 text-blue-600">ì…ê³ </th><th class="w-20">ë°œì‹ LOT</th><th class="w-20">ì¢…ìˆ˜ëŸ‰</th><th class="w-16">ì‘ì—…ì</th><th class="w-16">ì†Œìš”ëŸ‰</th><th class="w-16">ë¶ˆëŸ‰</th><th class="w-16 bg-blue-100">í˜„ì¬ê³ </th><th>ë¹„ê³ </th><th class="w-10">X</th></tr></thead><tbody id="body-taeseong"></tbody></table></div></div>
    </div>

    <div id="packTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-amber-500"><h2 class="text-lg font-bold mb-4 text-amber-900">ì™„ì œí’ˆ í¬ì¥ ë“±ë¡</h2><div class="flex gap-2 mb-4"><div class="flex-1"><label class="text-xs text-gray-500 font-bold">ì œí’ˆëª…</label><input type="text" id="packName" placeholder="ì˜ˆ: 7125Y" list="realSuggestions" class="border-2 border-amber-200"></div><div class="w-32"><label class="text-xs text-gray-500 font-bold">ìˆ˜ëŸ‰(EA)</label><input type="number" id="packQty" placeholder="0" class="border-2 border-amber-200"></div></div><button onclick="addPacking()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow-md">ë“±ë¡ ë° ë°œì£¼ ì™„ë£Œ ì²˜ë¦¬</button></div>
            <div class="card lg:col-span-2"><h2 class="text-lg font-bold mb-4">ğŸ“¦ í¬ì¥ì‹¤ ì”ì—¬ ì¬ê³ </h2><div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-100"><th class="text-left p-3">ì œí’ˆëª…</th><th class="text-right p-3">ìˆ˜ëŸ‰ (EA)</th><th class="p-3 w-20">ê´€ë¦¬</th></tr></thead><tbody id="packListBody"></tbody></table></div></div>
        </div>
    </div>

<script>
    // --- ë¡œì»¬ ì €ì¥ì†Œ ë¡œì§ (ì„œë²„ ì—†ì´ í°ì— ì €ì¥) ---
    let DB = { orders: [], wip: [], raw: {}, real: {}, mappings: {}, logs: {}, packing: [] };

    function save() { localStorage.setItem('tapeKeeperDB', JSON.stringify(DB)); renderAll(); }
    function load() {
        const data = localStorage.getItem('tapeKeeperDB');
        if(data) { DB = JSON.parse(data); }
        else { seedMappings(); } // ì²˜ìŒ ì‹¤í–‰ì´ë©´ ê¸°ë³¸ ë°ì´í„° ìƒì„±
        renderAll();
        document.getElementById('loading').style.display = 'none';
    }

    // --- 0. ê¸°ì¤€ ì •ë³´ ---
    function seedMappings() {
        const defaults = { 
            "6084": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 1 }, 
            "6934": { raw: "510x195 (6934)", arr: 4, room: "hansung", order: 2 }, 
            "5869": { raw: "410x315 (5869)", arr: 4, room: "hansung", order: 3 }, 
            "4195": { raw: "470x237 (4195)", arr: 4, room: "hansung", order: 5 }, 
            "6855": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 7 }, 
            "ê¹€ì¹˜(ì¢Œ)": { raw: "510x295 (RR7000)", arr: 2, room: "taeseong", order: 1 }, 
            "6405": { raw: "470x130 (6405)", arr: 2, room: "taeseong", order: 6 } 
        };
        DB.mappings = defaults; save();
    }
    function resetData() { if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ê³  ì´ˆê¸°í™”í• ê¹Œìš”?")) { localStorage.clear(); location.reload(); } }

    function addMapping() {
        const key = document.getElementById('mapKey').value.trim();
        let raw = document.getElementById('mapRaw').value;
        if(raw === 'custom') raw = document.getElementById('mapRawCustom').value.trim();
        const arr = parseInt(document.getElementById('mapArr').value);
        const room = document.getElementById('mapRoom').value;
        if(!key || !raw || !arr) return alert("ì…ë ¥ í™•ì¸");
        
        const maxOrder = Math.max(0, ...Object.values(DB.mappings).filter(m=>m.room===room).map(m=>m.order||0));
        DB.mappings[key] = { raw, arr, room, order: maxOrder + 1 };
        document.getElementById('mapKey').value=''; document.getElementById('mapArr').value='';
        save(); alert("ë“±ë¡ ì™„ë£Œ!");
    }
    function deleteMapping(key) { if(confirm("ì‚­ì œ?")) { delete DB.mappings[key]; save(); } }

    // --- 1. ë°œì£¼ ---
    function addOrder() {
        const date = document.getElementById('inputDate').value;
        const title = document.getElementById('inputTitle').value;
        const goal = parseInt(document.getElementById('inputGoal').value)||0;
        const packed = parseInt(document.getElementById('inputPacked').value)||0;
        if(!date||!title||!goal) return alert("ì…ë ¥ í™•ì¸");
        DB.orders.push({ id: Date.now(), date, title, goal, packed, done: 0 });
        document.getElementById('inputTitle').value=''; document.getElementById('inputGoal').value=''; document.getElementById('inputPacked').value='';
        save();
    }
    function deleteOrder(id) { DB.orders = DB.orders.filter(o=>o.id !== id); save(); }

    // --- 2. ì‘ì—… ---
    function addWip() {
        const name = document.getElementById('wipName').value; const qty = parseInt(document.getElementById('wipQty').value);
        if(!name||!qty) return;
        DB.wip.push({ id: Date.now(), name, qty });
        document.getElementById('wipQty').value=''; save();
    }
    function deleteWip(id) { DB.wip = DB.wip.filter(w=>w.id !== id); save(); }
    
    function doWork() {
        const sel = document.getElementById('workProductSelect').value; const qty = parseInt(document.getElementById('workAmount').value);
        if(!sel||!qty) return alert("ì…ë ¥ í™•ì¸");
        
        const wipIdx = DB.wip.findIndex(w=>w.id == sel);
        const set = DB.wip[wipIdx];
        if(set.qty < qty) return alert("ì¬ê³  ë¶€ì¡±");
        
        // 1. í•„ë¦„ ì°¨ê°
        set.qty -= qty;
        if(set.qty === 0) DB.wip.splice(wipIdx, 1);

        // 2. í…Œì´í”„ ì›ë‹¨ ì°¨ê°
        const mapKey = Object.keys(DB.mappings).find(k => set.name.includes(k));
        if(mapKey) {
            const rawName = DB.mappings[mapKey].raw;
            // ì—°ê²°ëœ ì›ë‹¨ì´ 'ì‹¤ë¬´ì¬ê³ 'ì— ìˆëŠ”ì§€ í™•ì¸ (ì´ë¦„ì´ ê°™ë‹¤ë©´)
            const tapeKey = Object.keys(DB.real).find(k => k === mapKey); 
            if(tapeKey && DB.real[tapeKey]) { DB.real[tapeKey] = Math.max(0, DB.real[tapeKey] - qty); }
        }

        // 3. ë°œì£¼ ì±„ìš°ê¸°
        let pcs = mapKey ? DB.mappings[mapKey].arr : 1;
        let total = qty * pcs;
        let remain = total;
        
        DB.orders.filter(o => o.title.includes(set.name) && o.done < (o.goal-(o.packed||0)))
          .sort((a,b)=>new Date(a.date)-new Date(b.date))
          .forEach(o => {
              if(remain <= 0) return;
              const need = (o.goal-(o.packed||0)) - o.done;
              const fill = Math.min(remain, need);
              o.done += fill;
              remain -= fill;
          });
        
        document.getElementById('workResultMsg').innerHTML = `âœ… ${set.name} ${qty}ì¥ ì‘ì—…ì™„ë£Œ (ì´ ${total}ê°œ)`;
        document.getElementById('workResultMsg').classList.remove('hidden');
        document.getElementById('workAmount').value='';
        save();
    }

    // --- 3. ì›ë‹¨ ---
    function addRaw() {
        let type = document.getElementById('rawTypeSelect').value;
        if(type==='custom') type = document.getElementById('rawCustomInput').value.trim();
        const qty = parseInt(document.getElementById('rawQtyInput').value);
        if(!type||!qty) return;
        DB.raw[type] = (DB.raw[type]||0) + qty;
        document.getElementById('rawQtyInput').value=''; save();
    }

    // --- 4. ì‹¤ë¬´ (ìŠ¤ë§ˆíŠ¸ ì…ê³ ) ---
    function addReal() {
        const name = document.getElementById('realNameInput').value.trim();
        const qty = parseInt(document.getElementById('realQtyInput').value);
        if(!name||!qty) return alert("ì…ë ¥ í™•ì¸");

        // ë§¤í•‘ í™•ì¸
        const mapKey = Object.keys(DB.mappings).find(k => name.includes(k));
        // ì—°ê²°ëœ ì›ë‹¨ ì°¾ê¸°: ë§¤í•‘ëœ ì›ë‹¨ OR ì´ë¦„ì´ ê°™ì€ ì›ë‹¨
        const rawTarget = mapKey ? DB.mappings[mapKey].raw : (DB.raw[name] !== undefined ? name : null);

        if(rawTarget) {
            if((DB.raw[rawTarget]||0) < qty) { if(!confirm(`ì›ë‹¨ [${rawTarget}] ë¶€ì¡±. ì§„í–‰?`)) return; }
            DB.raw[rawTarget] = (DB.raw[rawTarget]||0) - qty;
            alert(`âœ… ì…ê³ ì™„ë£Œ. ì›ë‹¨ [${rawTarget}] ì°¨ê°ë¨.`);
        } else {
            if(confirm(`âš ï¸ ì—°ê²°ëœ ì›ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.\nì›ë‹¨ ì°¨ê° ì—†ì´ [${name}]ë§Œ ì¬ê³ ì— ì¶”ê°€í• ê¹Œìš”?`)) {
                alert("âœ… ì…ê³ ì™„ë£Œ (ì›ë‹¨ ì°¨ê° ì—†ìŒ)");
            } else { return; }
        }
        DB.real[name] = (DB.real[name]||0) + qty;
        document.getElementById('realNameInput').value=''; document.getElementById('realQtyInput').value='';
        save();
    }
    function deleteReal(key) { if(confirm("ì‚­ì œ?")) { delete DB.real[key]; save(); } }

    // --- 5. ì‘ì—…ì¼ì§€ ---
    function addLogRow(room, data={}) {
        const tbody = document.getElementById(`body-${room}`);
        const tr = document.createElement('tr');
        const { name='', prev=0, incoming=0, lot='', prod='', worker='', use=0, defect=0, curr=0, memo='' } = data;
        tr.innerHTML = `<td><input type="text" class="log-input text-left" value="${name}"></td><td><input type="number" class="log-input bg-gray-50" value="${prev}" oninput="calcRow(this)"></td><td><input type="number" class="log-input text-blue-600" value="${incoming}" oninput="calcRow(this)"></td><td><input type="text" class="log-input" value="${lot}"></td><td><input type="text" class="log-input" value="${prod}"></td><td><input type="text" class="log-input" value="${worker}"></td><td><input type="number" class="log-input text-red-600" value="${use}" oninput="calcRow(this)"></td><td><input type="number" class="log-input text-red-400" value="${defect}" oninput="calcRow(this)"></td><td class="bg-blue-50 text-center font-bold"><span class="curr-val">${curr}</span></td><td><input type="text" class="log-input text-left text-xs" value="${memo}"></td><td class="text-center"><button onclick="this.closest('tr').remove()" class="text-red-300">X</button></td>`;
        tbody.appendChild(tr); calcRow(tr.querySelector('input'));
    }
    function calcRow(input) {
        const tr = input.closest('tr'); const i = tr.querySelectorAll('input');
        const val = (parseInt(i[1].value)||0) + (parseInt(i[2].value)||0) - (parseInt(i[6].value)||0) - (parseInt(i[7].value)||0);
        tr.querySelector('.curr-val').innerText = val;
    }
    function saveLogData() {
        const date = document.getElementById('logDate').value; if(!date) return alert("ë‚ ì§œ ì„ íƒ");
        const get = (room) => Array.from(document.querySelectorAll(`#body-${room} tr`)).map(tr=>{ const i=tr.querySelectorAll('input'); return {name:i[0].value, prev:i[1].value, incoming:i[2].value, lot:i[3].value, prod:i[4].value, worker:i[5].value, use:i[6].value, defect:i[7].value, curr:tr.querySelector('.curr-val').innerText, memo:i[9].value}; }).filter(d=>d.name);
        DB.logs[date] = { hansung: get('hansung'), taeseong: get('taeseong') }; save(); alert("ì €ì¥ë¨");
    }
    function loadLogData() {
        const date = document.getElementById('logDate').value;
        document.getElementById('body-hansung').innerHTML = ''; document.getElementById('body-taeseong').innerHTML = '';
        
        const sorter = (arr) => arr.sort((a,b) => (DB.mappings[a.name]?.order||99) - (DB.mappings[b.name]?.order||99));

        if(DB.logs[date]) {
            sorter(DB.logs[date].hansung).forEach(r => addLogRow('hansung', r));
            sorter(DB.logs[date].taeseong).forEach(r => addLogRow('taeseong', r));
        } else {
            // ì´ì „ ë°ì´í„°(ì „ì¬ê³ ) ë¶ˆëŸ¬ì˜¤ê¸°
            const prevDates = Object.keys(DB.logs).filter(d => d < date).sort().reverse();
            const prevData = prevDates.length > 0 ? DB.logs[prevDates[0]] : { hansung:[], taeseong:[] };
            
            const keys = Object.keys(DB.mappings).sort((a,b)=>(DB.mappings[a].order||99)-(DB.mappings[b].order||99));
            keys.forEach(k => {
                const room = DB.mappings[k].room;
                const last = prevData[room].find(r => r.name === k);
                addLogRow(room, { name: k, prev: last ? last.curr : 0 });
            });
        }
    }

    // --- 6. í¬ì¥ ---
    function addPacking() {
        const name = document.getElementById('packName').value.trim(); const qty = parseInt(document.getElementById('packQty').value);
        if(!name||!qty) return;
        
        let remain = qty;
        DB.orders.filter(o => o.title.includes(name) && o.done < o.goal)
          .sort((a,b)=>new Date(a.date)-new Date(b.date))
          .forEach(o => {
              if(remain <= 0) return;
              const need = o.goal - o.done;
              const fill = Math.min(remain, need);
              o.done += fill; remain -= fill;
          });
        
        if(remain > 0) {
            const exist = DB.packing.find(p=>p.name==name);
            if(exist) exist.qty += remain; else DB.packing.push({id:Date.now(), name, qty:remain});
            alert(`âœ… ${qty}ê°œ ì²˜ë¦¬ (ì”ì—¬ ${remain}ê°œ í¬ì¥ì‹¤ ë³´ê´€)`);
        } else { alert("âœ… ì „ëŸ‰ ë°œì£¼ ëª©í‘œ ë‹¬ì„±"); }
        document.getElementById('packName').value=''; document.getElementById('packQty').value=''; save();
    }
    function deletePacking(id) { DB.packing = DB.packing.filter(p=>p.id!==id); save(); }

    // --- ë Œë”ë§ ---
    function renderAll() {
        // ë§¤í•‘
        const mBody = document.getElementById('mapListBody'); mBody.innerHTML='';
        const sortedMap = Object.keys(DB.mappings).sort((a,b) => {
            if(DB.mappings[a].room !== DB.mappings[b].room) return DB.mappings[a].room === 'hansung' ? -1 : 1;
            return (DB.mappings[a].order||99) - (DB.mappings[b].order||99);
        });
        sortedMap.forEach(k => {
            const m = DB.mappings[k];
            const badge = m.room === 'hansung' ? '<span class="text-green-600 font-bold">ë³¸ê´€</span>' : '<span class="text-blue-600 font-bold">ë³„ê´€</span>';
            const tr = document.createElement('tr'); tr.className = "draggable-row border-b"; tr.draggable = true; tr.dataset.id = k;
            tr.innerHTML = `<td class="text-center text-gray-400 cursor-grab py-3">â‰¡</td><td class="text-center">${badge}</td><td class="font-bold">${k}</td><td class="text-xs text-gray-500">${m.raw}</td><td class="text-center">${m.arr}</td><td class="text-center"><button onclick="deleteMapping('${k}')" class="text-red-400">ì‚­ì œ</button></td>`;
            // ë“œë˜ê·¸ ë¡œì§
            tr.addEventListener('dragstart', function() { this.classList.add('dragging'); });
            tr.addEventListener('dragend', function() { this.classList.remove('dragging'); });
            tr.addEventListener('dragover', function(e) { e.preventDefault(); });
            tr.addEventListener('drop', function() {
                const draggedKey = document.querySelector('.dragging').dataset.id;
                const targetKey = this.dataset.id;
                if(DB.mappings[draggedKey].room !== DB.mappings[targetKey].room) return alert("ê°™ì€ ê°€ê³µì‹¤ ë‚´ì—ì„œë§Œ ì´ë™ ê°€ëŠ¥");
                // ìˆœì„œ ë³€ê²½ ë¡œì§ (ìƒëµ - ê°„ë‹¨í•˜ê²Œ ìœ„ì•„ë˜ êµì²´)
                const room = DB.mappings[draggedKey].room;
                const list = sortedMap.filter(k=>DB.mappings[k].room===room);
                const f = list.indexOf(draggedKey); const t = list.indexOf(targetKey);
                list.splice(f, 1); list.splice(t, 0, draggedKey);
                list.forEach((key, idx) => DB.mappings[key].order = idx + 1);
                save();
            });
            mBody.appendChild(tr);
        });

        // ë°œì£¼
        const oBody = document.getElementById('orderListBody'); oBody.innerHTML='';
        DB.orders.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(o=>{
            const realGoal = Math.max(0, o.goal - (o.packed||0));
            const pct = realGoal > 0 ? Math.round((o.done/realGoal)*100) : 100;
            oBody.innerHTML += `<tr><td>${o.date}</td><td>${o.title}</td><td>${o.goal}</td><td>${o.packed||0}</td><td class="bg-blue-50 text-blue-700 font-bold">${realGoal}</td><td><div class="text-xs flex justify-between"><span>${o.done}</span><span>${pct}%</span></div><div class="h-1 bg-gray-200"><div class="h-full bg-blue-500" style="width:${Math.min(100,pct)}%"></div></div></td><td><button onclick="deleteOrder(${o.id})" class="text-red-400 text-xs">ì‚­ì œ</button></td></tr>`;
        });

        // WIP
        const wList = document.getElementById('wipList'); wList.innerHTML='';
        const wSel = document.getElementById('workProductSelect'); wSel.innerHTML='<option value="">(ì„ íƒ)</option>';
        DB.wip.forEach(w => {
            wList.innerHTML += `<div class="bg-white border p-2 rounded text-sm flex justify-between"><span><b>${w.name}</b> (${w.qty}ì¥)</span> <button onclick="deleteWip(${w.id})" class="text-red-400">X</button></div>`;
            wSel.innerHTML += `<option value="${w.id}">${w.name} (${w.qty})</option>`;
        });

        // ì›ë‹¨
        const rBody = document.getElementById('rawListBody'); rBody.innerHTML='';
        Object.keys(DB.raw).sort().forEach(k => rBody.innerHTML += `<tr><td class="font-bold">${k}</td><td class="text-right">${DB.raw[k]}</td></tr>`);

        // ì‹¤ë¬´
        const rlBody = document.getElementById('realListBody'); rlBody.innerHTML='';
        Object.keys(DB.real).sort().forEach(k => rlBody.innerHTML += `<div class="bg-purple-50 p-2 rounded border border-purple-100 flex justify-between"><div><div class="font-bold text-purple-900">${k}</div><span class="text-xl font-bold text-purple-600">${DB.real[k]}</span><span class="text-xs">ì¥</span></div><button onclick="deleteReal('${k}')" class="text-red-300">X</button></div>`);

        // í¬ì¥
        const pBody = document.getElementById('packListBody'); pBody.innerHTML='';
        DB.packing.forEach(p => pBody.innerHTML += `<tr class="border-b"><td class="p-3 font-bold">${p.name}</td><td class="p-3 text-right text-blue-600 font-bold">${p.qty}</td><td class="p-3 text-center"><button onclick="deletePacking(${p.id})" class="text-red-400">ì‚­ì œ</button></td></tr>`);
        
        // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        const opts = '<option value="">(ì„ íƒ)</option>' + Object.keys(DB.raw).sort().map(k=>`<option value="${k}">${k}</option>`).join('') + '<option value="custom">ì§ì ‘ì…ë ¥</option>';
        document.getElementById('rawTypeSelect').innerHTML = opts; document.getElementById('mapRaw').innerHTML = opts;
        document.getElementById('realSuggestions').innerHTML = Object.keys(DB.mappings).map(k=>`<option value="${k}">`).join('');
        document.getElementById('calcProduct').innerHTML = '<option value="">(ì„ íƒ)</option>' + Object.keys(DB.mappings).sort().map(k=>`<option value="${k}">${k}</option>`).join('');
    }

    // --- UI ì´ë²¤íŠ¸ ---
    const tabs = ['setTab', 'orderTab', 'workTab', 'rawTab', 'realTab', 'logTab', 'packTab'];
    tabs.forEach(t => document.getElementById('btn-'+t).addEventListener('click', ()=>{ 
        tabs.forEach(x => { document.getElementById(x).classList.add('hidden'); document.getElementById('btn-'+x).classList.remove('active'); }); 
        document.getElementById(t).classList.remove('hidden'); document.getElementById('btn-'+t).classList.add('active'); 
    }));
    
    ['rawTypeSelect', 'mapRaw'].forEach(id => document.getElementById(id).addEventListener('change', function(){ 
        const t = document.getElementById(id==='mapRaw'?'mapRawCustom':'rawCustomInput');
        if(this.value==='custom') { t.classList.remove('hidden'); t.focus(); } else t.classList.add('hidden');
    }));

    document.getElementById('calcTarget').addEventListener('input', function() {
        const key = document.getElementById('calcProduct').value; const t = parseInt(this.value)||0;
        if(key && t) { const m = DB.mappings[key]; const n = Math.ceil(t / (m.arr||1)); document.getElementById('calcResult').innerHTML = `ì•½ <span class="text-red-600 text-3xl">${n}</span> ì¥ (${m.raw})`; }
    });

    window.onload = load;
    document.getElementById('inputDate').valueAsDate = new Date();
    document.getElementById('logDate').valueAsDate = new Date();
</script>
</body>
</html>
