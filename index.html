<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - FINAL MASTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: "Pretendard", "Malgun Gothic", sans-serif; background-color: #f8fafc; padding: 15px; }
        .tab-btn { padding: 10px 12px; font-weight: bold; color: #64748b; border-bottom: 3px solid transparent; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .tab-btn.active { color: #2563eb; border-bottom: 3px solid #2563eb; background-color: #eff6ff; border-radius: 5px 5px 0 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        input, select { border: 1px solid #cbd5e1; padding: 8px; border-radius: 6px; width: 100%; font-size: 14px; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; ring: 2px; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        th { background: #f1f5f9; color: #475569; padding: 10px; font-weight: 700; border-bottom: 2px solid #e2e8f0; text-align: center; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; text-align: center; }
        tr:last-child td { border-bottom: none; }
        
        /* ì‘ì—…ì¼ì§€ ì¸í’‹ */
        .log-input { width: 100%; text-align: center; border: none; background: transparent; font-weight: 600; }
        .log-input:focus { background: #eff6ff; }
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ */
        .draggable-row { cursor: grab; transition: background 0.2s; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; background: #fef9c3; border: 2px dashed #eab308; }
        
        .hidden { display: none; }
        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); display:flex; justify-content:center; align-items:center; z-index:9999; flex-direction: column;}
    </style>
</head>
<body class="max-w-[1200px] mx-auto text-slate-800">

    <div id="loading">
        <div class="text-4xl font-black text-blue-600 mb-2 animate-bounce">TAPE KEEPER</div>
        <div class="text-sm text-gray-500 font-bold">ì‹œìŠ¤í…œ ë™ê¸°í™” ì¤‘...</div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg"><i class="fas fa-tape text-xl"></i></div>
            <h1 class="text-2xl font-bold tracking-tight text-slate-800">TAPE KEEPER <span class="text-xs font-normal text-gray-400">Ver 3.0 (Master)</span></h1>
        </div>
        <div class="flex space-x-1 bg-white p-1 rounded-xl shadow-sm overflow-x-auto w-full md:w-auto border border-gray-200">
            <button id="btn-setTab" class="tab-btn active"><i class="fas fa-cog"></i> 0. ê¸°ì¤€ ì •ë³´</button>
            <button id="btn-orderTab" class="tab-btn"><i class="fas fa-file-invoice"></i> 1. ë°œì£¼</button>
            <button id="btn-workTab" class="tab-btn"><i class="fas fa-dolly"></i> 2. ì‘ì—…</button>
            <button id="btn-rawTab" class="tab-btn text-pink-600"><i class="fas fa-scroll"></i> 3. ì›ë‹¨</button>
            <button id="btn-realTab" class="tab-btn text-purple-600"><i class="fas fa-cut"></i> 4. ì‹¤ë¬´/ì¬ê³ </button>
            <button id="btn-logTab" class="tab-btn text-blue-700 bg-blue-50"><i class="fas fa-calendar-check"></i> 5. ì‘ì—…ì¼ì§€</button>
            <button id="btn-packTab" class="tab-btn text-amber-600 bg-amber-50"><i class="fas fa-box-open"></i> 6. í¬ì¥/ì¶œê³ </button>
        </div>
    </div>

    <div id="setTab">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card border-t-4 border-gray-600 lg:col-span-1 h-fit">
                <h2 class="text-lg font-bold mb-4 text-gray-800"><i class="fas fa-plus-circle"></i> ì œí’ˆ(í…Œì´í”„) ë“±ë¡</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">ìœ„ì¹˜ (ê°€ê³µì‹¤)</label>
                        <select id="mapRoom" class="font-bold">
                            <option value="hansung">ğŸŸ¢ í•œì„± (ë³¸ê´€)</option>
                            <option value="taeseong">ğŸ”µ íƒœì„± (ë³„ê´€)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">ì œí’ˆëª… (í…Œì´í”„ ì´ë¦„)</label>
                        <input type="text" id="mapKey" placeholder="ì˜ˆ: 6084, ê¹€ì¹˜(ì¢Œ)">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">ì‚¬ìš© ì›ë‹¨ (ë§¤ì¹­)</label>
                        <select id="mapRaw" class="mb-2"></select>
                        <input type="text" id="mapRawCustom" class="hidden bg-gray-50 border-dashed" placeholder="ì›ë‹¨ ì´ë¦„ ì§ì ‘ ì…ë ¥">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">ë°°ì—´ (1ì¥ë‹¹ ì œí’ˆ ìˆ˜)</label>
                        <input type="number" id="mapArr" placeholder="ì˜ˆ: 8" class="text-center font-bold text-lg">
                    </div>
                    <button id="btnAddMap" class="w-full bg-gray-800 hover:bg-black text-white font-bold py-3 rounded-lg shadow-md transition">ë“±ë¡ / ìˆ˜ì •</button>
                </div>
            </div>

            <div class="card lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">ğŸ“‹ ë“±ë¡ëœ ì œí’ˆ ëª©ë¡ (ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)</h2>
                    <button onclick="seedMappings()" class="text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded hover:bg-gray-200">âš  ì´ˆê¸° ë°ì´í„° ë³µêµ¬</button>
                </div>
                <div class="bg-blue-50 text-blue-800 text-sm p-3 rounded mb-4">
                    <i class="fas fa-info-circle"></i> <b>íŒ:</b> ëª©ë¡ì˜ <b class="text-xl">â‰¡</b> ë¥¼ ì¡ê³  ìœ„ì•„ë˜ë¡œ ëŒë©´ <b>ì‘ì—…ì¼ì§€ ìˆœì„œ</b>ê°€ ë°”ë€ë‹ˆë‹¤.
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="w-10">â‰¡</th>
                                <th class="w-20">ìœ„ì¹˜</th>
                                <th class="text-left">ì œí’ˆëª…</th>
                                <th class="text-left">ì‚¬ìš© ì›ë‹¨</th>
                                <th class="w-20">ë°°ì—´</th>
                                <th class="w-20">ì‚­ì œ</th>
                            </tr>
                        </thead>
                        <tbody id="mapListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="orderTab" class="hidden">
        <div class="card border-t-4 border-blue-500">
            <h2 class="text-lg font-bold mb-4 text-blue-900"><i class="fas fa-pen"></i> ë°œì£¼ ìˆ˜ë™ ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div><label class="text-xs text-gray-500">ë‚©ê¸°ì¼</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">ë°œì£¼ëª… / P/N</label><input type="text" id="inputTitle" placeholder="ì˜ˆ: DA64-06405J 3000ê°œ"></div>
                <div><label class="text-xs text-gray-500 font-bold">ì´ ëª©í‘œ(EA)</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500 text-blue-600 font-bold">í¬ì¥ì‹¤ì¬ê³ (ì°¨ê°)</label><input type="number" id="inputPacked" placeholder="0" class="border-blue-300 bg-blue-50"></div>
                <button id="btnAddOrder" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg h-[38px]">ë“±ë¡</button>
            </div>
        </div>
        <div class="card">
            <h2 class="text-lg font-bold mb-4">ğŸ“‹ ì§„í–‰ ì¤‘ì¸ ë°œì£¼</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr><th class="w-24">ë‚©ê¸°</th><th>ë°œì£¼ëª…</th><th class="w-20">ëª©í‘œ</th><th class="w-20">ê¸°ì¬ê³ </th><th class="w-20 bg-blue-50">ì‹¤ëª©í‘œ</th><th class="w-32">ì§„í–‰ë¥ </th><th class="w-16">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody id="orderListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="workTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-yellow-500 bg-yellow-50">
                <h2 class="text-lg font-bold mb-4 text-yellow-900"><i class="fas fa-calculator"></i> ì‘ì—…ëŸ‰ ê³„ì‚°ê¸°</h2>
                <div class="flex gap-2 mb-2">
                    <select id="calcProduct" class="flex-1 border-yellow-300"></select>
                    <input type="number" id="calcTarget" placeholder="ëª©í‘œ(EA)" class="w-24 text-center border-yellow-300">
                </div>
                <div id="calcResult" class="text-center font-bold text-yellow-800 text-xl mt-4 bg-white p-3 rounded-lg border border-yellow-200 shadow-sm">- ì¥ ì¤€ë¹„í•˜ì„¸ìš” -</div>
            </div>

            <div class="card border-t-4 border-indigo-500">
                <h2 class="text-lg font-bold mb-4 text-indigo-900"><i class="fas fa-layer-group"></i> ì¸ì‡„ í•„ë¦„/ì„¸íŠ¸ ì¤€ë¹„</h2>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="wipName" placeholder="ì œí’ˆ(í•„ë¦„)ëª…" class="flex-1">
                    <input type="number" id="wipQty" placeholder="ìˆ˜ëŸ‰(ì¥)" class="w-24">
                </div>
                <button id="btnAddWip" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg mb-4">ì¤€ë¹„ ì™„ë£Œ (ì¬ê³  ë“±ë¡)</button>
                <div id="wipList" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>

            <div class="card border-t-4 border-green-500 lg:col-span-2">
                <h2 class="text-lg font-bold mb-4 text-green-900"><i class="fas fa-check-circle"></i> í•©ì§€/ê°€ê³µ ì‘ì—… ì™„ë£Œ ë“±ë¡</h2>
                <div class="flex flex-col md:flex-row gap-4 items-end bg-green-50 p-4 rounded-lg">
                    <div class="flex-1 w-full">
                        <label class="text-xs font-bold text-green-700">ì‘ì—…í•œ ì œí’ˆ (í•„ë¦„)</label>
                        <select id="workProductSelect" class="border-green-300"></select>
                    </div>
                    <div class="w-full md:w-32">
                        <label class="text-xs font-bold text-green-700">ì‘ì—… ìˆ˜ëŸ‰ (ì¥)</label>
                        <input type="number" id="workAmount" placeholder="0" class="border-green-300 focus:border-green-600">
                    </div>
                    <button id="btnDoWork" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded-lg shadow-lg h-[40px]">
                        ì‘ì—… ë“±ë¡!
                    </button>
                </div>
                <div id="workResultMsg" class="mt-2 text-center text-sm font-bold text-green-700 hidden"></div>
                <p class="mt-2 text-xs text-gray-500 text-center">* ë“±ë¡ ì‹œ [í•„ë¦„ ì¬ê³ ]ì™€ [í…Œì´í”„ ì¬ê³ ]ê°€ ë™ì‹œì— ì°¨ê°ë˜ë©°, [ë°œì£¼ ìˆ˜ëŸ‰]ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div id="rawTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-3 border-t-4 border-red-500 bg-red-50">
                <h2 class="text-lg font-bold mb-2 text-red-900"><i class="fas fa-bell"></i> ìì¬ ë¶€ì¡± ì•Œë¦¼ (ì˜ˆì¸¡)</h2>
                <div id="forecastReport" class="text-sm space-y-2"><div class="text-gray-400">ë¶„ì„ ì¤‘...</div></div>
            </div>
            
            <div class="card lg:col-span-1 border-t-4 border-pink-500">
                <h2 class="text-lg font-bold mb-4 text-pink-900"><i class="fas fa-arrow-down"></i> ì›ë‹¨ ì…ê³ </h2>
                <div class="space-y-4">
                    <select id="rawTypeSelect" class="border-pink-300"></select>
                    <input type="text" id="rawCustomInput" class="hidden bg-pink-50" placeholder="ìƒˆ ê·œê²© ì§ì ‘ ì…ë ¥">
                    <input type="number" id="rawQtyInput" placeholder="ìˆ˜ëŸ‰ (ì¥)">
                    <button id="btnAddRaw" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 rounded-lg">ì…ê³  ì²˜ë¦¬</button>
                </div>
            </div>
            
            <div class="card lg:col-span-2">
                <h2 class="text-lg font-bold mb-4">ğŸ“Š ì›ë‹¨(Base) ì¬ê³  í˜„í™©</h2>
                <div class="overflow-x-auto">
                    <table>
                        <thead><tr><th>ê·œê²©/ìì¬ëª…</th><th>ì¬ê³ (ì¥)</th><th>ìƒíƒœ</th></tr></thead>
                        <tbody id="rawListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="realTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-1 border-t-4 border-purple-500">
                <h2 class="text-lg font-bold mb-4 text-purple-900"><i class="fas fa-dolly-flatbed"></i> ì‹¤ë¬´(í…Œì´í”„) ì…ê³ </h2>
                <div class="bg-purple-50 p-3 rounded mb-4 text-xs text-purple-700">
                    * ì œí’ˆëª…ì„ ì…ë ¥í•˜ë©´ <b>[0. ê¸°ì¤€ ì •ë³´]</b>ë¥¼ í™•ì¸í•˜ì—¬ ì—°ê²°ëœ ì›ë‹¨ì„ ìë™ ì°¨ê°í•©ë‹ˆë‹¤.<br>
                    * ì—°ê²°ëœ ê²Œ ì—†ìœ¼ë©´ <b>ì´ë¦„ìœ¼ë¡œ ì°¾ê±°ë‚˜</b> ì•Œë¦¼ì°½ì´ ëœ¹ë‹ˆë‹¤.
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500">ì œí’ˆëª…</label>
                        <input type="text" id="realNameInput" placeholder="ì˜ˆ: ê³µì²­ê¸°, ê³ ë°ê¸°" list="realSuggestions">
                        <datalist id="realSuggestions"></datalist>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">ì…ê³  ìˆ˜ëŸ‰ (ì¥)</label>
                        <input type="number" id="realQtyInput" placeholder="0">
                    </div>
                    <button id="btnAddReal" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow-md">
                        ì…ê³  ë° ì›ë‹¨ ì°¨ê°
                    </button>
                </div>
            </div>
            
            <div class="card lg:col-span-2">
                <h2 class="text-lg font-bold mb-4">ğŸ§º í…Œì´í”„(ê°€ê³µ ì „) ì¬ê³  í˜„í™©</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="realListBody"></div>
            </div>
        </div>
    </div>

    <div id="logTab" class="hidden">
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm border border-blue-100">
            <div class="flex items-center gap-4">
                <label class="font-bold text-gray-700 text-lg">ğŸ“… ì¼ì:</label>
                <input type="date" id="logDate" class="border-2 border-blue-300 p-2 rounded-lg font-bold text-blue-800 cursor-pointer text-lg" onchange="loadLogData()">
            </div>
            <div class="flex gap-2">
                <button onclick="loadLogData()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-200"><i class="fas fa-sync"></i> ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="saveLogData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md"><i class="fas fa-save"></i> ì €ì¥í•˜ê¸°</button>
            </div>
        </div>

        <div class="card border-t-4 border-green-500 mb-8">
            <h2 class="text-xl font-bold text-green-900 mb-3 flex items-center gap-2">
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">ë³¸ê´€</span> í•œì„± ê°€ê³µì‹¤
                <button onclick="addLogRow('hansung')" class="ml-auto text-xs border px-2 py-1 rounded bg-white">+ ë¹ˆ ì¤„ ì¶”ê°€</button>
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full border-2 border-green-100">
                    <thead>
                        <tr class="bg-green-50 text-green-900">
                            <th class="w-32">ì œí’ˆëª…</th><th class="w-16">ì „ì¬ê³ </th><th class="w-16 text-blue-600">ì…ê³ </th>
                            <th class="w-20">ë°œì‹ LOT</th><th class="w-20">ì¢…ìˆ˜ëŸ‰</th><th class="w-16">ì‘ì—…ì</th>
                            <th class="w-16">ì†Œìš”ëŸ‰</th><th class="w-16">ë¶ˆëŸ‰</th><th class="w-16 bg-green-100">í˜„ì¬ê³ </th>
                            <th>ë¹„ê³ </th><th class="w-10">X</th>
                        </tr>
                    </thead>
                    <tbody id="body-hansung"></tbody>
                </table>
            </div>
        </div>

        <div class="card border-t-4 border-blue-500">
            <h2 class="text-xl font-bold text-blue-900 mb-3 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm">ë³„ê´€</span> íƒœì„± ê°€ê³µì‹¤
                <button onclick="addLogRow('taeseong')" class="ml-auto text-xs border px-2 py-1 rounded bg-white">+ ë¹ˆ ì¤„ ì¶”ê°€</button>
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full border-2 border-blue-100">
                    <thead>
                        <tr class="bg-blue-50 text-blue-900">
                            <th class="w-32">ì œí’ˆëª…</th><th class="w-16">ì „ì¬ê³ </th><th class="w-16 text-blue-600">ì…ê³ </th>
                            <th class="w-20">ë°œì‹ LOT</th><th class="w-20">ì¢…ìˆ˜ëŸ‰</th><th class="w-16">ì‘ì—…ì</th>
                            <th class="w-16">ì†Œìš”ëŸ‰</th><th class="w-16">ë¶ˆëŸ‰</th><th class="w-16 bg-blue-100">í˜„ì¬ê³ </th>
                            <th>ë¹„ê³ </th><th class="w-10">X</th>
                        </tr>
                    </thead>
                    <tbody id="body-taeseong"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="packTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-amber-500">
                <h2 class="text-lg font-bold mb-4 text-amber-900"><i class="fas fa-box"></i> ì™„ì œí’ˆ í¬ì¥ ë“±ë¡ (ìµœì¢…)</h2>
                <div class="flex gap-2 mb-4">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 font-bold">ì œí’ˆëª…</label>
                        <input type="text" id="packName" placeholder="ì˜ˆ: 7125Y" list="realSuggestions" class="border-2 border-amber-200">
                    </div>
                    <div class="w-32">
                        <label class="text-xs text-gray-500 font-bold">ìˆ˜ëŸ‰(EA)</label>
                        <input type="number" id="packQty" placeholder="0" class="border-2 border-amber-200">
                    </div>
                </div>
                <button onclick="addPacking()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow-md">ë“±ë¡ ë° ë°œì£¼ ì™„ë£Œ ì²˜ë¦¬</button>
            </div>
            <div class="card lg:col-span-2">
                <h2 class="text-lg font-bold mb-4">ğŸ“¦ í¬ì¥ì‹¤ ì”ì—¬ ì¬ê³ </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead><tr class="bg-gray-100"><th class="text-left p-3">ì œí’ˆëª…</th><th class="text-right p-3">ìˆ˜ëŸ‰ (EA)</th><th class="p-3 w-20">ê´€ë¦¬</th></tr></thead>
                        <tbody id="packListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, getDoc, setDoc, writeBatch, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Firebase ì„¤ì • ---
    const firebaseConfig = {
        apiKey: "AIzaSyAkMFlhE-19SvNS6XeHqTAHM3UTHHLb9Ww",
        authDomain: "tapekeeper-8070e.firebaseapp.com",
        projectId: "tapekeeper-8070e",
        storageBucket: "tapekeeper-8070e.firebasestorage.app",
        messagingSenderId: "267507609999",
        appId: "1:267507609999:web:889761a8792b0fa1a6dbfa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- ë°ì´í„° ìƒíƒœ ë³€ìˆ˜ ---
    let orders = [], wip = [], rawMaterials = {}, realMaterials = {}, mappings = {}, packing = [];

    // --- ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ---
    onSnapshot(query(collection(db, "mappings")), (snap) => { 
        mappings={}; snap.docs.forEach(d=>{mappings[d.id]=d.data()}); 
        if(Object.keys(mappings).length===0) seedMappings(); // ë°ì´í„° ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ ìƒì„±
        else { renderMappings(); updateDataList(); }
    });
    onSnapshot(query(collection(db, "orders")), (snap) => { orders = snap.docs.map(d => ({id:d.id, ...d.data()})); renderOrders(); updateForecast(); document.getElementById('loading').style.display='none'; });
    onSnapshot(query(collection(db, "wip")), (snap) => { wip = snap.docs.map(d => ({id:d.id, ...d.data()})); renderWip(); });
    onSnapshot(query(collection(db, "raw_materials")), (snap) => { rawMaterials={}; snap.docs.forEach(d=>{rawMaterials[d.id]=d.data()}); renderRaw(); updateForecast(); updateRawSelect(); });
    onSnapshot(query(collection(db, "real_materials")), (snap) => { realMaterials={}; snap.docs.forEach(d=>{realMaterials[d.id]=d.data()}); renderReal(); });
    onSnapshot(query(collection(db, "packing")), (snap) => { packing = snap.docs.map(d => ({id:d.id, ...d.data()})); renderPacking(); });

    // --- [0] ê¸°ì¤€ ì •ë³´ (ë§¤í•‘) ë¡œì§ ---
    // ì´ˆê¸° ë°ì´í„° (ì”¨ì•—)
    window.seedMappings = async () => { 
        const defaults = { 
            "6084": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 1 }, 
            "6934": { raw: "510x195 (6934)", arr: 4, room: "hansung", order: 2 }, 
            "5869": { raw: "410x315 (5869)", arr: 4, room: "hansung", order: 3 }, 
            "4195": { raw: "470x237 (4195)", arr: 4, room: "hansung", order: 5 }, 
            "6855": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 7 }, 
            "ê¹€ì¹˜(ì¢Œ)": { raw: "510x295 (RR7000)", arr: 2, room: "taeseong", order: 1 }, 
            "6405": { raw: "470x130 (6405)", arr: 2, room: "taeseong", order: 6 } 
        }; 
        const batch = writeBatch(db); 
        for(const k in defaults) batch.set(doc(db, "mappings", k), defaults[k]); 
        await batch.commit(); 
        alert("ê¸°ë³¸ ë°ì´í„°ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤."); 
    };

    window.addMapping = async () => { 
        const key = document.getElementById('mapKey').value.trim(); 
        let raw = document.getElementById('mapRaw').value; 
        if (raw === 'custom') raw = document.getElementById('mapRawCustom').value.trim(); 
        const arr = parseInt(document.getElementById('mapArr').value); 
        const room = document.getElementById('mapRoom').value; 
        
        if(!key || !raw || !arr) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
        
        // í˜„ì¬ í•´ë‹¹ ë£¸ì˜ ê°€ì¥ í° order ê°’ ì°¾ê¸°
        const maxOrder = Math.max(0, ...Object.values(mappings).filter(m=>m.room===room).map(m=>m.order||0));
        
        await setDoc(doc(db, "mappings", key), { raw, arr, room, order: maxOrder + 1 }); 
        
        document.getElementById('mapKey').value=''; 
        document.getElementById('mapArr').value=''; 
        alert(`âœ… [${key}] ë“±ë¡ ì™„ë£Œ!`);
    };

    window.deleteMapping = async (id) => { if(confirm(`${id} ì œí’ˆ ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) await deleteDoc(doc(db, "mappings", id)); };
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë Œë”ë§
    let draggedItem = null;
    function renderMappings() { 
        const tbody = document.getElementById('mapListBody'); 
        tbody.innerHTML = ''; 
        
        // ì •ë ¬: ë£¸(í•œì„±->íƒœì„±) -> ìˆœì„œ(order)
        const sortedKeys = Object.keys(mappings).sort((a, b) => { 
            const mA = mappings[a]; const mB = mappings[b]; 
            if (mA.room !== mB.room) return mA.room === 'hansung' ? -1 : 1; 
            return (mA.order || 99) - (mB.order || 99); 
        });
        
        sortedKeys.forEach(k => { 
            const m = mappings[k]; 
            const badge = m.room === 'hansung' ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">ë³¸ê´€</span>' : '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">ë³„ê´€</span>';
            
            const tr = document.createElement('tr');
            tr.className = "draggable-row border-b hover:bg-gray-50";
            tr.draggable = true;
            tr.dataset.id = k;
            tr.innerHTML = `
                <td class="text-center text-gray-400 cursor-grab text-xl drag-handle py-3">â‰¡</td>
                <td class="text-center">${badge}</td>
                <td class="font-bold text-gray-700">${k}</td>
                <td class="text-xs text-gray-500">${m.raw}</td>
                <td class="text-center text-blue-600 font-bold">${m.arr}ê°œ</td>
                <td class="text-center"><button onclick="deleteMapping('${k}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
            `;
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            tr.addEventListener('dragstart', function() { draggedItem = this; setTimeout(() => this.classList.add('hidden'), 0); });
            tr.addEventListener('dragend', function() { this.classList.remove('hidden'); draggedItem = null; });
            tr.addEventListener('dragover', function(e) { e.preventDefault(); });
            tr.addEventListener('dragenter', function(e) { e.preventDefault(); this.style.backgroundColor = '#fef9c3'; });
            tr.addEventListener('dragleave', function() { this.style.backgroundColor = ''; });
            tr.addEventListener('drop', async function() {
                this.style.backgroundColor = '';
                if (draggedItem === this) return;
                
                const srcId = draggedItem.dataset.id;
                const destId = this.dataset.id;
                
                // ê°™ì€ ë°©(Room)ë¼ë¦¬ë§Œ ì´ë™ ê°€ëŠ¥
                if(mappings[srcId].room !== mappings[destId].room) return alert("ê°™ì€ ìœ„ì¹˜(ë³¸ê´€/ë³„ê´€) ë‚´ì—ì„œë§Œ ìˆœì„œë¥¼ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                
                // ë°°ì—´ ì¬ì •ë ¬ ë¡œì§
                const room = mappings[srcId].room;
                const keysInRoom = sortedKeys.filter(k => mappings[k].room === room);
                const fromIdx = keysInRoom.indexOf(srcId);
                const toIdx = keysInRoom.indexOf(destId);
                
                keysInRoom.splice(fromIdx, 1);
                keysInRoom.splice(toIdx, 0, srcId);
                
                // ìˆœì„œ ì—…ë°ì´íŠ¸
                const batch = writeBatch(db);
                keysInRoom.forEach((key, index) => { batch.update(doc(db, "mappings", key), { order: index + 1 }); });
                await batch.commit();
            });
            tbody.appendChild(tr);
        }); 
    }


    // --- [1] ë°œì£¼ ê¸°ëŠ¥ ---
    window.addOrder = async () => { 
        const date = document.getElementById('inputDate').value; 
        const title = document.getElementById('inputTitle').value; 
        const goal = parseInt(document.getElementById('inputGoal').value)||0; 
        const packed = parseInt(document.getElementById('inputPacked').value)||0; 
        if(!date||!title||!goal) return alert("ì…ë ¥ í™•ì¸"); 
        await addDoc(collection(db, "orders"), { date, title, goal, packed, done: 0 }); 
        document.getElementById('inputTitle').value=''; 
        document.getElementById('inputGoal').value=''; 
        document.getElementById('inputPacked').value=''; 
    };
    
    function renderOrders() { 
        const tbody = document.getElementById('orderListBody'); tbody.innerHTML = ''; 
        orders.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(o => { 
            let realGoal = Math.max(0, o.goal - (o.packed || 0)); 
            let pct = realGoal > 0 ? Math.round((o.done / realGoal) * 100) : 100; 
            tbody.innerHTML += `<tr>
                <td><input type="date" value="${o.date}" onchange="updateDoc(doc(db,'orders','${o.id}'),{date:this.value})" class="bg-transparent text-xs w-full"></td>
                <td><div class="font-bold text-sm text-gray-800">${o.title}</div></td>
                <td><input type="number" value="${o.goal}" class="w-16 text-right border rounded px-1 text-xs" onchange="updateDoc(doc(db,'orders','${o.id}'),{goal:parseInt(this.value)})"></td>
                <td><input type="number" value="${o.packed||0}" class="w-16 text-right border rounded px-1 text-gray-400 text-xs" onchange="updateDoc(doc(db,'orders','${o.id}'),{packed:parseInt(this.value)})"></td>
                <td class="bg-blue-50 text-center font-bold text-blue-700 text-sm">${realGoal.toLocaleString()}</td>
                <td><div class="flex justify-between text-xs mb-1"><span>${o.done.toLocaleString()}</span><span class="text-blue-600 font-bold">${pct}%</span></div><div class="h-2 bg-gray-200 rounded overflow-hidden"><div class="h-full ${pct>=100?'bg-green-500':'bg-blue-500'}" style="width:${pct>100?100:pct}%"></div></div></td>
                <td class="text-center"><button onclick="deleteDoc(doc(db,'orders','${o.id}'))" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
            </tr>`; 
        }); 
    }

    // --- [2] ì‘ì—… (ì„¸íŠ¸ & ê³„ì‚°ê¸°) ---
    window.addWip = async () => { const name = document.getElementById('wipName').value; const qty = parseInt(document.getElementById('wipQty').value); if(!name||!qty) return alert("ì…ë ¥ í™•ì¸"); await addDoc(collection(db, "wip"), { name, qty, lot: 'ì¤€ë¹„' }); document.getElementById('wipQty').value=''; };
    window.deleteWip = async(id) => await deleteDoc(doc(db, "wip", id));
    window.doWork = async () => {
        const sel = document.getElementById('workProductSelect').value;
        const qty = parseInt(document.getElementById('workAmount').value);
        if(!sel||!qty) return alert("ì œí’ˆê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        // 1. í•„ë¦„ ì¬ê³  ì°¨ê°
        const set = wip.find(x => x.id == sel);
        if(set.qty < qty) return alert("í•„ë¦„(ì„¸íŠ¸) ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        if(set.qty - qty === 0) await deleteDoc(doc(db, "wip", sel)); 
        else await updateDoc(doc(db, "wip", sel), { qty: set.qty - qty });

        // 2. ë§¤í•‘ëœ í…Œì´í”„ ì¬ê³  ì°¨ê° (ìë™)
        const mapKey = Object.keys(mappings).find(k => set.name.includes(k));
        if(mapKey) {
            const rawName = mappings[mapKey].raw;
            const tapeKey = Object.keys(realMaterials).find(k => k === mapKey); // í…Œì´í”„ ì¬ê³  ì°¾ê¸°
            if(tapeKey && realMaterials[tapeKey]) {
                const currentTape = realMaterials[tapeKey].qty;
                await updateDoc(doc(db, "real_materials", tapeKey), { qty: Math.max(0, currentTape - qty) });
            }
        }

        // 3. ë°œì£¼ ì±„ìš°ê¸° (ë‚±ê°œ í™˜ì‚°)
        let pcsPerSheet = 1;
        if(mapKey) pcsPerSheet = mappings[mapKey].arr || 1;
        const totalPcs = qty * pcsPerSheet;
        
        let remain = totalPcs;
        const targets = orders.filter(o => o.title.includes(set.name) && o.done < (o.goal-(o.packed||0))).sort((a,b)=>new Date(a.date)-new Date(b.date));
        for(const o of targets) {
            if(remain <= 0) break;
            const realGoal = o.goal - (o.packed||0);
            const fill = Math.min(remain, realGoal - o.done);
            await updateDoc(doc(db, "orders", o.id), { done: o.done + fill });
            remain -= fill;
        }

        const msg = document.getElementById('workResultMsg');
        msg.innerHTML = `âœ… <b>${set.name}</b> ${qty}ì¥ ì‘ì—… ì™„ë£Œ.<br>(ì´ ${totalPcs}ê°œ ìƒì‚°, ë°œì£¼ ë°˜ì˜ë¨)`;
        msg.classList.remove('hidden');
        document.getElementById('workAmount').value='';
    };

    function renderWip() { 
        const list = document.getElementById('wipList'); const sel = document.getElementById('workProductSelect'); 
        list.innerHTML = ''; sel.innerHTML = '<option value="">(ì‘ì—…í•  í•„ë¦„ ì„ íƒ)</option>'; 
        wip.sort((a,b)=>a.name.localeCompare(b.name)).forEach(x => { 
            list.innerHTML += `<div class="bg-white border p-2 rounded text-sm flex justify-between items-center"><span><b>${x.name}</b> (${x.qty}ì¥)</span> <button onclick="deleteWip('${x.id}')" class="text-red-400 text-xs px-2">X</button></div>`; 
            sel.innerHTML += `<option value="${x.id}">${x.name} (${x.qty}ì¥)</option>`; 
        }); 
    }

    // --- [3] ì›ë‹¨ ë¡œì§ ---
    window.addRaw = async () => { 
        let type = document.getElementById('rawTypeSelect').value; 
        if(type === 'custom') type = document.getElementById('rawCustomInput').value.trim(); 
        const qty = parseInt(document.getElementById('rawQtyInput').value); 
        if(!type || !qty) return alert("í™•ì¸í•´ì£¼ì„¸ìš”"); 
        const ref = doc(db, "raw_materials", type); 
        const snap = await getDoc(ref); 
        await setDoc(ref, { qty: (snap.exists()?snap.data().qty:0) + qty }); 
        document.getElementById('rawQtyInput').value=''; 
    };
    
    function renderRaw() { 
        const tbody = document.getElementById('rawListBody'); tbody.innerHTML = ''; 
        Object.keys(rawMaterials).sort().forEach(k => { 
            tbody.innerHTML += `<tr><td class="font-bold text-gray-700">${k}</td><td class="text-right text-lg">${rawMaterials[k].qty}</td><td class="text-center text-xs text-gray-400">ë³´ê´€ì¤‘</td></tr>`; 
        }); 
    }

    // --- [4] ì‹¤ë¬´/ì¬ê³  (ìŠ¤ë§ˆíŠ¸ ì…ê³  ë¡œì§) ---
    window.addReal = async () => { 
        const name = document.getElementById('realNameInput').value.trim(); 
        const qty = parseInt(document.getElementById('realQtyInput').value); 
        if(!name||!qty) return alert("ì…ë ¥ í™•ì¸"); 

        // 1. ë§¤í•‘(ì¡±ë³´) ì°¾ê¸°
        const mapKey = Object.keys(mappings).find(k => name.includes(k)); 
        
        // 2. ì—°ê²°í•  ì›ë‹¨ ê²°ì •
        // (A) ë§¤í•‘ì— ìˆìœ¼ë©´ -> mappings[mapKey].raw
        // (B) ì—†ìœ¼ë©´ -> ì›ë‹¨ë¦¬ìŠ¤íŠ¸ì— ê°™ì€ ì´ë¦„ì´ ìˆëŠ”ì§€ í™•ì¸ (rawMaterials[name])
        let rawTarget = mapKey ? mappings[mapKey].raw : (rawMaterials[name] !== undefined ? name : null); 
        let skipDeduct = false;

        if (rawTarget) { 
            // ì—°ê²°ëœ ì›ë‹¨ì´ ìˆëŠ” ê²½ìš°
            const rawRef = doc(db, "raw_materials", rawTarget); 
            const rawSnap = await getDoc(rawRef); 
            const rawCur = rawSnap.exists() ? rawSnap.data().qty : 0; 
            
            if (rawCur < qty) { if(!confirm(`âš ï¸ ì›ë‹¨ [${rawTarget}] ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (${rawCur}ì¥).\nê·¸ë˜ë„ ë§ˆì´ë„ˆìŠ¤ë¡œ ì°¨ê°í•˜ê³  ì§„í–‰í• ê¹Œìš”?`)) return; } 
            
            await setDoc(rawRef, { qty: rawCur - qty }, { merge: true }); 
            alert(`âœ… ${name} ì…ê³  ì™„ë£Œ.\nğŸ“‰ ì›ë‹¨ [${rawTarget}] ${qty}ì¥ ì°¨ê°ë¨.`); 
        } else { 
            // [ì¤‘ìš”] ì—°ê²°ëœ ì›ë‹¨ì´ ì—†ëŠ” ê²½ìš° -> ì‚¬ìš©ì í™•ì¸
            if(confirm(`âš ï¸ [${name}] ì œí’ˆê³¼ ì—°ê²°ëœ ì›ë‹¨ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì›ë‹¨ ì¬ê³  ì°¨ê° ì—†ì´,\ní…Œì´í”„ ì¬ê³ ë§Œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                skipDeduct = true;
                alert(`âœ… ${name} ì…ê³  ì™„ë£Œ.\n(ì›ë‹¨ ì°¨ê° ì—†ìŒ)`);
            } else {
                return; // ì·¨ì†Œ
            }
        } 
        
        const realRef = doc(db, "real_materials", name); 
        const realSnap = await getDoc(realRef); 
        await setDoc(realRef, { qty: (realSnap.exists()?realSnap.data().qty:0) + qty }); 
        document.getElementById('realNameInput').value=''; document.getElementById('realQtyInput').value=''; 
    };

    function renderReal() { 
        const div = document.getElementById('realListBody'); div.innerHTML = ''; 
        Object.keys(realMaterials).sort().forEach(k => { 
            div.innerHTML += `<div class="bg-purple-50 border border-purple-100 p-3 rounded flex flex-col justify-between shadow-sm">
                <div class="flex justify-between items-start mb-2"><div class="font-bold text-purple-900">${k}</div><button onclick="deleteReal('${k}')" class="text-xs text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button></div>
                <div class="flex justify-between items-center"><span class="text-2xl font-bold text-purple-600">${realMaterials[k].qty}</span> <span class="text-xs text-gray-500">ì¥</span></div>
            </div>`; 
        }); 
    }
    window.deleteReal = async (id) => { if(confirm(`${id} ì¬ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) await deleteDoc(doc(db, "real_materials", id)); };

    // --- [5] ì‘ì—…ì¼ì§€ ---
    window.addLogRow = (room, data={}) => { 
        const tbody = document.getElementById(`body-${room}`); 
        const tr = document.createElement('tr'); 
        const { name='', prev=0, incoming=0, lot='', prod='', worker='', use=0, defect=0, curr=0, memo='' } = data; 
        tr.innerHTML = `
            <td><input type="text" class="log-input font-bold text-gray-700 text-left px-2" value="${name}"></td>
            <td><input type="number" class="log-input bg-gray-50" value="${prev}" oninput="calcRow(this)"></td>
            <td><input type="number" class="log-input text-blue-600 font-bold" value="${incoming}" placeholder="0" oninput="calcRow(this)"></td>
            <td><input type="text" class="log-input" value="${lot}"></td>
            <td><input type="text" class="log-input" value="${prod}"></td>
            <td><input type="text" class="log-input" value="${worker}"></td>
            <td><input type="number" class="log-input text-red-600" value="${use}" placeholder="0" oninput="calcRow(this)"></td>
            <td><input type="number" class="log-input text-red-400" value="${defect}" placeholder="0" oninput="calcRow(this)"></td>
            <td class="bg-blue-50 font-bold text-gray-800 text-center align-middle"><span class="curr-val">${curr}</span></td>
            <td><input type="text" class="log-input text-left px-2 text-xs" value="${memo}"></td>
            <td class="text-center"><button onclick="this.closest('tr').remove()" class="text-red-300 hover:text-red-600 font-bold">X</button></td>`; 
        tbody.appendChild(tr); calcRow(tr.querySelector('input')); 
    };
    
    window.calcRow = (input) => { 
        const tr = input.closest('tr'); const inputs = tr.querySelectorAll('input'); 
        const curr = (parseInt(inputs[1].value)||0) + (parseInt(inputs[2].value)||0) - (parseInt(inputs[6].value)||0) - (parseInt(inputs[7].value)||0); 
        tr.querySelector('.curr-val').innerText = curr; 
    };
    
    window.saveLogData = async () => { 
        const date = document.getElementById('logDate').value; 
        if(!date) return alert("ë‚ ì§œ ì„ íƒ!"); 
        const getData = (room) => Array.from(document.querySelectorAll(`#body-${room} tr`)).map(tr => { const i = tr.querySelectorAll('input'); return { name: i[0].value, prev: i[1].value, incoming: i[2].value, lot: i[3].value, prod: i[4].value, worker: i[5].value, use: i[6].value, defect: i[7].value, curr: tr.querySelector('.curr-val').innerText, memo: i[9].value }; }).filter(d=>d.name); 
        await setDoc(doc(db, "work_logs", date), { date, hansung: getData('hansung'), taeseong: getData('taeseong') }); 
        alert(`ğŸ“… ${date} ì¼ì§€ ì €ì¥ ì™„ë£Œ!`); 
    };
    
    window.loadLogData = async () => { 
        const date = document.getElementById('logDate').value; 
        document.getElementById('body-hansung').innerHTML = ''; document.getElementById('body-taeseong').innerHTML = ''; 
        const docSnap = await getDoc(doc(db, "work_logs", date)); 
        
        // ì •ë ¬ í•¨ìˆ˜ (ë§¤í•‘ì˜ order ê¸°ì¤€)
        const sorter = (arr) => arr.sort((a,b) => (mappings[a.name]?.order||99) - (mappings[b.name]?.order||99));

        if (docSnap.exists()) { 
            const d = docSnap.data(); 
            sorter(d.hansung).forEach(r => addLogRow('hansung', r)); 
            sorter(d.taeseong).forEach(r => addLogRow('taeseong', r)); 
        } else { 
            // ì´ì „ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ìë™ ì„¸íŒ…)
            const prevQ = query(collection(db, "work_logs"), where("date", "<", date), orderBy("date", "desc"), limit(1)); 
            const prevSnaps = await getDocs(prevQ); 
            let prevData = { hansung: [], taeseong: [] };
            if(!prevSnaps.empty) prevData = prevSnaps.docs[0].data();

            // ë§¤í•‘ì— ìˆëŠ” ëª¨ë“  ì œí’ˆì„ ìˆœì„œëŒ€ë¡œ ë¡œë“œ
            const keys = Object.keys(mappings).sort((a,b)=>(mappings[a].order||99)-(mappings[b].order||99));
            keys.forEach(k => {
                const room = mappings[k].room;
                const lastRec = prevData[room].find(r => r.name === k);
                const startStock = lastRec ? lastRec.curr : 0;
                addLogRow(room, { name: k, prev: startStock });
            });
        } 
    };

    // --- [6] í¬ì¥ ---
    window.addPacking = async () => { const name = document.getElementById('packName').value.trim(); const qty = parseInt(document.getElementById('packQty').value); if(!name || !qty) return alert("ì…ë ¥ í™•ì¸"); const targets = orders.filter(o => o.title.includes(name) && o.done < o.goal).sort((a,b)=>new Date(a.date)-new Date(b.date)); let remain = qty; for(const o of targets) { if(remain <= 0) break; const needed = o.goal - o.done; const fill = Math.min(remain, needed); await updateDoc(doc(db, "orders", o.id), { done: o.done + fill }); remain -= fill; } if(remain > 0) { const q = query(collection(db, "packing"), where("name", "==", name)); const querySnapshot = await getDocs(q); if(!querySnapshot.empty) { const docId = querySnapshot.docs[0].id; await updateDoc(doc(db, "packing", docId), { qty: querySnapshot.docs[0].data().qty + remain }); } else { await addDoc(collection(db, "packing"), { name: name, qty: remain }); } alert(`âœ… ì´ ${qty}ê°œ ì²˜ë¦¬.\n(ë°œì£¼ ì°¨ê° í›„ ì”ì—¬ ${remain}ê°œ í¬ì¥ì‹¤ ë³´ê´€)`); } else { alert("âœ… ì „ëŸ‰ ë°œì£¼ ëª©í‘œì— ì‚¬ìš©ë¨."); } document.getElementById('packName').value = ''; document.getElementById('packQty').value = ''; };
    
    function renderPacking() { const tbody = document.getElementById('packListBody'); tbody.innerHTML = ''; packing.forEach(p => { tbody.innerHTML += `<tr class="border-b"><td class="p-3 font-bold text-gray-700">${p.name}</td><td class="p-3 text-right font-mono text-blue-600 font-bold">${p.qty.toLocaleString()}</td><td class="p-3 text-center"><button onclick="deleteDoc(doc(db,'packing','${p.id}'))" class="text-red-400 text-sm">ì‚­ì œ</button></td></tr>`; }); }

    // --- ìœ í‹¸ë¦¬í‹° ---
    function updateRawSelect() { 
        const html = '<option value="">(ì„ íƒ)</option>' + Object.keys(rawMaterials).sort().map(k=>`<option value="${k}">${k}</option>`).join('') + '<option value="custom">ì§ì ‘ì…ë ¥</option>'; 
        document.getElementById('rawTypeSelect').innerHTML = html; document.getElementById('mapRaw').innerHTML = html; 
    }
    function updateDataList() { 
        document.getElementById('realSuggestions').innerHTML = Object.keys(mappings).map(k=>`<option value="${k}">`).join(''); 
        document.getElementById('calcProduct').innerHTML = '<option value="">(ì„ íƒ)</option>' + Object.keys(mappings).sort().map(k=>`<option value="${k}">${k}</option>`).join(''); 
    }
    
    // ê³„ì‚°ê¸° ë¡œì§
    document.getElementById('calcTarget').addEventListener('input', function() { 
        const key = document.getElementById('calcProduct').value; const target = parseInt(this.value)||0; 
        if(key && target) { const m = mappings[key]; const needed = Math.ceil(target / (m.arr||1)); document.getElementById('calcResult').innerHTML = `ì•½ <span class="text-red-600 text-3xl">${needed}</span> ì¥ (${m.raw})`; } 
    });

    // íƒ­ ì „í™˜
    const tabs = ['setTab', 'orderTab', 'workTab', 'rawTab', 'realTab', 'logTab', 'packTab'];
    tabs.forEach(t => document.getElementById('btn-'+t).addEventListener('click', ()=>{ 
        tabs.forEach(x => { document.getElementById(x).classList.add('hidden'); document.getElementById('btn-'+x).classList.remove('active'); }); 
        document.getElementById(t).classList.remove('hidden'); document.getElementById('btn-'+t).classList.add('active'); 
    }));

    // ì§ì ‘ì…ë ¥ í† ê¸€
    ['rawTypeSelect', 'mapRaw'].forEach(id => document.getElementById(id).addEventListener('change', function(){ 
        const target = document.getElementById(id === 'mapRaw' ? 'mapRawCustom' : 'rawCustomInput'); 
        if(this.value==='custom') { target.classList.remove('hidden'); target.focus(); } else target.classList.add('hidden'); 
    }));

    // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
    Object.assign(window, { seedMappings, addMapping, deleteMapping, addOrder, addWip, deleteWip, addRaw, addReal, deleteReal, doWork, addLogRow, calcRow, saveLogData, loadLogData, addPacking, updateDoc, doc, db, deleteDoc });
    
    // ì´ˆê¸°í™”
    document.getElementById('inputDate').valueAsDate = new Date();
    document.getElementById('logDate').valueAsDate = new Date();
    setTimeout(() => window.loadLogData(), 1500);

</script>
</body>
</html>
