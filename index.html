<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - Custom Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif; background-color: #f1f5f9; padding: 20px; }
        .tab-btn { padding: 10px 15px; font-weight: bold; color: #64748b; border-bottom: 3px solid transparent; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { color: #2563eb; border-bottom: 3px solid #2563eb; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { border: 1px solid #cbd5e1; padding: 6px; border-radius: 4px; width: 100%; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th { background: #f1f5f9; color: #334155; padding: 8px; text-align: center; border: 1px solid #e2e8f0; font-weight: 800; }
        td { padding: 0; border: 1px solid #e2e8f0; vertical-align: middle; height: 36px; }
        
        .log-input { width: 100%; height: 100%; border: none; text-align: center; background: transparent; outline: none; }
        .log-input:focus { background: #e0f2fe; }
        .readonly { background-color: #f8fafc; color: #64748b; font-weight: bold; pointer-events: none; }
        .hidden { display: none; }
        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:9999; flex-direction: column;}
    </style>
</head>
<body class="max-w-[1600px] mx-auto">

    <div id="loading">
        <div class="text-3xl font-bold text-blue-600 mb-2">TAPE KEEPER</div>
        <div class="text-sm text-gray-500">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-2">
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">TAPE KEEPER</h1>
            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold shadow-sm">â— ì˜¨ë¼ì¸</span>
        </div>
        <div class="flex space-x-1 bg-white px-2 rounded-lg shadow-sm overflow-x-auto w-full md:w-auto">
            <button id="btn-orderTab" class="tab-btn active">1. ë°œì£¼ ê´€ë¦¬</button>
            <button id="btn-workTab" class="tab-btn">2. ì„¸íŠ¸ ì‘ì—…</button>
            <button id="btn-rawTab" class="tab-btn text-pink-600">3. ì›ë‹¨ ìì¬</button>
            <button id="btn-realTab" class="tab-btn text-indigo-600">4. ì‹¤ë¬´/ì„¤ì •</button>
            <button id="btn-logTab" class="tab-btn text-blue-700 bg-blue-50">5. ì‘ì—…ì¼ì§€</button>
            <button id="btn-packTab" class="tab-btn text-amber-600 bg-amber-50">6. í¬ì¥ì‹¤ ì¬ê³ </button>
        </div>
    </div>

    <div id="orderTab">
        <div class="card">
            <h2 class="text-lg font-bold mb-4">ğŸ“ ë°œì£¼ ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div><label class="text-xs text-gray-500">ë‚©ê¸°ì¼</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">ë°œì£¼ëª…</label><input type="text" id="inputTitle" placeholder="ì˜ˆ: 7125Y 2000ê°œ"></div>
                <div><label class="text-xs text-gray-500">ëª©í‘œ ìˆ˜ëŸ‰</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500">ë¹„ê³ </label><input type="text" id="inputMemo" placeholder="íŠ¹ì´ì‚¬í•­"></div>
            </div>
            <button id="btnAddOrder" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">ë°œì£¼ ì¶”ê°€</button>
        </div>
        <div class="card">
            <h2 class="text-lg font-bold mb-4">ğŸ“‹ ë°œì£¼ í˜„í™©</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead><tr><th style="width:120px;">ë‚©ê¸°</th><th>ë°œì£¼ëª…</th><th style="width:100px;">ëª©í‘œ</th><th style="width:150px;">ì§„í–‰ë¥ </th><th style="width:60px;">ì‚­ì œ</th></tr></thead>
                    <tbody id="orderListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="workTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-indigo-500">
                <h2 class="text-lg font-bold mb-4 text-indigo-900">ğŸ“¦ ì„¸íŠ¸(LOT) ë“±ë¡</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-xs text-gray-500">ì œí’ˆëª…</label><input type="text" id="wipName" placeholder="ì˜ˆ: 7125Y"></div>
                        <div><label class="text-xs text-gray-500">ì„¸íŠ¸(LOT)</label><input type="text" id="wipLot" placeholder="ì˜ˆ: A-1"></div>
                    </div>
                    <div><label class="text-xs text-gray-500">ìˆ˜ëŸ‰ (EA)</label><input type="number" id="wipQty" placeholder="0"></div>
                    <button id="btnAddWip" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">ì„¸íŠ¸ ì¶”ê°€</button>
                </div>
                <div class="mt-4"><h3 class="text-sm font-bold text-gray-600 mb-2">ëŒ€ê¸° ëª©ë¡</h3><div id="wipList" class="space-y-2 max-h-60 overflow-y-auto"></div></div>
            </div>
            <div class="card border-t-4 border-green-500">
                <h2 class="text-lg font-bold mb-4 text-green-900">ğŸš€ ì‘ì—… ì‹¤í–‰</h2>
                <div class="space-y-4">
                    <div><label class="text-xs text-gray-500 font-bold">1. ì‘ì—…í•  ì„¸íŠ¸</label><select id="workProductSelect" class="bg-gray-50 border-2 border-green-200 p-2 rounded w-full"></select></div>
                    <div><label class="text-xs text-gray-500 font-bold">2. ì‘ì—… ìˆ˜ëŸ‰ (EA)</label><input type="number" id="workAmount" placeholder="0" class="border-2 border-green-200 focus:border-green-500 p-2 rounded w-full"></div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><div id="predictionBox" class="text-xs text-gray-500">ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div></div>
                    <button id="btnDoWork" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg shadow-md">ì‘ì—… ì™„ë£Œ</button>
                    <div id="workResultMsg" class="p-3 bg-green-50 text-green-800 text-sm font-bold rounded text-center hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="rawTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-1 border-t-4 border-pink-500">
                <h2 class="text-lg font-bold mb-4 text-pink-900">ğŸ“¥ ì›ë‹¨ ì…ê³  (ë¡¤ ë‹¨ìœ„)</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500">ê·œê²© (ì½”ë“œ)</label>
                        <select id="rawTypeSelect" class="bg-white border-pink-200">
                            <option value="">(ì„ íƒí•˜ì„¸ìš”)</option>
                            <option value="450x237 (6855)">450x237 (6855)</option>
                            <option value="470x130 (6405)">470x130 (6405)</option>
                            <option value="470x130 (6406)">470x130 (6406)</option>
                            <option value="510x295 (RR7000)">510x295 (RR7000)</option>
                            <option value="410x315 (5869)">410x315 (5869)</option>
                            <option value="450x120 (6491)">450x120 (6491)</option>
                            <option value="470x237 (4195)">470x237 (4195)</option>
                            <option value="195x385 (4221)">195x385 (4221)</option>
                            <option value="550x315 (7011)">550x315 (7011)</option>
                            <option value="510x195 (6934)">510x195 (6934)</option>
                            <option value="custom">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
                        </select>
                        <input type="text" id="rawCustomInput" class="mt-2 hidden bg-pink-50" placeholder="ì˜ˆ: 300x300 (ì‹ ê·œ)">
                    </div>
                    <div><label class="text-xs text-gray-500">ì…ê³  ìˆ˜ëŸ‰ (ì¥)</label><input type="number" id="rawQtyInput" placeholder="0"></div>
                    <button id="btnAddRaw" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 rounded-lg">ì›ë‹¨ ì¶”ê°€</button>
                </div>
            </div>
            <div class="card lg:col-span-2">
                <h2 class="text-lg font-bold mb-4">ğŸ“Š ì›ë‹¨ ì¬ê³  í˜„í™©</h2>
                <div class="overflow-x-auto">
                    <table><thead><tr><th>ê·œê²© (ì½”ë“œ)</th><th class="text-right">ì¬ê³  (ì¥)</th><th class="text-center">ìƒíƒœ</th></tr></thead><tbody id="rawListBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="realTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-1 border-t-4 border-purple-500">
                <h2 class="text-lg font-bold mb-4 text-purple-900">âœ‚ï¸ ì‹¤ë¬´(ì»·íŒ…) ì…ê³ </h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500">í’ˆëª©ëª… (í‚¤ì›Œë“œ)</label>
                        <input type="text" id="realNameInput" placeholder="ì˜ˆ: ê¹€ì¹˜(ìš°)" list="realSuggestions">
                        <datalist id="realSuggestions"></datalist>
                    </div>
                    <div><label class="text-xs text-gray-500">ì…ê³  ìˆ˜ëŸ‰ (ì¥)</label><input type="number" id="realQtyInput" placeholder="0"></div>
                    <button id="btnAddReal" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded-lg">ì‹¤ë¬´ ì…ê³  (ì›ë‹¨ ì°¨ê°)</button>
                </div>
            </div>
            <div class="card lg:col-span-2">
                <h2 class="text-lg font-bold mb-4">ğŸ§º ì‹¤ë¬´ ì¬ê³  í˜„í™©</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="realListBody"></div>
            </div>
        </div>
        <div class="card border-t-4 border-gray-600 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">âš™ï¸ ë§¤í•‘/ê·œê²©/ìˆœì„œ ì„¤ì •</h2>
                <button onclick="resetRules()" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200">ğŸ”„ ê¸°ë³¸ ê·œì¹™ìœ¼ë¡œ ì´ˆê¸°í™”</button>
            </div>
            <div class="p-3 bg-gray-100 rounded text-sm text-gray-700 mb-2">
                * <b>ìˆœì„œ(No.)</b> ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ì‘ì—…ì¼ì§€ì—ì„œ ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤. (1 -> 2 -> 3 ...)
            </div>
            <div class="flex flex-col md:flex-row gap-2 mb-4 p-4 bg-gray-50 rounded">
                <div class="flex-none w-24">
                    <label class="text-xs text-gray-500">ìœ„ì¹˜</label>
                    <select id="mapRoom" class="bg-white border border-gray-300 rounded px-2 font-bold text-gray-700">
                        <option value="hansung">í•œì„±</option><option value="taeseong">íƒœì„±</option>
                    </select>
                </div>
                <div class="flex-none w-16">
                    <label class="text-xs text-gray-500">ìˆœì„œ(No.)</label>
                    <input type="number" id="mapOrder" placeholder="1" class="border border-gray-300 rounded text-center">
                </div>
                <div class="flex-1">
                    <label class="text-xs text-gray-500">ì‹¤ë¬´ ì´ë¦„</label>
                    <input type="text" id="mapKey" placeholder="ì˜ˆ: 6855" class="border border-gray-300 rounded">
                </div>
                <div class="flex-1">
                    <label class="text-xs text-gray-500">ì—°ê²° ì›ë‹¨</label>
                    <div class="flex flex-col">
                        <select id="mapRaw" class="w-full bg-white h-[34px] border rounded px-2">
                            <option value="450x237 (6855)">450x237 (6855)</option>
                            <option value="470x130 (6405)">470x130 (6405)</option>
                            <option value="470x130 (6406)">470x130 (6406)</option>
                            <option value="510x295 (RR7000)">510x295 (RR7000)</option>
                            <option value="410x315 (5869)">410x315 (5869)</option>
                            <option value="450x120 (6491)">450x120 (6491)</option>
                            <option value="470x237 (4195)">470x237 (4195)</option>
                            <option value="195x385 (4221)">195x385 (4221)</option>
                            <option value="550x315 (7011)">550x315 (7011)</option>
                            <option value="510x195 (6934)">510x195 (6934)</option>
                            <option value="custom">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
                        </select>
                        <input type="text" id="mapRawCustom" class="hidden w-full mt-1 border rounded px-2 h-[34px]" placeholder="ì—°ê²°í•  ì›ë‹¨ ì´ë¦„">
                    </div>
                </div>
                <div class="flex-none w-16">
                    <label class="text-xs text-gray-500">ë°°ì—´</label>
                    <input type="number" id="mapArr" placeholder="1" class="border border-gray-300 rounded text-center">
                </div>
                <div class="flex-none w-16 flex items-end">
                    <button id="btnAddMap" class="bg-gray-700 text-white px-3 py-2 rounded font-bold w-full h-[34px]">ì¶”ê°€</button>
                </div>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="p-2 text-center">ìœ„ì¹˜</th><th class="p-2 text-center">No.</th><th class="p-2 text-left">ì‹¤ë¬´ ì´ë¦„</th><th class="p-2 text-left">ì—°ê²° ì›ë‹¨</th><th class="p-2 text-center">ë°°ì—´</th><th class="p-2 text-center">ê´€ë¦¬</th></tr></thead><tbody id="mapListBody"></tbody></table></div>
        </div>
    </div>

    <div id="logTab" class="hidden">
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm border border-blue-100">
            <div class="flex items-center gap-4">
                <label class="font-bold text-gray-700 text-lg">ğŸ“… ì‘ì—…ì¼ì:</label>
                <input type="date" id="logDate" class="border-2 border-blue-300 p-2 rounded-lg shadow-sm text-lg font-bold text-blue-800 cursor-pointer" onchange="loadLogData()">
            </div>
            <div class="flex gap-2">
                <button onclick="loadLogData()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-200">ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="saveLogData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg">ğŸ’¾ ì¼ì§€ ì €ì¥</button>
            </div>
        </div>
        <div class="card border-t-4 border-green-500 mb-8"><h2 class="text-xl font-bold text-green-900 mb-3 flex items-center gap-2"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">ë³¸ê´€</span> í•œì„± ê°€ê³µì‹¤ <button onclick="addLogRow('hansung')" class="ml-auto text-sm border px-2 py-1 rounded">+ í–‰ ì¶”ê°€</button></h2><div class="overflow-x-auto"><table class="w-full border-2 border-green-100"><thead><tr class="bg-green-50 text-green-900"><th style="width:120px">ì œí’ˆëª…</th><th style="width:80px">ì „ì¬ê³ </th><th style="width:80px" class="text-blue-600">ì…ê³ </th><th style="width:80px">ë°œì‹ LOT</th><th style="width:100px">ì¢…ìˆ˜ëŸ‰</th><th style="width:80px">ì‘ì—…ì</th><th style="width:80px">ì†Œìš”ëŸ‰</th><th style="width:80px">ë¶ˆëŸ‰</th><th style="width:80px" class="bg-green-100">í˜„ì¬ê³ </th><th>ë¹„ê³ </th><th style="width:40px">X</th></tr></thead><tbody id="body-hansung"></tbody></table></div></div>
        <div class="card border-t-4 border-blue-500"><h2 class="text-xl font-bold text-blue-900 mb-3 flex items-center gap-2"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm">ë³„ê´€</span> íƒœì„± ê°€ê³µì‹¤ <button onclick="addLogRow('taeseong')" class="ml-auto text-sm border px-2 py-1 rounded">+ í–‰ ì¶”ê°€</button></h2><div class="overflow-x-auto"><table class="w-full border-2 border-blue-100"><thead><tr class="bg-blue-50 text-blue-900"><th style="width:120px">ì œí’ˆëª…</th><th style="width:80px">ì „ì¬ê³ </th><th style="width:80px" class="text-blue-600">ì…ê³ </th><th style="width:80px">ë°œì‹ LOT</th><th style="width:100px">ì¢…ìˆ˜ëŸ‰</th><th style="width:80px">ì‘ì—…ì</th><th style="width:80px">ì†Œìš”ëŸ‰</th><th style="width:80px">ë¶ˆëŸ‰</th><th style="width:80px" class="bg-blue-100">í˜„ì¬ê³ </th><th>ë¹„ê³ </th><th style="width:40px">X</th></tr></thead><tbody id="body-taeseong"></tbody></table></div></div>
    </div>

    <div id="packTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-amber-500">
                <h2 class="text-lg font-bold mb-4 text-amber-900">ğŸ ì™„ì œí’ˆ(í¬ì¥ì‹¤) ì¬ê³  ë“±ë¡</h2>
                <div class="p-4 bg-amber-50 text-amber-800 text-sm rounded mb-4">ì—¬ê¸°ì— ì¬ê³ ë¥¼ ë“±ë¡í•˜ë©´, <b>ê°€ì¥ ê¸‰í•œ ë°œì£¼ë¶€í„° ìë™ìœ¼ë¡œ ì°¨ê°(ì™„ë£Œ ì²˜ë¦¬)</b>ë©ë‹ˆë‹¤.</div>
                <div class="flex gap-2 mb-4"><div class="flex-1"><label class="text-xs text-gray-500 font-bold">ì œí’ˆëª…</label><input type="text" id="packName" placeholder="ì˜ˆ: 7125Y" list="realSuggestions" class="border-2 border-amber-200"></div><div class="w-32"><label class="text-xs text-gray-500 font-bold">ìˆ˜ëŸ‰(EA)</label><input type="number" id="packQty" placeholder="0" class="border-2 border-amber-200"></div></div>
                <button onclick="addPacking()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow-md">ì¬ê³  ë“±ë¡ ë° ë°œì£¼ ì°¨ê°</button>
            </div>
            <div class="card lg:col-span-2"><h2 class="text-lg font-bold mb-4">ğŸ“¦ í¬ì¥ì‹¤ ì”ì—¬ ì¬ê³  í˜„í™©</h2><div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-100"><th class="text-left p-3">ì œí’ˆëª…</th><th class="text-right p-3">ì”ì—¬ ìˆ˜ëŸ‰ (EA)</th><th class="text-center p-3">ê´€ë¦¬</th></tr></thead><tbody id="packListBody"></tbody></table></div></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, getDoc, setDoc, writeBatch, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAkMFlhE-19SvNS6XeHqTAHM3UTHHLb9Ww",
        authDomain: "tapekeeper-8070e.firebaseapp.com",
        projectId: "tapekeeper-8070e",
        storageBucket: "tapekeeper-8070e.firebasestorage.app",
        messagingSenderId: "267507609999",
        appId: "1:267507609999:web:889761a8792b0fa1a6dbfa",
        measurementId: "G-B68XN789S1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let orders = [], wip = [], rawMaterials = {}, realMaterials = {}, mappings = {}, packing = [];

    // --- ë¦¬ìŠ¤ë„ˆ ---
    onSnapshot(query(collection(db, "orders")), (snap) => { orders = snap.docs.map(d => ({id:d.id, ...d.data()})); renderOrders(); document.getElementById('loading').style.display='none'; });
    onSnapshot(query(collection(db, "wip")), (snap) => { wip = snap.docs.map(d => ({id:d.id, ...d.data()})); renderWip(); });
    onSnapshot(query(collection(db, "raw_materials")), (snap) => { rawMaterials={}; snap.docs.forEach(d=>{rawMaterials[d.id]=d.data()}); renderRaw(); });
    onSnapshot(query(collection(db, "real_materials")), (snap) => { realMaterials={}; snap.docs.forEach(d=>{realMaterials[d.id]=d.data()}); renderReal(); });
    onSnapshot(query(collection(db, "packing")), (snap) => { packing = snap.docs.map(d => ({id:d.id, ...d.data()})); renderPacking(); });
    onSnapshot(query(collection(db, "mappings")), (snap) => { 
        mappings={}; snap.docs.forEach(d=>{mappings[d.id]=d.data()}); 
        if(Object.keys(mappings).length===0) seedMappings(); else { renderMappings(); updateDataList(); }
    });

    // --- ê¸°ë³¸ í•¨ìˆ˜ë“¤ (ì´ì „ê³¼ ë™ì¼) ---
    window.addOrder = async () => { const date = document.getElementById('inputDate').value; const title = document.getElementById('inputTitle').value; const goal = parseInt(document.getElementById('inputGoal').value); if(!date || !title || !goal) return alert("ì…ë ¥ í™•ì¸"); await addDoc(collection(db, "orders"), { date, title, goal, memo: document.getElementById('inputMemo').value, done: 0 }); document.getElementById('inputTitle').value=''; document.getElementById('inputGoal').value=''; };
    window.deleteOrder = async(id) => { if(confirm('ì‚­ì œ?')) await deleteDoc(doc(db, "orders", id)); };
    window.updateOrder = async(id, f, v) => await updateDoc(doc(db, "orders", id), {[f]: f==='goal'?parseInt(v):v});
    window.addWip = async () => { const name = document.getElementById('wipName').value; const lot = document.getElementById('wipLot').value; const qty = parseInt(document.getElementById('wipQty').value); if(!name || !lot || !qty) return alert("ì…ë ¥ í™•ì¸"); await addDoc(collection(db, "wip"), { name, lot, qty }); document.getElementById('wipQty').value=''; };
    window.deleteWip = async(id) => await deleteDoc(doc(db, "wip", id));
    window.addRaw = async () => { let type = document.getElementById('rawTypeSelect').value; if(type === 'custom') type = document.getElementById('rawCustomInput').value; const qty = parseInt(document.getElementById('rawQtyInput').value); if(!type || !qty) return alert("ì…ë ¥ í™•ì¸"); const ref = doc(db, "raw_materials", type); const snap = await getDoc(ref); const cur = snap.exists() ? snap.data().qty : 0; await setDoc(ref, { qty: cur + qty }); document.getElementById('rawQtyInput').value=''; };
    window.updateRaw = async(id, v) => await updateDoc(doc(db, "raw_materials", id), { qty: parseInt(v) });
    window.addReal = async () => { const name = document.getElementById('realNameInput').value.trim(); const qty = parseInt(document.getElementById('realQtyInput').value); if(!name || !qty) return alert("ì…ë ¥ í™•ì¸"); const mapKey = Object.keys(mappings).find(k => name.includes(k)); let rawTarget = mapKey ? mappings[mapKey].raw : (rawMaterials[name] !== undefined ? name : null); if (rawTarget) { const rawRef = doc(db, "raw_materials", rawTarget); const rawSnap = await getDoc(rawRef); const rawCur = rawSnap.exists() ? rawSnap.data().qty : 0; const rawNeeded = qty; if (rawCur < rawNeeded) { if(!confirm(`ì›ë‹¨ [${rawTarget}] ì¬ê³  ë¶€ì¡±! (ë³´ìœ : ${rawCur})\në¬´ì‹œí•˜ê³  ì§„í–‰?`)) return; } await setDoc(rawRef, { qty: Math.max(0, rawCur - rawNeeded) }, { merge: true }); alert(`âœ… ${name} ì…ê³ .\nğŸ“‰ ì›ë‹¨ [${rawTarget}] ${rawNeeded}ì¥ ì°¨ê°.`); } else { alert(`âœ… ${name} ì…ê³ .\n(ë§¤ì¹­ ì›ë‹¨ ì—†ìŒ)`); } const realRef = doc(db, "real_materials", name); const realSnap = await getDoc(realRef); const realCur = realSnap.exists() ? realSnap.data().qty : 0; await setDoc(realRef, { qty: realCur + qty }); document.getElementById('realNameInput').value=''; document.getElementById('realQtyInput').value=''; };
    window.updateReal = async(id, v) => await updateDoc(doc(db, "real_materials", id), { qty: parseInt(v) });
    window.deleteReal = async (id) => { if(!confirm(`'${id}' í•­ëª© ì‚­ì œ ë° ì›ë‹¨ ë°˜í™˜?`)) return; const realRef = doc(db, "real_materials", id); const realSnap = await getDoc(realRef); if (!realSnap.exists()) return; const qtyToRestore = realSnap.data().qty; const mapKey = Object.keys(mappings).find(k => id.includes(k)); let rawTarget = mapKey ? mappings[mapKey].raw : (rawMaterials[id] !== undefined ? id : null); if (rawTarget) { const rawRef = doc(db, "raw_materials", rawTarget); const rawSnap = await getDoc(rawRef); if (rawSnap.exists()) { const currentRaw = rawSnap.data().qty; await updateDoc(rawRef, { qty: currentRaw + qtyToRestore }); alert(`ğŸ”„ ì›ë‹¨ [${rawTarget}]ì— ${qtyToRestore}ì¥ ë°˜í™˜ë¨.`); } } await deleteDoc(realRef); };
    window.doWork = async () => { const sel = document.getElementById('workProductSelect').value; const qty = parseInt(document.getElementById('workAmount').value); if(!sel || !qty) return alert("ì…ë ¥ í™•ì¸"); const set = wip.find(x => x.id == sel); if(set.qty < qty) return alert("ì„¸íŠ¸ ì¬ê³  ë¶€ì¡±"); if(set.qty - qty === 0) await deleteDoc(doc(db, "wip", sel)); else await updateDoc(doc(db, "wip", sel), { qty: set.qty - qty }); let remain = qty; const targets = orders.filter(o => o.title.includes(set.name) && o.done < o.goal).sort((a,b)=>new Date(a.date)-new Date(b.date)); for(const o of targets) { if(remain <= 0) break; const fill = Math.min(remain, o.goal - o.done); await updateDoc(doc(db, "orders", o.id), { done: o.done + fill }); remain -= fill; } document.getElementById('workResultMsg').innerText = `ì™„ë£Œ! ${set.name} ${qty}ê°œ ì²˜ë¦¬ë¨.`; document.getElementById('workResultMsg').classList.remove('hidden'); document.getElementById('workAmount').value=''; window.autoMatchInfo(); };
    window.autoMatchInfo = () => { const sel = document.getElementById('workProductSelect').value; const box = document.getElementById('predictionBox'); if(!sel) { box.innerText="ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”"; return; } const set = wip.find(x => x.id == sel); const targets = orders.filter(o => o.title.includes(set.name) && o.done < o.goal).sort((a,b)=>new Date(a.date)-new Date(b.date)); if(targets.length > 0) box.innerText = `[${targets[0].date} ${targets[0].title}] ë°œì£¼ë¡œ ë°°ë¶„ë©ë‹ˆë‹¤.`; else box.innerText = "ë§¤ì¹­ë˜ëŠ” ë°œì£¼ê°€ ì—†ìŠµë‹ˆë‹¤ (ì¬ê³ ë§Œ ì°¨ê°)"; };
    window.addPacking = async () => { const name = document.getElementById('packName').value.trim(); const qty = parseInt(document.getElementById('packQty').value); if(!name || !qty) return alert("ì…ë ¥ í™•ì¸"); const targets = orders.filter(o => o.title.includes(name) && o.done < o.goal).sort((a,b)=>new Date(a.date)-new Date(b.date)); let remain = qty; for(const o of targets) { if(remain <= 0) break; const needed = o.goal - o.done; const fill = Math.min(remain, needed); await updateDoc(doc(db, "orders", o.id), { done: o.done + fill }); remain -= fill; } if(remain > 0) { const q = query(collection(db, "packing"), where("name", "==", name)); const querySnapshot = await getDocs(q); if(!querySnapshot.empty) { const docId = querySnapshot.docs[0].id; const currentQty = querySnapshot.docs[0].data().qty; await updateDoc(doc(db, "packing", docId), { qty: currentQty + remain }); } else { await addDoc(collection(db, "packing"), { name: name, qty: remain }); } alert(`âœ… ì´ ${qty}ê°œ ì²˜ë¦¬ ì™„ë£Œ.\n- ë°œì£¼ ì°¨ê°: ${qty - remain}ê°œ\n- í¬ì¥ì‹¤ ì”ì—¬ ë³´ê´€: ${remain}ê°œ`); } else { alert(`âœ… ${qty}ê°œ ì „ëŸ‰ ë°œì£¼ ëª©í‘œ ë‹¬ì„±ì— ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`); } document.getElementById('packName').value = ''; document.getElementById('packQty').value = ''; };
    window.deletePacking = async (id) => { if(confirm("ì‚­ì œ?")) await deleteDoc(doc(db, "packing", id)); };

    // --- [ìˆœì„œ ì„¤ì • í¬í•¨ëœ ë§¤í•‘ ë¡œì§] ---
    async function seedMappings() {
        const defaults = {
            "6084": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 1 },
            "6934": { raw: "510x195 (6934)", arr: 4, room: "hansung", order: 2 },
            "5869": { raw: "410x315 (5869)", arr: 4, room: "hansung", order: 3 },
            "4355": { raw: "custom", arr: 1, room: "hansung", order: 4 },
            "4195": { raw: "470x237 (4195)", arr: 4, room: "hansung", order: 5 },
            "7011": { raw: "550x315 (7011)", arr: 1, room: "hansung", order: 6 },
            "6855": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 7 },
            "4221": { raw: "195x385 (4221)", arr: 4, room: "hansung", order: 8 },
            "3538A íë§": { raw: "custom", arr: 1, room: "hansung", order: 9 },
            "SPIN": { raw: "custom", arr: 1, room: "hansung", order: 10 },
            "ê³µì²­ê¸°": { raw: "custom", arr: 1, room: "hansung", order: 11 },
            "ê³ ë°ê¸°": { raw: "custom", arr: 1, room: "hansung", order: 12 },
            "íŒŒì¢…ê¸°": { raw: "custom", arr: 1, room: "hansung", order: 13 },
            "ê¹€ì¹˜(ì¢Œ)": { raw: "510x295 (RR7000)", arr: 2, room: "taeseong", order: 1 },
            "ê¹€ì¹˜(ìš°)": { raw: "510x295 (RR7000)", arr: 2, room: "taeseong", order: 2 },
            "ê¸°ë³¸(ì¢Œ)": { raw: "510x295 (RR7000)", arr: 2, room: "taeseong", order: 3 },
            "ê¸°ë³¸(ìš°)": { raw: "510x295 (RR7000)", arr: 2, room: "taeseong", order: 4 },
            "6491": { raw: "450x120 (6491)", arr: 4, room: "taeseong", order: 5 },
            "6405": { raw: "470x130 (6405)", arr: 2, room: "taeseong", order: 6 },
            "6406": { raw: "470x130 (6406)", arr: 2, room: "taeseong", order: 7 }
        };
        const batch = writeBatch(db);
        for(const k in defaults) batch.set(doc(db, "mappings", k), defaults[k]);
        await batch.commit();
        alert("ê¸°ë³¸ ê·œì¹™(ìˆœì„œ í¬í•¨) ì´ˆê¸°í™”ë¨.");
    }

    window.resetRules = async () => { if(confirm("ì´ˆê¸°í™” í• ê¹Œìš”?")) { const batch = writeBatch(db); Object.keys(mappings).forEach(k => batch.delete(doc(db, "mappings", k))); await batch.commit(); await seedMappings(); } };

    window.addMapping = async () => {
        const key = document.getElementById('mapKey').value.trim();
        let raw = document.getElementById('mapRaw').value;
        if (raw === 'custom') raw = document.getElementById('mapRawCustom').value.trim();
        const arr = parseInt(document.getElementById('mapArr').value);
        const room = document.getElementById('mapRoom').value;
        const order = parseInt(document.getElementById('mapOrder').value) || 99; // ìˆœì„œ ì €ì¥
        if(!key || !raw || !arr) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
        await setDoc(doc(db, "mappings", key), { raw, arr, room, order });
        document.getElementById('mapKey').value=''; 
        document.getElementById('mapRaw').value = '450x237 (6855)';
        document.getElementById('mapRawCustom').classList.add('hidden');
    };
    window.deleteMapping = async (id) => await deleteDoc(doc(db, "mappings", id));
    window.updateMappingArr = async (id, val) => await updateDoc(doc(db, "mappings", id), { arr: parseInt(val) });

    // --- ë Œë”ë§ (ìˆœì„œ ë°˜ì˜) ---
    function renderMappings() { 
        const tbody = document.getElementById('mapListBody'); tbody.innerHTML = ''; 
        // 1. ë°©(Room)ë³„ë¡œ ì •ë ¬ -> 2. ìˆœì„œ(Order)ë³„ë¡œ ì •ë ¬
        const sortedKeys = Object.keys(mappings).sort((a, b) => {
            const mA = mappings[a]; const mB = mappings[b];
            if (mA.room !== mB.room) return mA.room === 'hansung' ? -1 : 1;
            return (mA.order || 99) - (mB.order || 99);
        });
        
        sortedKeys.forEach(k => { 
            const m = mappings[k]; 
            const badge = m.room === 'hansung' ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">í•œì„±</span>' : '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">íƒœì„±</span>';
            tbody.innerHTML += `<tr><td class="p-2 border-b text-center">${badge}</td><td class="p-2 border-b text-center text-gray-500 font-bold">${m.order||'-'}</td><td class="p-2 border-b font-bold">${k}</td><td class="p-2 border-b text-xs text-gray-500">${m.raw}</td><td class="p-2 border-b text-center"><input type="number" value="${m.arr}" onchange="updateMappingArr('${k}', this.value)" class="w-16 border text-center rounded"></td><td class="p-2 border-b text-center"><button onclick="deleteMapping('${k}')" class="text-red-400 text-xs">X</button></td></tr>`; 
        }); 
    }

    // ì‘ì—…ì¼ì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆœì„œ ë°˜ì˜)
    window.loadLogData = async () => { 
        const date = document.getElementById('logDate').value; if(!date) return; 
        document.getElementById('body-hansung').innerHTML = ''; 
        document.getElementById('body-taeseong').innerHTML = ''; 
        const docRef = doc(db, "work_logs", date); 
        const docSnap = await getDoc(docRef); 
        
        if (docSnap.exists()) { 
            const data = docSnap.data(); 
            // ì €ì¥ëœ ë°ì´í„°ë„ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•´ì„œ ë³´ì—¬ì¤Œ
            // (ì €ì¥ëœ ë°ì´í„°ì—” orderê°’ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ mappings ì°¸ì¡°í•´ì„œ ì •ë ¬)
            const sortLogs = (arr) => arr.sort((a,b) => {
                const ordA = mappings[a.name] ? mappings[a.name].order : 99;
                const ordB = mappings[b.name] ? mappings[b.name].order : 99;
                return ordA - ordB;
            });
            sortLogs(data.hansung).forEach(d => addLogRow('hansung', d)); 
            sortLogs(data.taeseong).forEach(d => addLogRow('taeseong', d)); 
        } else { 
            // ìƒˆ ì¼ì§€ ì‘ì„± ì‹œ (ë§¤í•‘ ìˆœì„œëŒ€ë¡œ ë¡œë“œ)
            const q = query(collection(db, "work_logs"), where("date", "<", date), orderBy("date", "desc"), limit(1)); 
            const prevSnaps = await getDocs(q); 
            let prevData = { hansung: [], taeseong: [] }; 
            if(!prevSnaps.empty) { prevData = prevSnaps.docs[0].data(); } 
            
            // í•œì„± ì•„ì´í…œ (ìˆœì„œ ì •ë ¬)
            const h_items = Object.keys(mappings).filter(k => mappings[k].room === 'hansung')
                                  .sort((a,b) => (mappings[a].order||99) - (mappings[b].order||99));
            h_items.forEach(name => { 
                const last = prevData.hansung.find(d => d.name === name); 
                const startStock = last ? last.curr : 0; 
                addLogRow('hansung', { name: name, prev: startStock }); 
            }); 
            
            // íƒœì„± ì•„ì´í…œ (ìˆœì„œ ì •ë ¬)
            const t_items = Object.keys(mappings).filter(k => mappings[k].room === 'taeseong')
                                  .sort((a,b) => (mappings[a].order||99) - (mappings[b].order||99));
            t_items.forEach(name => { 
                const last = prevData.taeseong.find(d => d.name === name); 
                const startStock = last ? last.curr : 0; 
                addLogRow('taeseong', { name: name, prev: startStock }); 
            }); 
        } 
    };

    // ë Œë”ë§ í•¨ìˆ˜ë“¤ (ë™ì¼)
    function renderOrders() { const tbody = document.getElementById('orderListBody'); tbody.innerHTML = ''; orders.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(o => { let pct = Math.round((o.done / o.goal) * 100); tbody.innerHTML += `<tr><td><input type="date" value="${o.date}" onchange="updateOrder('${o.id}', 'date', this.value)" class="bg-transparent text-sm w-full"></td><td><div class="font-bold text-gray-800">${o.title}</div><div class="text-xs text-gray-500">${o.memo||''}</div></td><td><input type="number" value="${o.goal}" onchange="updateOrder('${o.id}', 'goal', this.value)" class="w-20 text-right border rounded px-1"></td><td><div class="flex justify-between text-xs mb-1"><span>${o.done.toLocaleString()}</span><span class="text-blue-600 font-bold">${pct}%</span></div><div class="progress-bar"><div class="progress-fill ${pct>=100?'bg-green-500':'bg-blue-500'}" style="width:${pct>100?100:pct}%"></div></div></td><td><button onclick="deleteOrder('${o.id}')" class="text-red-400 text-xs">ì‚­ì œ</button></td></tr>`; }); }
    function renderWip() { const list = document.getElementById('wipList'); const sel = document.getElementById('workProductSelect'); const cur = sel.value; list.innerHTML = ''; sel.innerHTML = '<option value="">(ì„¸íŠ¸ ì„ íƒ)</option>'; wip.sort((a,b)=>a.name.localeCompare(b.name)).forEach(x => { list.innerHTML += `<div class="bg-white border p-2 rounded text-sm flex justify-between"><div><b>${x.name}</b> <span class="text-indigo-600">${x.lot}</span> (${x.qty})</div><button onclick="deleteWip('${x.id}')" class="text-red-400 text-xs">X</button></div>`; sel.innerHTML += `<option value="${x.id}">${x.name} [${x.lot}] (${x.qty})</option>`; }); if(wip.find(x=>x.id==cur)) sel.value=cur; }
    function renderRaw() { const tbody = document.getElementById('rawListBody'); tbody.innerHTML = ''; Object.keys(rawMaterials).sort().forEach(k => { tbody.innerHTML += `<tr><td class="font-bold text-gray-700">${k}</td><td class="text-right"><input type="number" value="${rawMaterials[k].qty}" onchange="updateRaw('${k}', this.value)" class="w-20 text-right border px-1"></td><td class="text-center text-xs text-gray-400">ìë™ì—°ë™</td></tr>`; }); }
    function renderReal() { const div = document.getElementById('realListBody'); div.innerHTML = ''; Object.keys(realMaterials).sort().forEach(k => { div.innerHTML += `<div class="bg-purple-50 border border-purple-100 p-3 rounded flex flex-col justify-between"><div class="flex justify-between items-start mb-2"><div class="font-bold text-purple-900">${k}</div><button onclick="deleteReal('${k}')" class="text-xs text-red-400 hover:text-red-600 font-bold border px-2 rounded">X</button></div><div class="flex justify-between items-center"><input type="number" value="${realMaterials[k].qty}" onchange="updateReal('${k}', this.value)" class="w-20 text-right border bg-white rounded px-1"><span class="text-xs text-gray-500">ì¥</span></div></div>`; }); }
    function updateDataList() { const dl = document.getElementById('realSuggestions'); dl.innerHTML = ''; Object.keys(mappings).forEach(k => { dl.innerHTML += `<option value="${k}">`; }); }
    function renderPacking() { const tbody = document.getElementById('packListBody'); tbody.innerHTML = ''; packing.forEach(p => { tbody.innerHTML += `<tr class="border-b"><td class="p-3 font-bold text-gray-700">${p.name}</td><td class="p-3 text-right font-mono text-blue-600 font-bold">${p.qty.toLocaleString()}</td><td class="p-3 text-center"><button onclick="deletePacking('${p.id}')" class="text-red-400 hover:text-red-600 text-sm">ì‚­ì œ</button></td></tr>`; }); if(packing.length === 0) tbody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-gray-400">ì”ì—¬ ì¬ê³  ì—†ìŒ</td></tr>`; }

    const tabs = ['orderTab', 'workTab', 'rawTab', 'realTab', 'logTab', 'packTab'];
    tabs.forEach(t => document.getElementById('btn-'+t).addEventListener('click', ()=>{ tabs.forEach(x => { document.getElementById(x).classList.add('hidden'); document.getElementById('btn-'+x).classList.remove('active'); }); document.getElementById(t).classList.remove('hidden'); document.getElementById('btn-'+t).classList.add('active'); }));
    document.getElementById('rawTypeSelect').addEventListener('change', function() { const input = document.getElementById('rawCustomInput'); if(this.value === 'custom') { input.classList.remove('hidden'); input.focus(); } else { input.classList.add('hidden'); } });
    document.getElementById('mapRaw').addEventListener('change', function() { const input = document.getElementById('mapRawCustom'); if(this.value === 'custom') { input.classList.remove('hidden'); input.focus(); } else { input.classList.add('hidden'); } });

    document.getElementById('btnAddOrder').addEventListener('click', window.addOrder);
    document.getElementById('btnAddWip').addEventListener('click', window.addWip);
    document.getElementById('btnAddRaw').addEventListener('click', window.addRaw);
    document.getElementById('btnAddReal').addEventListener('click', window.addReal);
    document.getElementById('btnDoWork').addEventListener('click', window.doWork);
    document.getElementById('btnAddMap').addEventListener('click', window.addMapping);
    document.getElementById('workProductSelect').addEventListener('change', window.autoMatchInfo);

    document.getElementById('inputDate').valueAsDate = new Date();
    document.getElementById('logDate').valueAsDate = new Date();
    setTimeout(() => window.loadLogData(), 1500); 
</script>
</body>
</html>
