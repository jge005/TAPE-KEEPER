<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - Drag & Drop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif; background-color: #f1f5f9; padding: 20px; }
        .tab-btn { padding: 10px 15px; font-weight: bold; color: #64748b; border-bottom: 3px solid transparent; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { color: #2563eb; border-bottom: 3px solid #2563eb; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { border: 1px solid #cbd5e1; padding: 6px; border-radius: 4px; width: 100%; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th { background: #f1f5f9; color: #334155; padding: 8px; text-align: center; border: 1px solid #e2e8f0; font-weight: 800; }
        td { padding: 0; border: 1px solid #e2e8f0; vertical-align: middle; height: 36px; }
        
        .log-input { width: 100%; height: 100%; border: none; text-align: center; background: transparent; outline: none; }
        .log-input:focus { background: #e0f2fe; }
        .hidden { display: none; }
        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:9999; flex-direction: column;}
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .draggable-row { cursor: move; }
        .draggable-row.dragging { opacity: 0.5; background: #fef3c7; }
        .drag-handle { cursor: grab; color: #9ca3af; font-size: 18px; }
        .drag-handle:hover { color: #4b5563; }
    </style>
</head>
<body class="max-w-[1600px] mx-auto">

    <div id="loading">
        <div class="text-3xl font-bold text-blue-600 mb-2">TAPE KEEPER</div>
        <div class="text-sm text-gray-500">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-2">
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">TAPE KEEPER</h1>
            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold shadow-sm">â— ì˜¨ë¼ì¸</span>
        </div>
        <div class="flex space-x-1 bg-white px-2 rounded-lg shadow-sm overflow-x-auto w-full md:w-auto">
            <button id="btn-orderTab" class="tab-btn active">1. ë°œì£¼ ê´€ë¦¬</button>
            <button id="btn-workTab" class="tab-btn">2. ì„¸íŠ¸ ì‘ì—…</button>
            <button id="btn-rawTab" class="tab-btn text-pink-600">3. ì›ë‹¨ ìì¬</button>
            <button id="btn-realTab" class="tab-btn text-indigo-600">4. ì‹¤ë¬´/ì„¤ì •</button>
            <button id="btn-logTab" class="tab-btn text-blue-700 bg-blue-50">5. ì‘ì—…ì¼ì§€</button>
            <button id="btn-packTab" class="tab-btn text-amber-600 bg-amber-50">6. í¬ì¥ì‹¤ ì¬ê³ </button>
        </div>
    </div>

    <div id="orderTab">
        <div class="card border-t-4 border-blue-500">
            <h2 class="text-lg font-bold mb-4 text-blue-900">ğŸ“ ë°œì£¼ ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div><label class="text-xs text-gray-500">ë‚©ê¸°ì¼</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">ë°œì£¼ëª…</label><input type="text" id="inputTitle" placeholder="ì˜ˆ: 7125Y 2000ê°œ"></div>
                <div><label class="text-xs text-gray-500 font-bold">ì´ ëª©í‘œ ìˆ˜ëŸ‰</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500 text-blue-600 font-bold">í¬ì¥ì‹¤ ì¬ê³  (ì°¨ê°)</label><input type="number" id="inputPacked" placeholder="0" class="border-blue-300 bg-blue-50"></div>
                <button id="btnAddOrder" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg h-[34px]">ì¶”ê°€</button>
            </div>
        </div>
        <div class="card">
            <h2 class="text-lg font-bold mb-4">ğŸ“‹ ë°œì£¼ í˜„í™©</h2>
            <div class="overflow-x-auto"><table><thead><tr><th style="width:100px;">ë‚©ê¸°</th><th>ë°œì£¼ëª…</th><th style="width:80px;">ì´ëª©í‘œ</th><th style="width:80px;">í¬ì¥ì¬ê³ </th><th style="width:80px; background:#e0f2fe;">ì‹¤ëª©í‘œ</th><th style="width:120px;">ì§„í–‰ë¥ </th><th style="width:50px;">ê´€ë¦¬</th></tr></thead><tbody id="orderListBody"></tbody></table></div>
        </div>
    </div>

    <div id="workTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-yellow-500">
                <h2 class="text-lg font-bold mb-4 text-yellow-900">ğŸ§® ì‘ì—… ì¤€ë¹„ ê³„ì‚°ê¸°</h2>
                <div class="space-y-3 bg-yellow-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">ì˜¤ëŠ˜ ì–¼ë§ˆë‚˜ ì°ì„ì§€ ì…ë ¥í•˜ë©´ í•„ìš”í•œ í…Œì´í”„ ì¥ìˆ˜ë¥¼ ì•Œë ¤ì¤„ê²Œ.</p>
                    <div class="flex gap-2"><select id="calcProduct" class="flex-1 bg-white border border-yellow-300"></select><input type="number" id="calcTarget" placeholder="ëª©í‘œëŸ‰(EA)" class="w-24 bg-white border border-yellow-300 text-center"></div>
                    <div id="calcResult" class="text-center font-bold text-yellow-800 text-lg mt-2">- ì¥ ì¤€ë¹„í•˜ì„¸ìš” -</div>
                </div>
            </div>
            <div class="card border-t-4 border-indigo-500">
                <h2 class="text-lg font-bold mb-4 text-indigo-900">ğŸ“¦ ì„¸íŠ¸(LOT) ë“±ë¡</h2>
                <div class="flex gap-2 mb-2"><input type="text" id="wipName" placeholder="ì œí’ˆëª…" class="flex-1"><input type="text" id="wipLot" placeholder="ì„¸íŠ¸ëª…" class="flex-1"><input type="number" id="wipQty" placeholder="ìˆ˜ëŸ‰" class="w-20"></div>
                <button id="btnAddWip" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">ì„¸íŠ¸ ë“±ë¡</button>
                <div class="mt-4 max-h-40 overflow-y-auto space-y-1" id="wipList"></div>
            </div>
            <div class="card border-t-4 border-green-500 lg:col-span-2">
                <h2 class="text-lg font-bold mb-4 text-green-900">ğŸš€ ì‘ì—… ì‹¤í–‰</h2>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full"><label class="text-xs text-gray-500 font-bold">ì‘ì—…í•  ì„¸íŠ¸</label><select id="workProductSelect" class="bg-gray-50 border-2 border-green-200 p-2 rounded w-full"></select></div>
                    <div class="w-full md:w-32"><label class="text-xs text-gray-500 font-bold">ì‘ì—… ìˆ˜ëŸ‰ (EA)</label><input type="number" id="workAmount" placeholder="0" class="border-2 border-green-200 focus:border-green-500 p-2 rounded w-full"></div>
                    <button id="btnDoWork" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md h-[42px]">ì‘ì—… ì™„ë£Œ</button>
                </div>
                <div class="mt-2 bg-gray-50 p-2 rounded text-xs text-gray-600" id="predictionBox">ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
                <div id="workResultMsg" class="mt-2 p-2 bg-green-100 text-green-800 text-sm font-bold rounded text-center hidden"></div>
            </div>
        </div>
    </div>

    <div id="rawTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-3 border-t-4 border-red-500 bg-red-50">
                <h2 class="text-lg font-bold mb-2 text-red-900">ğŸ“¡ ìì¬ ì†Œìš”ëŸ‰ ì˜ˆì¸¡</h2>
                <div id="forecastReport" class="text-sm space-y-2"><div class="text-gray-500">ë°ì´í„° ë¶„ì„ ì¤‘...</div></div>
            </div>
            <div class="card lg:col-span-1 border-t-4 border-pink-500">
                <h2 class="text-lg font-bold mb-4 text-pink-900">ğŸ“¥ ì›ë‹¨ ì…ê³ </h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500">ê·œê²© ì„ íƒ</label>
                        <select id="rawTypeSelect" class="bg-white border-pink-200 h-[38px]"></select>
                        <input type="text" id="rawCustomInput" class="mt-2 hidden bg-pink-50 border-pink-200 h-[38px]" placeholder="ê·œê²© ì§ì ‘ ì…ë ¥ (ì˜ˆ: 300x300)">
                    </div>
                    <div><label class="text-xs text-gray-500">ì…ê³  ìˆ˜ëŸ‰ (ì¥)</label><input type="number" id="rawQtyInput" placeholder="0"></div>
                    <button id="btnAddRaw" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 rounded-lg">ì›ë‹¨ ì¶”ê°€</button>
                </div>
            </div>
            <div class="card lg:col-span-2">
                <h2 class="text-lg font-bold mb-4">ğŸ“Š ì›ë‹¨ ì¬ê³  í˜„í™©</h2>
                <div class="overflow-x-auto"><table><thead><tr><th>ê·œê²© (ì½”ë“œ)</th><th class="text-right">ì¬ê³  (ì¥)</th><th class="text-center">ìƒíƒœ</th></tr></thead><tbody id="rawListBody"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="realTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-1 border-t-4 border-purple-500">
                <h2 class="text-lg font-bold mb-4 text-purple-900">âœ‚ï¸ ì‹¤ë¬´(ì»·íŒ…) ì…ê³ </h2>
                <div class="space-y-4">
                    <div><label class="text-xs text-gray-500">í’ˆëª©ëª…</label><input type="text" id="realNameInput" placeholder="ì˜ˆ: ê¹€ì¹˜(ìš°)" list="realSuggestions"><datalist id="realSuggestions"></datalist></div>
                    <div><label class="text-xs text-gray-500">ì…ê³  ìˆ˜ëŸ‰ (ì¥)</label><input type="number" id="realQtyInput" placeholder="0"></div>
                    <button id="btnAddReal" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded-lg">ì‹¤ë¬´ ì…ê³  (ì›ë‹¨ ì°¨ê°)</button>
                </div>
            </div>
            <div class="card lg:col-span-2">
                <h2 class="text-lg font-bold mb-4">ğŸ§º ì‹¤ë¬´ ì¬ê³  í˜„í™©</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="realListBody"></div>
            </div>
        </div>
        <div class="card border-t-4 border-gray-600 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">âš™ï¸ ë§¤í•‘/ê·œê²©/ìˆœì„œ ì„¤ì •</h2>
                <button onclick="resetRules()" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200">ğŸ”„ ê¸°ë³¸ ê·œì¹™ìœ¼ë¡œ ì´ˆê¸°í™”</button>
            </div>
            <div class="p-3 bg-blue-50 text-blue-800 text-sm rounded mb-4">
                ğŸ’¡ <b>íŒ:</b> ì•„ë˜ ëª©ë¡ì—ì„œ <b class="text-xl">â‰¡</b> ëª¨ì–‘ì„ ë§ˆìš°ìŠ¤ë¡œ ì¡ê³  <b>ìœ„ì•„ë˜ë¡œ ë“œë˜ê·¸</b>í•˜ë©´ ìˆœì„œê°€ ë°”ë€ë‹ˆë‹¤!
            </div>
            <div class="flex flex-col md:flex-row gap-2 mb-4 p-4 bg-gray-50 rounded">
                <select id="mapRoom" class="w-24 bg-white border border-gray-300 rounded px-2 font-bold text-gray-700"><option value="hansung">í•œì„±</option><option value="taeseong">íƒœì„±</option></select>
                <input type="text" id="mapKey" placeholder="ì‹¤ë¬´ ì´ë¦„" class="flex-1">
                <div class="flex-1">
                    <select id="mapRaw" class="w-full bg-white h-10 border rounded px-2"></select>
                    <input type="text" id="mapRawCustom" class="hidden w-full mt-1 border rounded px-2 h-10" placeholder="ì—°ê²°í•  ì›ë‹¨ ì´ë¦„">
                </div>
                <input type="number" id="mapArr" placeholder="ë°°ì—´" class="w-20 h-10 border rounded px-2 text-center" value="1">
                <button id="btnAddMap" class="bg-gray-700 text-white px-4 py-2 rounded font-bold h-10">ì¶”ê°€</button>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="p-2 text-center w-10">â‰¡</th><th class="p-2 text-center">ìœ„ì¹˜</th><th class="p-2 text-left">ì‹¤ë¬´ ì´ë¦„</th><th class="p-2 text-left">ì—°ê²° ì›ë‹¨</th><th class="p-2 text-center">ë°°ì—´</th><th class="p-2 text-center">ê´€ë¦¬</th></tr></thead><tbody id="mapListBody"></tbody></table></div>
        </div>
    </div>

    <div id="logTab" class="hidden">
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm border border-blue-100">
            <div class="flex items-center gap-4">
                <label class="font-bold text-gray-700 text-lg">ğŸ“… ì‘ì—…ì¼ì:</label>
                <input type="date" id="logDate" class="border-2 border-blue-300 p-2 rounded-lg shadow-sm text-lg font-bold text-blue-800 cursor-pointer" onchange="loadLogData()">
            </div>
            <div class="flex gap-2">
                <button onclick="loadLogData()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-200">ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="saveLogData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg">ğŸ’¾ ì¼ì§€ ì €ì¥</button>
            </div>
        </div>
        <div class="card border-t-4 border-green-500 mb-8"><h2 class="text-xl font-bold text-green-900 mb-3 flex items-center gap-2"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">ë³¸ê´€</span> í•œì„± ê°€ê³µì‹¤ <button onclick="addLogRow('hansung')" class="ml-auto text-sm border px-2 py-1 rounded">+ í–‰ ì¶”ê°€</button></h2><div class="overflow-x-auto"><table class="w-full border-2 border-green-100"><thead><tr class="bg-green-50 text-green-900"><th style="width:120px">ì œí’ˆëª…</th><th style="width:80px">ì „ì¬ê³ </th><th style="width:80px" class="text-blue-600">ì…ê³ </th><th style="width:80px">ë°œì‹ LOT</th><th style="width:100px">ì¢…ìˆ˜ëŸ‰</th><th style="width:80px">ì‘ì—…ì</th><th style="width:80px">ì†Œìš”ëŸ‰</th><th style="width:80px">ë¶ˆëŸ‰</th><th style="width:80px" class="bg-green-100">í˜„ì¬ê³ </th><th>ë¹„ê³ </th><th style="width:40px">X</th></tr></thead><tbody id="body-hansung"></tbody></table></div></div>
        <div class="card border-t-4 border-blue-500"><h2 class="text-xl font-bold text-blue-900 mb-3 flex items-center gap-2"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm">ë³„ê´€</span> íƒœì„± ê°€ê³µì‹¤ <button onclick="addLogRow('taeseong')" class="ml-auto text-sm border px-2 py-1 rounded">+ í–‰ ì¶”ê°€</button></h2><div class="overflow-x-auto"><table class="w-full border-2 border-blue-100"><thead><tr class="bg-blue-50 text-blue-900"><th style="width:120px">ì œí’ˆëª…</th><th style="width:80px">ì „ì¬ê³ </th><th style="width:80px" class="text-blue-600">ì…ê³ </th><th style="width:80px">ë°œì‹ LOT</th><th style="width:100px">ì¢…ìˆ˜ëŸ‰</th><th style="width:80px">ì‘ì—…ì</th><th style="width:80px">ì†Œìš”ëŸ‰</th><th style="width:80px">ë¶ˆëŸ‰</th><th style="width:80px" class="bg-blue-100">í˜„ì¬ê³ </th><th>ë¹„ê³ </th><th style="width:40px">X</th></tr></thead><tbody id="body-taeseong"></tbody></table></div></div>
    </div>

    <div id="packTab" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card border-t-4 border-amber-500">
                <h2 class="text-lg font-bold mb-4 text-amber-900">ğŸ ì™„ì œí’ˆ(í¬ì¥ì‹¤) ì¬ê³  ë“±ë¡</h2>
                <div class="flex gap-2 mb-4"><div class="flex-1"><label class="text-xs text-gray-500 font-bold">ì œí’ˆëª…</label><input type="text" id="packName" placeholder="ì˜ˆ: 7125Y" list="realSuggestions" class="border-2 border-amber-200"></div><div class="w-32"><label class="text-xs text-gray-500 font-bold">ìˆ˜ëŸ‰(EA)</label><input type="number" id="packQty" placeholder="0" class="border-2 border-amber-200"></div></div>
                <button onclick="addPacking()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow-md">ì¬ê³  ë“±ë¡ ë° ë°œì£¼ ì°¨ê°</button>
            </div>
            <div class="card lg:col-span-2"><h2 class="text-lg font-bold mb-4">ğŸ“¦ í¬ì¥ì‹¤ ì”ì—¬ ì¬ê³  í˜„í™©</h2><div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-100"><th class="text-left p-3">ì œí’ˆëª…</th><th class="text-right p-3">ì”ì—¬ ìˆ˜ëŸ‰ (EA)</th><th class="text-center p-3">ê´€ë¦¬</th></tr></thead><tbody id="packListBody"></tbody></table></div></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, getDoc, setDoc, writeBatch, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAkMFlhE-19SvNS6XeHqTAHM3UTHHLb9Ww",
        authDomain: "tapekeeper-8070e.firebaseapp.com",
        projectId: "tapekeeper-8070e",
        storageBucket: "tapekeeper-8070e.firebasestorage.app",
        messagingSenderId: "267507609999",
        appId: "1:267507609999:web:889761a8792b0fa1a6dbfa",
        measurementId: "G-B68XN789S1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let orders = [], wip = [], rawMaterials = {}, realMaterials = {}, mappings = {}, packing = [];

    // --- ë¦¬ìŠ¤ë„ˆ ---
    onSnapshot(query(collection(db, "orders")), (snap) => { orders = snap.docs.map(d => ({id:d.id, ...d.data()})); renderOrders(); updateForecast(); document.getElementById('loading').style.display='none'; });
    onSnapshot(query(collection(db, "wip")), (snap) => { wip = snap.docs.map(d => ({id:d.id, ...d.data()})); renderWip(); });
    onSnapshot(query(collection(db, "raw_materials")), (snap) => { 
        rawMaterials={}; snap.docs.forEach(d=>{rawMaterials[d.id]=d.data()}); 
        renderRaw(); updateForecast(); updateRawSelect(); // ì›ë‹¨ ì„ íƒë°•ìŠ¤ ê°±ì‹ 
    });
    onSnapshot(query(collection(db, "real_materials")), (snap) => { realMaterials={}; snap.docs.forEach(d=>{realMaterials[d.id]=d.data()}); renderReal(); });
    onSnapshot(query(collection(db, "packing")), (snap) => { packing = snap.docs.map(d => ({id:d.id, ...d.data()})); renderPacking(); });
    onSnapshot(query(collection(db, "mappings")), (snap) => { 
        mappings={}; snap.docs.forEach(d=>{mappings[d.id]=d.data()}); 
        if(Object.keys(mappings).length===0) seedMappings(); else { renderMappings(); updateDataList(); }
    });

    // --- [1~6 íƒ­ ê¸°ëŠ¥] ---
    window.addOrder = async () => { const date = document.getElementById('inputDate').value; const title = document.getElementById('inputTitle').value; const goal = parseInt(document.getElementById('inputGoal').value)||0; const packed = parseInt(document.getElementById('inputPacked').value)||0; if(!date||!title||!goal) return alert("ì…ë ¥ í™•ì¸"); await addDoc(collection(db, "orders"), { date, title, goal, packed, memo: document.getElementById('inputMemo').value, done: 0 }); document.getElementById('inputTitle').value=''; document.getElementById('inputGoal').value=''; document.getElementById('inputPacked').value=''; };
    window.deleteOrder = async(id) => { if(confirm('ì‚­ì œ?')) await deleteDoc(doc(db, "orders", id)); };
    window.updateOrder = async(id, f, v) => await updateDoc(doc(db, "orders", id), {[f]: (f==='goal'||f==='packed')?parseInt(v):v});
    window.addWip = async () => { const name = document.getElementById('wipName').value; const lot = document.getElementById('wipLot').value; const qty = parseInt(document.getElementById('wipQty').value); if(!name||!qty) return alert("ì…ë ¥ í™•ì¸"); await addDoc(collection(db, "wip"), { name, lot, qty }); document.getElementById('wipQty').value=''; };
    window.deleteWip = async(id) => await deleteDoc(doc(db, "wip", id));
    
    // [ì›ë‹¨ ì…ê³ : ì„ íƒë°•ìŠ¤ ë°©ì‹]
    window.addRaw = async () => { 
        let type = document.getElementById('rawTypeSelect').value;
        if(type === 'custom') type = document.getElementById('rawCustomInput').value.trim();
        const qty = parseInt(document.getElementById('rawQtyInput').value); 
        if(!type || !qty) return alert("ê·œê²©ê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”"); 
        
        const ref = doc(db, "raw_materials", type); const snap = await getDoc(ref); 
        const cur = snap.exists() ? snap.data().qty : 0; 
        await setDoc(ref, { qty: cur + qty }); 
        document.getElementById('rawCustomInput').value=''; document.getElementById('rawQtyInput').value=''; 
        // ì„ íƒë°•ìŠ¤ ì´ˆê¸°í™”
        document.getElementById('rawTypeSelect').value = "";
        document.getElementById('rawCustomInput').classList.add('hidden');
    };
    window.updateRaw = async(id, v) => await updateDoc(doc(db, "raw_materials", id), { qty: parseInt(v) });

    window.addReal = async () => { const name = document.getElementById('realNameInput').value.trim(); const qty = parseInt(document.getElementById('realQtyInput').value); if(!name||!qty) return alert("ì…ë ¥ í™•ì¸"); const mapKey = Object.keys(mappings).find(k => name.includes(k)); let rawTarget = mapKey ? mappings[mapKey].raw : (rawMaterials[name] !== undefined ? name : null); if (rawTarget) { const rawRef = doc(db, "raw_materials", rawTarget); const rawSnap = await getDoc(rawRef); const rawCur = rawSnap.exists() ? rawSnap.data().qty : 0; const rawNeeded = qty; if (rawCur < rawNeeded) { if(!confirm(`ì›ë‹¨ [${rawTarget}] ì¬ê³  ë¶€ì¡±! (ë³´ìœ : ${rawCur})\në¬´ì‹œí•˜ê³  ì§„í–‰?`)) return; } await setDoc(rawRef, { qty: Math.max(0, rawCur - rawNeeded) }, { merge: true }); alert(`âœ… ${name} ì…ê³ .\nğŸ“‰ ì›ë‹¨ [${rawTarget}] ${rawNeeded}ì¥ ì°¨ê°.`); } else { alert(`âœ… ${name} ì…ê³ .\n(ë§¤ì¹­ ì›ë‹¨ ì—†ìŒ)`); } const realRef = doc(db, "real_materials", name); const realSnap = await getDoc(realRef); const realCur = realSnap.exists() ? realSnap.data().qty : 0; await setDoc(realRef, { qty: realCur + qty }); document.getElementById('realNameInput').value=''; document.getElementById('realQtyInput').value=''; };
    window.updateReal = async(id, v) => await updateDoc(doc(db, "real_materials", id), { qty: parseInt(v) });
    window.deleteReal = async (id) => { if(!confirm(`'${id}' í•­ëª© ì‚­ì œ ë° ì›ë‹¨ ë°˜í™˜?`)) return; const realRef = doc(db, "real_materials", id); const realSnap = await getDoc(realRef); if (!realSnap.exists()) return; const qtyToRestore = realSnap.data().qty; const mapKey = Object.keys(mappings).find(k => id.includes(k)); let rawTarget = mapKey ? mappings[mapKey].raw : (rawMaterials[id] !== undefined ? id : null); if (rawTarget) { const rawRef = doc(db, "raw_materials", rawTarget); const rawSnap = await getDoc(rawRef); if (rawSnap.exists()) { const currentRaw = rawSnap.data().qty; await updateDoc(rawRef, { qty: currentRaw + qtyToRestore }); alert(`ğŸ”„ ì›ë‹¨ [${rawTarget}]ì— ${qtyToRestore}ì¥ ë°˜í™˜ë¨.`); } } await deleteDoc(realRef); };
    window.doWork = async () => { const sel = document.getElementById('workProductSelect').value; const qty = parseInt(document.getElementById('workAmount').value); if(!sel||!qty) return alert("ì…ë ¥ í™•ì¸"); const set = wip.find(x => x.id == sel); if(set.qty < qty) return alert("ì„¸íŠ¸ ì¬ê³  ë¶€ì¡±"); if(set.qty - qty === 0) await deleteDoc(doc(db, "wip", sel)); else await updateDoc(doc(db, "wip", sel), { qty: set.qty - qty }); let remain = qty; const targets = orders.filter(o => o.title.includes(set.name) && o.done < (o.goal-(o.packed||0))).sort((a,b)=>new Date(a.date)-new Date(b.date)); for(const o of targets) { if(remain <= 0) break; const realGoal = o.goal - (o.packed||0); const fill = Math.min(remain, realGoal - o.done); await updateDoc(doc(db, "orders", o.id), { done: o.done + fill }); remain -= fill; } document.getElementById('workResultMsg').innerText = `ì™„ë£Œ! ${set.name} ${qty}ê°œ ì²˜ë¦¬ë¨.`; document.getElementById('workResultMsg').classList.remove('hidden'); document.getElementById('workAmount').value=''; window.autoMatchInfo(); };
    window.autoMatchInfo = () => { const sel = document.getElementById('workProductSelect').value; const box = document.getElementById('predictionBox'); if(!sel) { box.innerText="ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”"; return; } const set = wip.find(x => x.id == sel); const targets = orders.filter(o => o.title.includes(set.name) && o.done < (o.goal-(o.packed||0))).sort((a,b)=>new Date(a.date)-new Date(b.date)); if(targets.length > 0) box.innerText = `[${targets[0].date} ${targets[0].title}] ë°œì£¼ë¡œ ë°°ë¶„ë©ë‹ˆë‹¤.`; else box.innerText = "ë§¤ì¹­ë˜ëŠ” ë°œì£¼ê°€ ì—†ìŠµë‹ˆë‹¤ (ì¬ê³ ë§Œ ì°¨ê°)"; };
    document.getElementById('calcTarget').addEventListener('input', function() { const key = document.getElementById('calcProduct').value; const target = parseInt(this.value) || 0; const res = document.getElementById('calcResult'); if(!key || target === 0) { res.innerText = "- ì¥ ì¤€ë¹„í•˜ì„¸ìš” -"; return; } const m = mappings[key]; if(m) { const needed = Math.ceil(target / m.arr); res.innerHTML = `ì•½ <span class="text-2xl text-red-600">${needed}</span> ì¥ (${m.raw})`; } else { res.innerText = "ë§¤í•‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."; } });
    function updateForecast() { const report = document.getElementById('forecastReport'); report.innerHTML = ''; let needs = {}; orders.forEach(o => { const remain = Math.max(0, o.goal - (o.packed||0) - o.done); if(remain > 0) { const mapKey = Object.keys(mappings).find(k => o.title.includes(k)); if(mapKey) { const m = mappings[mapKey]; const sheets = Math.ceil(remain / m.arr); needs[m.raw] = (needs[m.raw] || 0) + sheets; } } }); if(Object.keys(needs).length === 0) { report.innerHTML = '<div class="ok-box">í˜„ì¬ ë¶€ì¡±í•œ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } for(const raw in needs) { const required = needs[raw]; const current = rawMaterials[raw] ? rawMaterials[raw].qty : 0; const diff = current - required; if(diff < 0) { report.innerHTML += `<div class="warning-box">âš ï¸ <b>${raw}</b>: ${Math.abs(diff)}ì¥ ë¶€ì¡±! (í•„ìš”: ${required} / ë³´ìœ : ${current}) -> ë°œì£¼ í•„ìš”</div>`; } else { report.innerHTML += `<div class="text-green-600 text-xs pl-2">âœ” ${raw}: ${diff}ì¥ ì—¬ìœ </div>`; } } }
    window.addPacking = async () => { const name = document.getElementById('packName').value.trim(); const qty = parseInt(document.getElementById('packQty').value); if(!name || !qty) return alert("ì…ë ¥ í™•ì¸"); const targets = orders.filter(o => o.title.includes(name) && o.done < o.goal).sort((a,b)=>new Date(a.date)-new Date(b.date)); let remain = qty; for(const o of targets) { if(remain <= 0) break; const needed = o.goal - o.done; const fill = Math.min(remain, needed); await updateDoc(doc(db, "orders", o.id), { done: o.done + fill }); remain -= fill; } if(remain > 0) { const q = query(collection(db, "packing"), where("name", "==", name)); const querySnapshot = await getDocs(q); if(!querySnapshot.empty) { const docId = querySnapshot.docs[0].id; const currentQty = querySnapshot.docs[0].data().qty; await updateDoc(doc(db, "packing", docId), { qty: currentQty + remain }); } else { await addDoc(collection(db, "packing"), { name: name, qty: remain }); } alert(`âœ… ì´ ${qty}ê°œ ì²˜ë¦¬ ì™„ë£Œ.\n- ë°œì£¼ ì°¨ê°: ${qty - remain}ê°œ\n- í¬ì¥ì‹¤ ì”ì—¬ ë³´ê´€: ${remain}ê°œ`); } else { alert(`âœ… ${qty}ê°œ ì „ëŸ‰ ë°œì£¼ ëª©í‘œ ë‹¬ì„±ì— ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`); } document.getElementById('packName').value = ''; document.getElementById('packQty').value = ''; };
    window.deletePacking = async (id) => { if(confirm("ì‚­ì œ?")) await deleteDoc(doc(db, "packing", id)); };

    // --- [ë§¤í•‘ ë° ë“œë˜ê·¸ ì•¤ ë“œë¡­] ---
    async function seedMappings() { const defaults = { "6084": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 1 }, "6934": { raw: "510x195 (6934)", arr: 4, room: "hansung", order: 2 }, "5869": { raw: "410x315 (5869)", arr: 4, room: "hansung", order: 3 }, "4195": { raw: "470x237 (4195)", arr: 4, room: "hansung", order: 5 }, "6855": { raw: "450x237 (6855)", arr: 8, room: "hansung", order: 7 }, "ê¹€ì¹˜(ì¢Œ)": { raw: "510x295 (RR7000)", arr: 2, room: "taeseong", order: 1 }, "6405": { raw: "470x130 (6405)", arr: 2, room: "taeseong", order: 6 } }; const batch = writeBatch(db); for(const k in defaults) batch.set(doc(db, "mappings", k), defaults[k]); await batch.commit(); alert("ê¸°ë³¸ ê·œì¹™ ì´ˆê¸°í™”ë¨."); }
    window.resetRules = async () => { if(confirm("ì´ˆê¸°í™” í• ê¹Œìš”?")) { const batch = writeBatch(db); Object.keys(mappings).forEach(k => batch.delete(doc(db, "mappings", k))); await batch.commit(); await seedMappings(); } };
    window.addMapping = async () => { const key = document.getElementById('mapKey').value.trim(); let raw = document.getElementById('mapRaw').value; if (raw === 'custom') raw = document.getElementById('mapRawCustom').value.trim(); const arr = parseInt(document.getElementById('mapArr').value); const room = document.getElementById('mapRoom').value; if(!key || !raw || !arr) return alert("ì…ë ¥ í™•ì¸"); 
        // ìƒˆ í•­ëª©ì€ ë§¨ ë§ˆì§€ë§‰ ìˆœì„œë¡œ
        const maxOrder = Math.max(0, ...Object.values(mappings).filter(m=>m.room===room).map(m=>m.order||0));
        await setDoc(doc(db, "mappings", key), { raw, arr, room, order: maxOrder + 1 }); 
        document.getElementById('mapKey').value=''; document.getElementById('mapRaw').value = '450x237 (6855)'; document.getElementById('mapRawCustom').classList.add('hidden'); 
    };
    window.deleteMapping = async (id) => await deleteDoc(doc(db, "mappings", id));
    window.updateMappingArr = async (id, val) => await updateDoc(doc(db, "mappings", id), { arr: parseInt(val) });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§
    let draggedItem = null;
    function renderMappings() { 
        const tbody = document.getElementById('mapListBody'); tbody.innerHTML = ''; 
        const sortedKeys = Object.keys(mappings).sort((a, b) => { const mA = mappings[a]; const mB = mappings[b]; if (mA.room !== mB.room) return mA.room === 'hansung' ? -1 : 1; return (mA.order || 99) - (mB.order || 99); });
        
        sortedKeys.forEach(k => { 
            const m = mappings[k]; 
            const badge = m.room === 'hansung' ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">í•œì„±</span>' : '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">íƒœì„±</span>';
            
            const tr = document.createElement('tr');
            tr.className = "draggable-row border-b hover:bg-gray-50";
            tr.draggable = true;
            tr.dataset.id = k;
            tr.innerHTML = `<td class="p-2 text-center text-gray-400 cursor-grab text-xl">â‰¡</td><td class="p-2 text-center">${badge}</td><td class="p-2 font-bold">${k}</td><td class="p-2 text-xs text-gray-500">${m.raw}</td><td class="p-2 text-center"><input type="number" value="${m.arr}" onchange="updateMappingArr('${k}', this.value)" class="w-16 border text-center rounded"></td><td class="p-2 text-center"><button onclick="deleteMapping('${k}')" class="text-red-400 text-xs">X</button></td>`;
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸
            tr.addEventListener('dragstart', function() { draggedItem = this; setTimeout(() => this.classList.add('hidden'), 0); });
            tr.addEventListener('dragend', function() { setTimeout(() => this.classList.remove('hidden'), 0); draggedItem = null; });
            tr.addEventListener('dragover', function(e) { e.preventDefault(); });
            tr.addEventListener('dragenter', function(e) { e.preventDefault(); this.style.backgroundColor = '#f3f4f6'; });
            tr.addEventListener('dragleave', function() { this.style.backgroundColor = ''; });
            tr.addEventListener('drop', async function() {
                this.style.backgroundColor = '';
                if (draggedItem === this) return;
                
                // ê°™ì€ ë°©ë¼ë¦¬ë§Œ ì´ë™ ê°€ëŠ¥
                const srcId = draggedItem.dataset.id;
                const destId = this.dataset.id;
                if(mappings[srcId].room !== mappings[destId].room) return alert("ê°™ì€ ìœ„ì¹˜(í•œì„±/íƒœì„±) ì•ˆì—ì„œë§Œ ì´ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

                // ìˆœì„œ ì¬ê³„ì‚° ë° ì €ì¥
                const room = mappings[srcId].room;
                const keys = sortedKeys.filter(k => mappings[k].room === room);
                const fromIdx = keys.indexOf(srcId);
                const toIdx = keys.indexOf(destId);
                
                keys.splice(fromIdx, 1);
                keys.splice(toIdx, 0, srcId);
                
                // ë°°ì¹˜ ì—…ë°ì´íŠ¸
                const batch = writeBatch(db);
                keys.forEach((key, index) => {
                    batch.update(doc(db, "mappings", key), { order: index + 1 });
                });
                await batch.commit();
            });

            tbody.appendChild(tr);
        }); 
    }

    // --- ì‘ì—…ì¼ì§€ ---
    window.addLogRow = (room, data = {}) => { const tbody = document.getElementById(`body-${room}`); const tr = document.createElement('tr'); const { name='', prev=0, incoming=0, lot='', prod='', worker='', use=0, defect=0, curr=0, memo='' } = data; tr.innerHTML = `<td><input type="text" class="log-input font-bold text-gray-700" value="${name}" placeholder="ì œí’ˆëª…"></td><td><input type="number" class="log-input bg-gray-50" value="${prev}" oninput="calcRow(this)"></td><td><input type="number" class="log-input text-blue-600 font-bold" value="${incoming}" placeholder="0" oninput="calcRow(this)"></td><td><input type="text" class="log-input" value="${lot}"></td><td><input type="text" class="log-input" value="${prod}"></td><td><input type="text" class="log-input" value="${worker}"></td><td><input type="number" class="log-input text-red-600" value="${use}" placeholder="0" oninput="calcRow(this)"></td><td><input type="number" class="log-input text-red-400" value="${defect}" placeholder="0" oninput="calcRow(this)"></td><td class="bg-blue-50 font-bold text-gray-800 text-center align-middle"><span class="curr-val">${curr}</span></td><td><input type="text" class="log-input text-left px-2 text-xs" value="${memo}"></td><td class="text-center"><button onclick="this.closest('tr').remove()" class="text-red-300 hover:text-red-600 font-bold">X</button></td>`; tbody.appendChild(tr); calcRow(tr.querySelector('input')); };
    window.calcRow = (input) => { const tr = input.closest('tr'); const inputs = tr.querySelectorAll('input'); const prev = parseInt(inputs[1].value)||0; const incoming = parseInt(inputs[2].value)||0; const use = parseInt(inputs[6].value)||0; const defect = parseInt(inputs[7].value)||0; const curr = prev + incoming - use - defect; tr.querySelector('.curr-val').innerText = curr; };
    window.saveLogData = async () => { const date = document.getElementById('logDate').value; if(!date) return alert("ë‚ ì§œ ì„ íƒ!"); const getData = (room) => { const rows = document.querySelectorAll(`#body-${room} tr`); return Array.from(rows).map(tr => { const inputs = tr.querySelectorAll('input'); return { name: inputs[0].value, prev: parseInt(inputs[1].value)||0, incoming: parseInt(inputs[2].value)||0, lot: inputs[3].value, prod: inputs[4].value, worker: inputs[5].value, use: parseInt(inputs[6].value)||0, defect: parseInt(inputs[7].value)||0, curr: parseInt(tr.querySelector('.curr-val').innerText)||0, memo: inputs[9].value }; }).filter(d => d.name); }; const logData = { date: date, hansung: getData('hansung'), taeseong: getData('taeseong') }; await setDoc(doc(db, "work_logs", date), logData); alert(`ğŸ“… ${date} ì €ì¥ ì™„ë£Œ!`); };
    window.loadLogData = async () => { const date = document.getElementById('logDate').value; if(!date) return; document.getElementById('body-hansung').innerHTML = ''; document.getElementById('body-taeseong').innerHTML = ''; const docRef = doc(db, "work_logs", date); const docSnap = await getDoc(docRef); if (docSnap.exists()) { const data = docSnap.data(); const sortLogs = (arr) => arr.sort((a,b) => { const ordA = mappings[a.name] ? mappings[a.name].order : 99; const ordB = mappings[b.name] ? mappings[b.name].order : 99; return ordA - ordB; }); sortLogs(data.hansung).forEach(d => addLogRow('hansung', d)); sortLogs(data.taeseong).forEach(d => addLogRow('taeseong', d)); } else { const q = query(collection(db, "work_logs"), where("date", "<", date), orderBy("date", "desc"), limit(1)); const prevSnaps = await getDocs(q); let prevData = { hansung: [], taeseong: [] }; if(!prevSnaps.empty) { prevData = prevSnaps.docs[0].data(); } const h_items = Object.keys(mappings).filter(k => mappings[k].room === 'hansung').sort((a,b) => (mappings[a].order||99) - (mappings[b].order||99)); h_items.forEach(name => { const last = prevData.hansung.find(d => d.name === name); const startStock = last ? last.curr : 0; addLogRow('hansung', { name: name, prev: startStock }); }); const t_items = Object.keys(mappings).filter(k => mappings[k].room === 'taeseong').sort((a,b) => (mappings[a].order||99) - (mappings[b].order||99)); t_items.forEach(name => { const last = prevData.taeseong.find(d => d.name === name); const startStock = last ? last.curr : 0; addLogRow('taeseong', { name: name, prev: startStock }); }); } };

    // --- Helper Functions ---
    function updateRawSelect() { 
        const sel = document.getElementById('rawTypeSelect'); 
        const mapRaw = document.getElementById('mapRaw');
        const sorted = Object.keys(rawMaterials).sort();
        
        let html = '<option value="">(ì„ íƒí•˜ì„¸ìš”)</option>';
        sorted.forEach(k => html += `<option value="${k}">${k}</option>`);
        html += '<option value="custom">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>';
        
        sel.innerHTML = html;
        mapRaw.innerHTML = html; // ë§¤í•‘ ì„¤ì • ìª½ë„ ë™ê¸°í™”
    }
    function updateDataList() { const dl = document.getElementById('realSuggestions'); dl.innerHTML = ''; Object.keys(mappings).forEach(k => { dl.innerHTML += `<option value="${k}">`; }); const calcSel = document.getElementById('calcProduct'); calcSel.innerHTML = '<option value="">(ì œí’ˆ ì„ íƒ)</option>'; Object.keys(mappings).sort().forEach(k => { calcSel.innerHTML += `<option value="${k}">${k}</option>`; }); }

    const tabs = ['orderTab', 'workTab', 'rawTab', 'realTab', 'logTab', 'packTab'];
    tabs.forEach(t => document.getElementById('btn-'+t).addEventListener('click', ()=>{ tabs.forEach(x => { document.getElementById(x).classList.add('hidden'); document.getElementById('btn-'+x).classList.remove('active'); }); document.getElementById(t).classList.remove('hidden'); document.getElementById('btn-'+t).classList.add('active'); }));
    
    // ì›ë‹¨ ì…ë ¥ í† ê¸€
    function toggleRawInput(selectId, inputId) {
        document.getElementById(selectId).addEventListener('change', function() { 
            const input = document.getElementById(inputId); 
            if(this.value === 'custom') { input.classList.remove('hidden'); input.focus(); } else { input.classList.add('hidden'); } 
        });
    }
    toggleRawInput('rawTypeSelect', 'rawCustomInput');
    toggleRawInput('mapRaw', 'mapRawCustom');

    document.getElementById('btnAddOrder').addEventListener('click', window.addOrder);
    document.getElementById('btnAddWip').addEventListener('click', window.addWip);
    document.getElementById('btnAddRaw').addEventListener('click', window.addRaw);
    document.getElementById('btnAddReal').addEventListener('click', window.addReal);
    document.getElementById('btnDoWork').addEventListener('click', window.doWork);
    document.getElementById('btnAddMap').addEventListener('click', window.addMapping);
    document.getElementById('workProductSelect').addEventListener('change', window.autoMatchInfo);
    document.getElementById('inputDate').valueAsDate = new Date();
    document.getElementById('logDate').valueAsDate = new Date();
    setTimeout(() => window.loadLogData(), 1500); 
</script>
</body>
</html>
