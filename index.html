<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPE KEEPER - Step 3: ìë™ ë°°ë¶„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f1f5f9; padding: 20px; }
        .tab-btn { padding: 10px 20px; font-weight: bold; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { border: 1px solid #ccc; padding: 8px; border-radius: 5px; width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8fafc; color: #64748b; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .progress-bar { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }
        .hidden { display: none; }
    </style>
</head>
<body class="max-w-5xl mx-auto">

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-2xl font-bold text-slate-800">TAPE KEEPER <span class="text-sm font-normal text-slate-500">(ìë™ ë°°ë¶„ ëª¨ë“œ)</span></h1>
        <div class="flex space-x-4 bg-white px-4 rounded-lg shadow-sm">
            <button onclick="showTab('orderTab')" id="btn-orderTab" class="tab-btn active">1. ë°œì£¼ ê´€ë¦¬</button>
            <button onclick="showTab('workTab')" id="btn-workTab" class="tab-btn">2. ì‘ì—… ì‹¤í–‰ (ìë™)</button>
        </div>
    </div>

    <div id="orderTab">
        <div class="card">
            <h2 class="text-lg font-bold mb-4">ğŸ“ ë°œì£¼ ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div><label class="text-xs text-gray-500">ë‚©ê¸°ì¼</label><input type="date" id="inputDate"></div>
                <div class="md:col-span-2"><label class="text-xs text-gray-500">ë°œì£¼ëª… (ì œí’ˆëª… í¬í•¨ í•„ìˆ˜! ì˜ˆ: 7125Y)</label><input type="text" id="inputTitle" placeholder="ì˜ˆ: 7125Y 2000ê°œ"></div>
                <div><label class="text-xs text-gray-500">ëª©í‘œ ìˆ˜ëŸ‰</label><input type="number" id="inputGoal" placeholder="0"></div>
                <div><label class="text-xs text-gray-500">ë¹„ê³ </label><input type="text" id="inputMemo" placeholder="íŠ¹ì´ì‚¬í•­"></div>
            </div>
            <button onclick="addOrder()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">ë°œì£¼ ì¶”ê°€</button>
        </div>

        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">ğŸ“‹ ë°œì£¼ í˜„í™© (ë‚ ì§œìˆœ ìë™ ì •ë ¬)</h2>
                <button onclick="resetData()" class="text-xs text-red-500 underline">ì´ˆê¸°í™”</button>
            </div>
            <div class="overflow-x-auto">
                <table>
                    <thead><tr><th style="width:130px;">ë‚ ì§œ</th><th>ë°œì£¼ëª…</th><th style="width:100px;">ëª©í‘œ</th><th style="width:150px;">ì§„í–‰ë¥ </th><th style="width:60px;">ì‚­ì œ</th></tr></thead>
                    <tbody id="orderListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="workTab" class="hidden">
        
        <div class="card border-l-4 border-indigo-500">
            <h2 class="text-lg font-bold mb-4 text-indigo-900">ğŸ“¦ ì‘ì—… ì „ ì œí’ˆ(WIP) ë“±ë¡</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="text-xs text-gray-500">ì œí’ˆëª… (ì˜ˆ: 7125Y)</label>
                    <input type="text" id="wipName" placeholder="ì •í™•í•œ ì œí’ˆëª… ì…ë ¥">
                </div>
                <div>
                    <label class="text-xs text-gray-500">ì¶”ê°€í•  ìˆ˜ëŸ‰ (EA)</label>
                    <input type="number" id="wipQty" placeholder="0">
                </div>
                <button onclick="addWip()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">ì¬ê³  ì¶”ê°€</button>
            </div>
            
            <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                <h3 class="text-sm font-bold text-indigo-800 mb-2">ëŒ€ê¸° ì¤‘ì¸ ì œí’ˆ ëª©ë¡ (WIP)</h3>
                <div id="wipList" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div class="card border-l-4 border-green-500">
            <h2 class="text-lg font-bold mb-4 text-green-900">ğŸš€ í…Œì´í”„ ì‘ì—… ì‹¤í–‰</h2>
            <p class="text-sm text-gray-600 mb-4">â€» ì œí’ˆëª…ë§Œ ì„ íƒí•˜ë©´, ë‚ ì§œê°€ ê¸‰í•œ ë°œì£¼ë¶€í„° ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 font-bold">1. ì–´ë–¤ ì œí’ˆì„ ì‘ì—…í–ˆë‚˜ìš”?</label>
                        <select id="workProductSelect" onchange="autoMatchInfo()" class="bg-gray-50 border-2 border-green-200 p-2 rounded w-full"></select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-bold">2. ëª‡ ê°œ ë§Œë“¤ì—ˆë‚˜ìš”? (EA)</label>
                        <input type="number" id="workAmount" placeholder="ì˜ˆ: 3500" class="border-2 border-green-200 focus:border-green-500 p-2 rounded w-full">
                    </div>
                </div>

                <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    <div>
                        <label class="text-xs text-gray-500 font-bold">í…Œì´í”„ ì •ë³´ (ìë™)</label>
                        <input type="text" id="workTapeInfo" disabled class="bg-transparent font-mono text-sm w-full font-bold text-blue-600">
                    </div>
                    <div id="predictionBox" class="text-sm text-gray-600 mt-2">
                        ì œí’ˆì„ ì„ íƒí•˜ë©´ ì–´ë””ë¡œ ë“¤ì–´ê°ˆì§€ ë¯¸ë¦¬ ì•Œë ¤ì¤„ê²Œ.
                    </div>
                </div>
            </div>

            <button onclick="doWork()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">
                ì‘ì—… ì™„ë£Œ (ìë™ ë°°ë¶„)
            </button>
            <div id="workResultMsg" class="mt-4 p-3 bg-green-50 text-green-800 text-sm font-bold rounded text-center hidden"></div>
        </div>
    </div>

<script>
    // --- ë°ì´í„° ê´€ë¦¬ ---
    let orders = JSON.parse(localStorage.getItem('TK_ORDERS')) || [];
    let wip = JSON.parse(localStorage.getItem('TK_WIP')) || {};
    
    // í…Œì´í”„ ë§¤í•‘ ê·œì¹™
    const MAPPING = {
        "7125": { tape: "6855", arr: 8, size: "450x237" },
        "6855": { tape: "6855", arr: 8, size: "450x237" },
        "6405": { tape: "6405", arr: 2, size: "470x130" },
        "6907": { tape: "RR7000", arr: 2, size: "510x295" },
        "6908": { tape: "RR7000", arr: 2, size: "510x295" },
        "5869": { tape: "5869", arr: 4, size: "410x315" },
        "6491": { tape: "6491", arr: 4, size: "450x120" },
        "4195": { tape: "4195", arr: 4, size: "470x237" },
        "4221": { tape: "4221", arr: 4, size: "195x385" },
        "7011": { tape: "7011", arr: 1, size: "550x315" },
        "6934": { tape: "6934", arr: 4, size: "510x195" },
        "24001W": { tape: "6406", arr: 2, size: "470x130" },
        "2254D": { tape: "6491", arr: 4, size: "450x120" }
    };

    function saveData() {
        localStorage.setItem('TK_ORDERS', JSON.stringify(orders));
        localStorage.setItem('TK_WIP', JSON.stringify(wip));
        render();
    }

    function showTab(tabId) {
        document.getElementById('orderTab').classList.add('hidden');
        document.getElementById('workTab').classList.add('hidden');
        document.getElementById(tabId).classList.remove('hidden');
        
        document.getElementById('btn-orderTab').classList.remove('active');
        document.getElementById('btn-workTab').classList.remove('active');
        document.getElementById('btn-' + tabId).classList.add('active');
        
        // íƒ­ ì „í™˜ ì‹œ ì‘ì—…ì™„ë£Œ ë©”ì‹œì§€ ìˆ¨ê¹€
        document.getElementById('workResultMsg').classList.add('hidden');
    }

    // --- ê¸°ëŠ¥ 1: ë°œì£¼ ê´€ë¦¬ ---
    function addOrder() {
        const date = document.getElementById('inputDate').value;
        const title = document.getElementById('inputTitle').value;
        const goal = parseInt(document.getElementById('inputGoal').value);
        const memo = document.getElementById('inputMemo').value;

        if (!date || !title || !goal) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        orders.push({ id: Date.now(), date, title, goal, done: 0, memo });
        document.getElementById('inputTitle').value = '';
        document.getElementById('inputGoal').value = '';
        saveData();
    }

    function deleteOrder(id) {
        if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            orders = orders.filter(o => o.id !== id);
            saveData();
        }
    }

    // --- ê¸°ëŠ¥ 2: WIP ê´€ë¦¬ ---
    function addWip() {
        const name = document.getElementById('wipName').value.trim();
        const qty = parseInt(document.getElementById('wipQty').value);
        if (!name || isNaN(qty)) return alert("ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        
        wip[name] = (wip[name] || 0) + qty;
        document.getElementById('wipName').value = '';
        document.getElementById('wipQty').value = '';
        saveData();
    }

    // --- ê¸°ëŠ¥ 3: ìë™ ì‘ì—… ì‹¤í–‰ (í•µì‹¬!) ---
    function getMatchedOrders(prodName) {
        // ì œí’ˆëª…ì´ ë°œì£¼ ì œëª©ì— í¬í•¨ë˜ì–´ ìˆê³ , ì•„ì§ ëœ ëë‚œ ë°œì£¼ë“¤ë§Œ í•„í„°ë§
        // ë‚ ì§œìˆœ(ì˜¤ë¦„ì°¨ìˆœ) ì •ë ¬
        return orders.filter(o => o.title.includes(prodName) && o.done < o.goal)
                     .sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function autoMatchInfo() {
        const prod = document.getElementById('workProductSelect').value;
        const info = document.getElementById('workTapeInfo');
        const box = document.getElementById('predictionBox');
        
        if (!prod) { 
            info.value = ""; 
            box.innerHTML = "ì œí’ˆì„ ì„ íƒí•˜ë©´ ì–´ë””ë¡œ ë“¤ì–´ê°ˆì§€ ë¯¸ë¦¬ ì•Œë ¤ì¤„ê²Œ.";
            return; 
        }

        // í…Œì´í”„ ì •ë³´
        const key = Object.keys(MAPPING).find(k => prod.includes(k));
        if (key) {
            const m = MAPPING[key];
            info.value = `${m.tape} / ${m.size} / ${m.arr}ë°°ì—´`;
            info.dataset.arr = m.arr;
        } else {
            info.value = "ë§¤ì¹­ ì •ë³´ ì—†ìŒ (1ë°°ì—´)";
            info.dataset.arr = 1;
        }

        // ì–´ë””ë¡œ ë“¤ì–´ê°ˆì§€ ë¯¸ë¦¬ë³´ê¸°
        const targets = getMatchedOrders(prod);
        if (targets.length > 0) {
            let msg = `<ul class='list-disc pl-5 text-xs text-blue-700 space-y-1'>`;
            targets.forEach(t => {
                const remain = t.goal - t.done;
                msg += `<li><b>${t.date}</b> (${t.title}): <b>${remain}ê°œ</b> ë” í•„ìš”í•¨</li>`;
            });
            msg += "</ul>";
            box.innerHTML = `ì´ ì œí’ˆì€ ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì±„ì›Œì§ˆê±°ì•¼:<br>${msg}`;
        } else {
            box.innerHTML = `<span class='text-red-500 font-bold'>ì£¼ì˜!</span> "${prod}" ì´ë¦„ì´ ë“¤ì–´ê°„ ë¯¸ì™„ë£Œ ë°œì£¼ê°€ ì—†ì–´.<br>ê·¸ëƒ¥ ì¬ê³ ë§Œ ì°¨ê°ë ê±°ì•¼.`;
        }
    }

    function doWork() {
        const prodName = document.getElementById('workProductSelect').value;
        const workQty = parseInt(document.getElementById('workAmount').value);
        const arr = parseInt(document.getElementById('workTapeInfo').dataset.arr || 1);

        if (!prodName || !workQty) return alert("ì œí’ˆê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");
        if ((wip[prodName] || 0) < workQty) return alert("WIP ì¬ê³  ë¶€ì¡±! ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”.");

        // 1. WIP ì°¨ê°
        wip[prodName] -= workQty;
        if (wip[prodName] === 0) delete wip[prodName];

        // 2. ë°œì£¼ ìë™ ì±„ìš°ê¸° (FIFO)
        let remain = workQty;
        let log = [];
        const targets = getMatchedOrders(prodName);

        targets.forEach(o => {
            if (remain <= 0) return;
            const needed = o.goal - o.done;
            const fill = Math.min(remain, needed); // ë‚¨ì€ ì‘ì—…ëŸ‰ê³¼ í•„ìš”ëŸ‰ ì¤‘ ì‘ì€ ê²ƒ
            
            o.done += fill;
            remain -= fill;
            log.push(`${o.date} ë°œì£¼ì— ${fill}ê°œ`);
        });

        // 3. ê²°ê³¼ í‘œì‹œ
        const tapeUsed = Math.ceil(workQty / arr);
        let msg = `âœ… <b>${prodName} ${workQty}ê°œ</b> ì‘ì—… ì™„ë£Œ!<br>ğŸ“¼ í…Œì´í”„ ì•½ <b>${tapeUsed}ì¥</b> ì†Œëª¨.<br>`;
        
        if (log.length > 0) {
            msg += `<br>ğŸ“‚ <b>ìë™ ë°°ë¶„ ê²°ê³¼:</b><br>` + log.join('<br>');
            if (remain > 0) msg += `<br>(ë‚¨ì€ ${remain}ê°œëŠ” ë°œì£¼ ë§¤ì¹­ ì—†ì´ ì‘ì—…ë¨)`;
        } else {
            msg += `<br>âš ï¸ ë§¤ì¹­ëœ ë°œì£¼ê°€ ì—†ì–´ì„œ ì¬ê³ ë§Œ ì°¨ê°ëì–´.`;
        }

        const resBox = document.getElementById('workResultMsg');
        resBox.innerHTML = msg;
        resBox.classList.remove('hidden');
        document.getElementById('workAmount').value = '';
        
        saveData();
        // ëª©ë¡ ê°±ì‹ ì„ ìœ„í•´ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        autoMatchInfo();
    }

    // --- ë Œë”ë§ ---
    function render() {
        // ë°œì£¼ ëª©ë¡
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '';
        // ë‚ ì§œìˆœ ì •ë ¬
        orders.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        orders.forEach(o => {
            let pct = Math.round((o.done / o.goal) * 100);
            let barColor = pct >= 100 ? 'bg-green-500' : 'bg-blue-500';
            let barWidth = pct > 100 ? 100 : pct;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-sm font-bold text-gray-700">${o.date}</span></td>
                <td><div class="font-bold text-gray-800">${o.title}</div><div class="text-xs text-gray-500">${o.memo}</div></td>
                <td><span class="text-sm">${o.goal.toLocaleString()}</span></td>
                <td>
                    <div class="flex justify-between text-xs mb-1"><span class="font-bold">${o.done.toLocaleString()}</span><span class="text-blue-600 font-bold">${pct}%</span></div>
                    <div class="progress-bar"><div class="progress-fill ${barColor}" style="width: ${barWidth}%"></div></div>
                </td>
                <td><button onclick="deleteOrder(${o.id})" class="text-red-400 hover:text-red-600 text-xs font-bold">ì‚­ì œ</button></td>
            `;
            tbody.appendChild(tr);
        });

        // WIP ëª©ë¡ (ë±ƒì§€)
        const wipList = document.getElementById('wipList');
        const prodSel = document.getElementById('workProductSelect');
        const currentProd = prodSel.value;
        
        wipList.innerHTML = '';
        prodSel.innerHTML = '<option value="">(ì œí’ˆ ì„ íƒ)</option>';
        
        const wipKeys = Object.keys(wip).sort();
        if (wipKeys.length === 0) wipList.innerHTML = '<span class="text-sm text-gray-400">ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</span>';
        
        wipKeys.forEach(name => {
            wipList.innerHTML += `<span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-bold shadow-sm border border-indigo-200">${name}: ${wip[name].toLocaleString()}</span>`;
            prodSel.innerHTML += `<option value="${name}">${name} (ë³´ìœ : ${wip[name]})</option>`;
        });
        prodSel.value = currentProd;
    }

    function resetData() {
        if(confirm("ì´ˆê¸°í™” í• ê¹Œìš”?")) {
            localStorage.clear();
            location.reload();
        }
    }

    document.getElementById('inputDate').valueAsDate = new Date();
    render();
</script>
</body>
</html>
